// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.19/esri/copyright.txt for details.
//>>built
require({cache:{"dojo/debounce":function(){define([],function(){return function(l,n){var k;return function(){k&&clearTimeout(k);var c=this,g=arguments;k=setTimeout(function(){l.apply(c,g)},n)}}})},"dojo/DeferredList":function(){define(["./_base/kernel","./_base/Deferred","./_base/array"],function(l,n,k){l.DeferredList=function(c,g,f,q,e){var d=[];n.call(this);var l=this;0===c.length&&!g&&this.resolve([0,[]]);var C=0;k.forEach(c,function(e,k){function n(b,e){d[k]=[b,e];C++;C===c.length&&l.resolve(d)}
e.then(function(b){g?l.resolve([k,b]):n(!0,b)},function(b){f?l.reject(b):n(!1,b);if(q)return null;throw b;})})};l.DeferredList.prototype=new n;l.DeferredList.prototype.gatherResults=function(c){c=new l.DeferredList(c,!1,!0,!1);c.addCallback(function(c){var f=[];k.forEach(c,function(c){f.push(c[1])});return f});return c};return l.DeferredList})},"dijit/_Widget":function(){define("dojo/aspect dojo/_base/config dojo/_base/connect dojo/_base/declare dojo/has dojo/_base/kernel dojo/_base/lang dojo/query dojo/ready ./registry ./_WidgetBase ./_OnDijitClickMixin ./_FocusMixin dojo/uacss ./hccss".split(" "),
function(l,n,k,c,g,f,q,e,d,I,C,u,w){function s(){}function b(b){return function(d,e,c,g){return d&&"string"==typeof e&&d[e]==s?d.on(e.substring(2).toLowerCase(),q.hitch(c,g)):b.apply(k,arguments)}}l.around(k,"connect",b);f.connect&&l.around(f,"connect",b);l=c("dijit._Widget",[C,u,w],{onClick:s,onDblClick:s,onKeyDown:s,onKeyPress:s,onKeyUp:s,onMouseDown:s,onMouseMove:s,onMouseOut:s,onMouseOver:s,onMouseLeave:s,onMouseEnter:s,onMouseUp:s,constructor:function(b){this._toConnect={};for(var d in b)this[d]===
s&&(this._toConnect[d.replace(/^on/,"").toLowerCase()]=b[d],delete b[d])},postCreate:function(){this.inherited(arguments);for(var b in this._toConnect)this.on(b,this._toConnect[b]);delete this._toConnect},on:function(b,d){return this[this._onMap(b)]===s?k.connect(this.domNode,b.toLowerCase(),this,d):this.inherited(arguments)},_setFocusedAttr:function(b){this._focused=b;this._set("focused",b)},setAttribute:function(b,d){f.deprecated(this.declaredClass+"::setAttribute(attr, value) is deprecated. Use set() instead.",
"","2.0");this.set(b,d)},attr:function(b,d){return 2<=arguments.length||"object"===typeof b?this.set.apply(this,arguments):this.get(b)},getDescendants:function(){f.deprecated(this.declaredClass+"::getDescendants() is deprecated. Use getChildren() instead.","","2.0");return this.containerNode?e("[widgetId]",this.containerNode).map(I.byNode):[]},_onShow:function(){this.onShow()},onShow:function(){},onHide:function(){},onClose:function(){return!0}});g("dijit-legacy-requires")&&d(0,function(){require(["dijit/_base"])});
return l})},"dijit/_WidgetBase":function(){define("require dojo/_base/array dojo/aspect dojo/_base/config dojo/_base/connect dojo/_base/declare dojo/dom dojo/dom-attr dojo/dom-class dojo/dom-construct dojo/dom-geometry dojo/dom-style dojo/has dojo/_base/kernel dojo/_base/lang dojo/on dojo/ready dojo/Stateful dojo/topic dojo/_base/window ./Destroyable dojo/has!dojo-bidi?./_BidiMixin ./registry".split(" "),function(l,n,k,c,g,f,q,e,d,I,C,u,w,s,b,v,F,r,x,A,y,U,E){function K(b){return function(d){e[d?
"set":"remove"](this.domNode,b,d);this._set(b,d)}}w.add("dijit-legacy-requires",!s.isAsync);w.add("dojo-bidi",!1);w("dijit-legacy-requires")&&F(0,function(){l(["dijit/_base/manager"])});var H={};c=f("dijit._WidgetBase",[r,y],{id:"",_setIdAttr:"domNode",lang:"",_setLangAttr:K("lang"),dir:"",_setDirAttr:K("dir"),"class":"",_setClassAttr:{node:"domNode",type:"class"},_setTypeAttr:null,style:"",title:"",tooltip:"",baseClass:"",srcNodeRef:null,domNode:null,containerNode:null,ownerDocument:null,_setOwnerDocumentAttr:function(b){this._set("ownerDocument",
b)},attributeMap:{},_blankGif:c.blankGif||l.toUrl("dojo/resources/blank.gif"),textDir:"",_introspect:function(){var b=this.constructor;if(!b._setterAttrs){var d=b.prototype,e=b._setterAttrs=[],b=b._onMap={},c;for(c in d.attributeMap)e.push(c);for(c in d)/^on/.test(c)&&(b[c.substring(2).toLowerCase()]=c),/^_set[A-Z](.*)Attr$/.test(c)&&(c=c.charAt(4).toLowerCase()+c.substr(5,c.length-9),(!d.attributeMap||!(c in d.attributeMap))&&e.push(c))}},postscript:function(b,d){this.create(b,d)},create:function(d,
c){this._introspect();this.srcNodeRef=q.byId(c);this._connects=[];this._supportingWidgets=[];this.srcNodeRef&&(this.srcNodeRef.id&&"string"==typeof this.srcNodeRef.id)&&(this.id=this.srcNodeRef.id);d&&(this.params=d,b.mixin(this,d));this.postMixInProperties();this.id||(this.id=E.getUniqueId(this.declaredClass.replace(/\./g,"_")),this.params&&delete this.params.id);this.ownerDocument=this.ownerDocument||(this.srcNodeRef?this.srcNodeRef.ownerDocument:document);this.ownerDocumentBody=A.body(this.ownerDocument);
E.add(this);this.buildRendering();var e;if(this.domNode){this._applyAttributes();var r=this.srcNodeRef;r&&(r.parentNode&&this.domNode!==r)&&(r.parentNode.replaceChild(this.domNode,r),e=!0);this.domNode.setAttribute("widgetId",this.id)}this.postCreate();e&&delete this.srcNodeRef;this._created=!0},_applyAttributes:function(){var b={},d;for(d in this.params||{})b[d]=this._get(d);n.forEach(this.constructor._setterAttrs,function(d){if(!(d in b)){var c=this._get(d);c&&this.set(d,c)}},this);for(d in b)this.set(d,
b[d])},postMixInProperties:function(){},buildRendering:function(){this.domNode||(this.domNode=this.srcNodeRef||this.ownerDocument.createElement("div"));if(this.baseClass){var b=this.baseClass.split(" ");this.isLeftToRight()||(b=b.concat(n.map(b,function(b){return b+"Rtl"})));d.add(this.domNode,b)}},postCreate:function(){},startup:function(){this._started||(this._started=!0,n.forEach(this.getChildren(),function(d){!d._started&&(!d._destroyed&&b.isFunction(d.startup))&&(d.startup(),d._started=!0)}))},
destroyRecursive:function(b){this._beingDestroyed=!0;this.destroyDescendants(b);this.destroy(b)},destroy:function(d){function c(b){b.destroyRecursive?b.destroyRecursive(d):b.destroy&&b.destroy(d)}this._beingDestroyed=!0;this.uninitialize();n.forEach(this._connects,b.hitch(this,"disconnect"));n.forEach(this._supportingWidgets,c);this.domNode&&n.forEach(E.findWidgets(this.domNode,this.containerNode),c);this.destroyRendering(d);E.remove(this.id);this._destroyed=!0},destroyRendering:function(b){this.bgIframe&&
(this.bgIframe.destroy(b),delete this.bgIframe);this.domNode&&(b?e.remove(this.domNode,"widgetId"):I.destroy(this.domNode),delete this.domNode);this.srcNodeRef&&(b||I.destroy(this.srcNodeRef),delete this.srcNodeRef)},destroyDescendants:function(b){n.forEach(this.getChildren(),function(d){d.destroyRecursive&&d.destroyRecursive(b)})},uninitialize:function(){return!1},_setStyleAttr:function(d){var c=this.domNode;b.isObject(d)?u.set(c,d):c.style.cssText=c.style.cssText?c.style.cssText+("; "+d):d;this._set("style",
d)},_attrToDom:function(c,r,x){x=3<=arguments.length?x:this.attributeMap[c];n.forEach(b.isArray(x)?x:[x],function(x){var q=this[x.node||x||"domNode"];switch(x.type||"attribute"){case "attribute":b.isFunction(r)&&(r=b.hitch(this,r));x=x.attribute?x.attribute:/^on[A-Z][a-zA-Z]*$/.test(c)?c.toLowerCase():c;q.tagName?e.set(q,x,r):q.set(x,r);break;case "innerText":q.innerHTML="";q.appendChild(this.ownerDocument.createTextNode(r));break;case "innerHTML":q.innerHTML=r;break;case "class":d.replace(q,r,this[c]);
break;case "toggleClass":d.toggle(q,x.className||c,r)}},this)},get:function(b){var d=this._getAttrNames(b);return this[d.g]?this[d.g]():this._get(b)},set:function(d,c){if("object"===typeof d){for(var r in d)this.set(r,d[r]);return this}r=this._getAttrNames(d);var e=this[r.s];if(b.isFunction(e))var x=e.apply(this,Array.prototype.slice.call(arguments,1));else{var e=this.focusNode&&!b.isFunction(this.focusNode)?"focusNode":"domNode",q=this[e]&&this[e].tagName,g;if(g=q)if(!(g=H[q])){g=this[e];var f={},
k;for(k in g)f[k.toLowerCase()]=!0;g=H[q]=f}k=g;r=d in this.attributeMap?this.attributeMap[d]:r.s in this?this[r.s]:k&&r.l in k&&"function"!=typeof c||/^aria-|^data-|^role$/.test(d)?e:null;null!=r&&this._attrToDom(d,c,r);this._set(d,c)}return x||this},_attrPairNames:{},_getAttrNames:function(b){var d=this._attrPairNames;if(d[b])return d[b];var c=b.replace(/^[a-z]|-[a-zA-Z]/g,function(b){return b.charAt(b.length-1).toUpperCase()});return d[b]={n:b+"Node",s:"_set"+c+"Attr",g:"_get"+c+"Attr",l:c.toLowerCase()}},
_set:function(b,d){var c=this[b];this[b]=d;if(this._created&&!(c===d||c!==c&&d!==d))this._watchCallbacks&&this._watchCallbacks(b,c,d),this.emit("attrmodified-"+b,{detail:{prevValue:c,newValue:d}})},_get:function(b){return this[b]},emit:function(b,d,c){d=d||{};void 0===d.bubbles&&(d.bubbles=!0);void 0===d.cancelable&&(d.cancelable=!0);d.detail||(d.detail={});d.detail.widget=this;var r,e=this["on"+b];e&&(r=e.apply(this,c?c:[d]));this._started&&!this._beingDestroyed&&v.emit(this.domNode,b.toLowerCase(),
d);return r},on:function(b,d){var c=this._onMap(b);return c?k.after(this,c,d,!0):this.own(v(this.domNode,b,d))[0]},_onMap:function(b){var d=this.constructor,c=d._onMap;if(!c){var c=d._onMap={},r;for(r in d.prototype)/^on/.test(r)&&(c[r.replace(/^on/,"").toLowerCase()]=r)}return c["string"==typeof b&&b.toLowerCase()]},toString:function(){return"[Widget "+this.declaredClass+", "+(this.id||"NO ID")+"]"},getChildren:function(){return this.containerNode?E.findWidgets(this.containerNode):[]},getParent:function(){return E.getEnclosingWidget(this.domNode.parentNode)},
connect:function(b,d,c){return this.own(g.connect(b,d,this,c))[0]},disconnect:function(b){b.remove()},subscribe:function(d,c){return this.own(x.subscribe(d,b.hitch(this,c)))[0]},unsubscribe:function(b){b.remove()},isLeftToRight:function(){return this.dir?"ltr"==this.dir.toLowerCase():C.isBodyLtr(this.ownerDocument)},isFocusable:function(){return this.focus&&"none"!=u.get(this.domNode,"display")},placeAt:function(b,d){var c=!b.tagName&&E.byId(b);c&&c.addChild&&(!d||"number"===typeof d)?c.addChild(this,
d):(c=c&&"domNode"in c?c.containerNode&&!/after|before|replace/.test(d||"")?c.containerNode:c.domNode:q.byId(b,this.ownerDocument),I.place(this.domNode,c,d),!this._started&&(this.getParent()||{})._started&&this.startup());return this},defer:function(d,c){var r=setTimeout(b.hitch(this,function(){r&&(r=null,this._destroyed||b.hitch(this,d)())}),c||0);return{remove:function(){r&&(clearTimeout(r),r=null);return null}}}});w("dojo-bidi")&&c.extend(U);return c})},"dijit/Destroyable":function(){define(["dojo/_base/array",
"dojo/aspect","dojo/_base/declare"],function(l,n,k){return k("dijit.Destroyable",null,{destroy:function(c){this._destroyed=!0},own:function(){var c=["destroyRecursive","destroy","remove"];l.forEach(arguments,function(g){function f(){e.remove();l.forEach(d,function(d){d.remove()})}var q,e=n.before(this,"destroy",function(d){g[q](d)}),d=[];g.then?(q="cancel",g.then(f,f)):l.forEach(c,function(c){"function"===typeof g[c]&&(q||(q=c),d.push(n.after(g,c,f,!0)))})},this);return arguments}})})},"dijit/_OnDijitClickMixin":function(){define("dojo/on dojo/_base/array dojo/keys dojo/_base/declare dojo/has ./a11yclick".split(" "),
function(l,n,k,c,g,f){l=c("dijit._OnDijitClickMixin",null,{connect:function(c,e,d){return this.inherited(arguments,[c,"ondijitclick"==e?f:e,d])}});l.a11yclick=f;return l})},"dijit/_FocusMixin":function(){define(["./focus","./_WidgetBase","dojo/_base/declare","dojo/_base/lang"],function(l,n,k,c){c.extend(n,{focused:!1,onFocus:function(){},onBlur:function(){},_onFocus:function(){this.onFocus()},_onBlur:function(){this.onBlur()}});return k("dijit._FocusMixin",null,{_focusManager:l})})},"dijit/hccss":function(){define(["dojo/dom-class",
"dojo/hccss","dojo/domReady","dojo/_base/window"],function(l,n,k,c){k(function(){n("highcontrast")&&l.add(c.body(),"dijit_a11y")});return n})},"dojo/hccss":function(){define("require ./_base/config ./dom-class ./dom-style ./has ./domReady ./_base/window".split(" "),function(l,n,k,c,g,f,q){g.add("highcontrast",function(){var e=q.doc.createElement("div");try{e.style.cssText='border: 1px solid; border-color:red green; position: absolute; height: 5px; top: -999px;background-image: url("'+(n.blankGif||
l.toUrl("./resources/blank.gif"))+'");';q.body().appendChild(e);var d=c.getComputedStyle(e),f=d.backgroundImage;return d.borderTopColor==d.borderRightColor||f&&("none"==f||"url(invalid-url:)"==f)}catch(k){return console.warn("hccss: exception detecting high-contrast mode, document is likely hidden: "+k.toString()),!1}finally{8>=g("ie")?e.outerHTML="":q.body().removeChild(e)}});f(function(){g("highcontrast")&&k.add(q.body(),"dj_a11y")});return g})},"dojox/html/entities":function(){define(["dojo/_base/lang"],
function(l){var n=l.getObject("dojox.html.entities",!0),k=function(c,f){var q,e;if(f._encCache&&f._encCache.regexp&&f._encCache.mapper&&f.length==f._encCache.length)q=f._encCache.mapper,e=f._encCache.regexp;else{q={};e=["["];var d;for(d=0;d<f.length;d++)q[f[d][0]]="\x26"+f[d][1]+";",e.push(f[d][0]);e.push("]");e=RegExp(e.join(""),"g");f._encCache={mapper:q,regexp:e,length:f.length}}return c=c.replace(e,function(d){return q[d]})},c=function(c,f){var q,e;if(f._decCache&&f._decCache.regexp&&f._decCache.mapper&&
f.length==f._decCache.length)q=f._decCache.mapper,e=f._decCache.regexp;else{q={};e=["("];var d;for(d=0;d<f.length;d++){var k="\x26"+f[d][1]+";";d&&e.push("|");q[k]=f[d][0];e.push(k)}e.push(")");e=RegExp(e.join(""),"g");f._decCache={mapper:q,regexp:e,length:f.length}}return c=c.replace(e,function(d){return q[d]})};n.html=[["\x26","amp"],['"',"quot"],["\x3c","lt"],["\x3e","gt"],["\u00a0","nbsp"]];n.latin=[["\u00a1","iexcl"],["\u00a2","cent"],["\u00a3","pound"],["\u20ac","euro"],["\u00a4","curren"],
["\u00a5","yen"],["\u00a6","brvbar"],["\u00a7","sect"],["\u00a8","uml"],["\u00a9","copy"],["\u00aa","ordf"],["\u00ab","laquo"],["\u00ac","not"],["\u00ad","shy"],["\u00ae","reg"],["\u00af","macr"],["\u00b0","deg"],["\u00b1","plusmn"],["\u00b2","sup2"],["\u00b3","sup3"],["\u00b4","acute"],["\u00b5","micro"],["\u00b6","para"],["\u00b7","middot"],["\u00b8","cedil"],["\u00b9","sup1"],["\u00ba","ordm"],["\u00bb","raquo"],["\u00bc","frac14"],["\u00bd","frac12"],["\u00be","frac34"],["\u00bf","iquest"],["\u00c0",
"Agrave"],["\u00c1","Aacute"],["\u00c2","Acirc"],["\u00c3","Atilde"],["\u00c4","Auml"],["\u00c5","Aring"],["\u00c6","AElig"],["\u00c7","Ccedil"],["\u00c8","Egrave"],["\u00c9","Eacute"],["\u00ca","Ecirc"],["\u00cb","Euml"],["\u00cc","Igrave"],["\u00cd","Iacute"],["\u00ce","Icirc"],["\u00cf","Iuml"],["\u00d0","ETH"],["\u00d1","Ntilde"],["\u00d2","Ograve"],["\u00d3","Oacute"],["\u00d4","Ocirc"],["\u00d5","Otilde"],["\u00d6","Ouml"],["\u00d7","times"],["\u00d8","Oslash"],["\u00d9","Ugrave"],["\u00da",
"Uacute"],["\u00db","Ucirc"],["\u00dc","Uuml"],["\u00dd","Yacute"],["\u00de","THORN"],["\u00df","szlig"],["\u00e0","agrave"],["\u00e1","aacute"],["\u00e2","acirc"],["\u00e3","atilde"],["\u00e4","auml"],["\u00e5","aring"],["\u00e6","aelig"],["\u00e7","ccedil"],["\u00e8","egrave"],["\u00e9","eacute"],["\u00ea","ecirc"],["\u00eb","euml"],["\u00ec","igrave"],["\u00ed","iacute"],["\u00ee","icirc"],["\u00ef","iuml"],["\u00f0","eth"],["\u00f1","ntilde"],["\u00f2","ograve"],["\u00f3","oacute"],["\u00f4",
"ocirc"],["\u00f5","otilde"],["\u00f6","ouml"],["\u00f7","divide"],["\u00f8","oslash"],["\u00f9","ugrave"],["\u00fa","uacute"],["\u00fb","ucirc"],["\u00fc","uuml"],["\u00fd","yacute"],["\u00fe","thorn"],["\u00ff","yuml"],["\u0192","fnof"],["\u0391","Alpha"],["\u0392","Beta"],["\u0393","Gamma"],["\u0394","Delta"],["\u0395","Epsilon"],["\u0396","Zeta"],["\u0397","Eta"],["\u0398","Theta"],["\u0399","Iota"],["\u039a","Kappa"],["\u039b","Lambda"],["\u039c","Mu"],["\u039d","Nu"],["\u039e","Xi"],["\u039f",
"Omicron"],["\u03a0","Pi"],["\u03a1","Rho"],["\u03a3","Sigma"],["\u03a4","Tau"],["\u03a5","Upsilon"],["\u03a6","Phi"],["\u03a7","Chi"],["\u03a8","Psi"],["\u03a9","Omega"],["\u03b1","alpha"],["\u03b2","beta"],["\u03b3","gamma"],["\u03b4","delta"],["\u03b5","epsilon"],["\u03b6","zeta"],["\u03b7","eta"],["\u03b8","theta"],["\u03b9","iota"],["\u03ba","kappa"],["\u03bb","lambda"],["\u03bc","mu"],["\u03bd","nu"],["\u03be","xi"],["\u03bf","omicron"],["\u03c0","pi"],["\u03c1","rho"],["\u03c2","sigmaf"],["\u03c3",
"sigma"],["\u03c4","tau"],["\u03c5","upsilon"],["\u03c6","phi"],["\u03c7","chi"],["\u03c8","psi"],["\u03c9","omega"],["\u03d1","thetasym"],["\u03d2","upsih"],["\u03d6","piv"],["\u2022","bull"],["\u2026","hellip"],["\u2032","prime"],["\u2033","Prime"],["\u203e","oline"],["\u2044","frasl"],["\u2118","weierp"],["\u2111","image"],["\u211c","real"],["\u2122","trade"],["\u2135","alefsym"],["\u2190","larr"],["\u2191","uarr"],["\u2192","rarr"],["\u2193","darr"],["\u2194","harr"],["\u21b5","crarr"],["\u21d0",
"lArr"],["\u21d1","uArr"],["\u21d2","rArr"],["\u21d3","dArr"],["\u21d4","hArr"],["\u2200","forall"],["\u2202","part"],["\u2203","exist"],["\u2205","empty"],["\u2207","nabla"],["\u2208","isin"],["\u2209","notin"],["\u220b","ni"],["\u220f","prod"],["\u2211","sum"],["\u2212","minus"],["\u2217","lowast"],["\u221a","radic"],["\u221d","prop"],["\u221e","infin"],["\u2220","ang"],["\u2227","and"],["\u2228","or"],["\u2229","cap"],["\u222a","cup"],["\u222b","int"],["\u2234","there4"],["\u223c","sim"],["\u2245",
"cong"],["\u2248","asymp"],["\u2260","ne"],["\u2261","equiv"],["\u2264","le"],["\u2265","ge"],["\u2282","sub"],["\u2283","sup"],["\u2284","nsub"],["\u2286","sube"],["\u2287","supe"],["\u2295","oplus"],["\u2297","otimes"],["\u22a5","perp"],["\u22c5","sdot"],["\u2308","lceil"],["\u2309","rceil"],["\u230a","lfloor"],["\u230b","rfloor"],["\u2329","lang"],["\u232a","rang"],["\u25ca","loz"],["\u2660","spades"],["\u2663","clubs"],["\u2665","hearts"],["\u2666","diams"],["\u0152","OElig"],["\u0153","oelig"],
["\u0160","Scaron"],["\u0161","scaron"],["\u0178","Yuml"],["\u02c6","circ"],["\u02dc","tilde"],["\u2002","ensp"],["\u2003","emsp"],["\u2009","thinsp"],["\u200c","zwnj"],["\u200d","zwj"],["\u200e","lrm"],["\u200f","rlm"],["\u2013","ndash"],["\u2014","mdash"],["\u2018","lsquo"],["\u2019","rsquo"],["\u201a","sbquo"],["\u201c","ldquo"],["\u201d","rdquo"],["\u201e","bdquo"],["\u2020","dagger"],["\u2021","Dagger"],["\u2030","permil"],["\u2039","lsaquo"],["\u203a","rsaquo"]];n.encode=function(c,f){c&&(f?
c=k(c,f):(c=k(c,n.html),c=k(c,n.latin)));return c};n.decode=function(k,f){k&&(f?k=c(k,f):(k=c(k,n.html),k=c(k,n.latin)));return k};return n})},"esri/numberUtils":function(){define(["dojo/has","dojo/number","dojo/i18n!dojo/cldr/nls/number","./kernel"],function(l,n,k,c){var g=function(c,e){return c-e},f={_reNumber:/^-?(\d+)(\.(\d+))?$/i,getDigits:function(c){var e=String(c),d=e.match(f._reNumber);c={integer:0,fractional:0};d&&d[1]?(c.integer=d[1].split("").length,c.fractional=d[3]?d[3].split("").length:
0):-1<e.toLowerCase().indexOf("e")&&(d=e.split("e"),e=d[0],d=d[1],e&&d&&(e=Number(e),d=Number(d),(c=0<d)||(d=Math.abs(d)),e=f.getDigits(e),c?(e.integer+=d,e.fractional=d>e.fractional?0:e.fractional-d):(e.fractional+=d,e.integer=d>e.integer?1:e.integer-d),c=e));return c},getFixedNumbers:function(c,e){var d,k;d=Number(c.toFixed(e));d<c?k=d+1/Math.pow(10,e):(k=d,d-=1/Math.pow(10,e));d=Number(d.toFixed(e));k=Number(k.toFixed(e));return[d,k]},getPctChange:function(c,e,d,k){var f={prev:null,next:null},
g;null!=d&&(g=c-d,d=e-d-g,f.prev=Math.floor(Math.abs(100*d/g)));null!=k&&(g=k-c,d=k-e-g,f.next=Math.floor(Math.abs(100*d/g)));return f},round:function(c,e){var d=c.slice(0),k,l,n,w,s,b,v,F,r,x=!e||null==e.tolerance?2:e.tolerance,A=e&&e.indexes,y=!e||null==e.strictBounds?!1:e.strictBounds;if(A)A.sort(g);else{A=[];for(b=0;b<d.length;b++)A.push(b)}for(b=0;b<A.length;b++)if(r=A[b],k=d[r],l=0===r?null:d[r-1],n=r===d.length-1?null:d[r+1],w=f.getDigits(k),w=w.fractional){v=0;for(F=!1;v<=w&&!F;)s=f.getFixedNumbers(k,
v),s=y&&0===b?s[1]:s[0],F=f.hasMinimalChange(k,s,l,n,x),v++;F&&(d[r]=s)}return d},hasMinimalChange:function(c,e,d,k,g){c=f.getPctChange(c,e,d,k);e=null==c.prev||c.prev<=g;d=null==c.next||c.next<=g;return e&&d||c.prev+c.next<=2*g},_reAllZeros:RegExp("\\"+k.decimal+"0+$","g"),_reSomeZeros:RegExp("(\\d)0*$","g"),format:function(c,e){e=e||{places:20,round:-1};var d=n.format(c,e);d&&(d=d.replace(f._reSomeZeros,"$1").replace(f._reAllZeros,""));return d}};l("extend-esri")&&(c.numberUtils=f);return f})},
"esri/renderers/utils":function(){define("dojo/_base/lang dojo/_base/array dojo/has dojo/date/locale ../kernel ../numberUtils ../Color dojo/i18n!../nls/jsapi dojo/i18n!dojo/cldr/nls/gregorian".split(" "),function(l,n,k,c,g,f,q,e,d){function I(c){return c&&n.map(c,function(c){return new q(c)})}function C(c,b,d){var e="";0===b?e=w.lt+" ":b===d&&(e=w.gt+" ");return e+c}var u={},w={lte:"\x3c\x3d",gte:"\x3e\x3d",lt:"\x3c",gt:"\x3e",pct:"%"},s={millisecond:0,second:1,minute:2,hour:3,day:4,month:5,year:6},
b={millisecond:{dateOptions:{formatLength:"long"},timeOptions:{formatLength:"medium"}},second:{dateOptions:{formatLength:"long"},timeOptions:{formatLength:"medium"}},minute:{dateOptions:{formatLength:"long"},timeOptions:{formatLength:"short"}},hour:{dateOptions:{formatLength:"long"},timeOptions:{formatLength:"short"}},day:{selector:"date",dateOptions:{formatLength:"long"}},month:{selector:"date",dateOptions:{formatLength:"long"}},year:{selector:"date",dateOptions:{selector:"year"}}},v={formatLength:"short",
fullYear:!0},F={formatLength:"short"};l.mixin(u,{timelineDateFormatOptions:{selector:"date",dateOptions:{formatLength:"short",fullYear:!0}},formatDate:function(b,e){var k,f=[];null!=b&&!(b instanceof Date)&&(b=new Date(b));e=e||{};e=l.mixin({},e);var g=e.selector?e.selector.toLowerCase():null;k=!g||-1<g.indexOf("time");g=!g||-1<g.indexOf("date");k&&(e.timeOptions=e.timeOptions||F,e.timeOptions&&(e.timeOptions=l.mixin({},e.timeOptions),e.timeOptions.selector=e.timeOptions.selector||"time",f.push(e.timeOptions)));
g&&(e.dateOptions=e.dateOptions||v,e.dateOptions&&(e.dateOptions=l.mixin({},e.dateOptions),e.dateOptions.selector=e.dateOptions.selector||"date",f.push(e.dateOptions)));f&&f.length?(f=n.map(f,function(d){return c.format(b,d)}),k=1==f.length?f[0]:d["dateTimeFormat-medium"].replace(/\'/g,"").replace(/\{(\d+)\}/g,function(b,c){return f[c]})):k=c.format(b);return k},createColorStops:function(b){var c=b.values,d=b.colors,e=b.labelIndexes,k=b.isDate,g=b.dateFormatOptions;b=[];return b=n.map(c,function(b,
r){var q=null;if(!e||-1<n.indexOf(e,r)){var l;(l=k?u.formatDate(b,g):f.format(b))&&(q=C(l,r,c.length-1))}return{value:b,color:d[r],label:q}})},updateColorStops:function(b){var c=b.stops,d=b.changes,e=b.isDate,k=b.dateFormatOptions,g=[],q,l=n.map(c,function(b){return b.value});n.forEach(d,function(b){g.push(b.index);l[b.index]=b.value});q=f.round(l,{indexes:g});n.forEach(c,function(b,d){b.value=l[d];if(null!=b.label){var r,g=null;(r=e?u.formatDate(q[d],k):f.format(q[d]))&&(g=C(r,d,c.length-1));b.label=
g}})},createClassBreakLabel:function(b){var c=b.minValue,d=b.maxValue,k=b.isFirstBreak?"":w.gt+" ";b="percent-of-total"===b.normalizationType?w.pct:"";c=null==c?"":f.format(c);d=null==d?"":f.format(d);return k+c+b+" "+e.smartMapping.minToMax+" "+d+b},setLabelsForClassBreaks:function(b){var c=b.classBreaks,d=b.classificationMethod,e=b.normalizationType,k=[];c&&c.length&&("standard-deviation"===d?console.log("setLabelsForClassBreaks: cannot set labels for class breaks generated using 'standard-deviation' method."):
b.round?(k.push(c[0].minValue),n.forEach(c,function(b){k.push(b.maxValue)}),k=f.round(k),n.forEach(c,function(b,c){b.label=u.createClassBreakLabel({minValue:0===c?k[0]:k[c],maxValue:k[c+1],isFirstBreak:0===c,normalizationType:e})})):n.forEach(c,function(b,c){b.label=u.createClassBreakLabel({minValue:b.minValue,maxValue:b.maxValue,isFirstBreak:0===c,normalizationType:e})}))},updateClassBreak:function(b){var c=b.classBreaks,d=b.normalizationType,e=b.change,k=e.index,e=e.value,f=-1,g=-1,q=c.length;"standard-deviation"===
b.classificationMethod?console.log("updateClassBreak: cannot update labels for class breaks generated using 'standard-deviation' method."):(0===k?f=k:k===q?g=k-1:(g=k-1,f=k),-1<f&&f<q&&(b=c[f],b.minValue=e,b.label=u.createClassBreakLabel({minValue:b.minValue,maxValue:b.maxValue,isFirstBreak:0===f,normalizationType:d})),-1<g&&g<q&&(b=c[g],b.maxValue=e,b.label=u.createClassBreakLabel({minValue:b.minValue,maxValue:b.maxValue,isFirstBreak:0===g,normalizationType:d})))},calculateDateFormatInterval:function(b){var c,
d,e=b.length,k,f,g,q,l,v,u=Infinity,w;b=n.map(b,function(b){return new Date(b)});for(c=0;c<e-1;c++){k=b[c];g=[];l=Infinity;v="";for(d=c+1;d<e;d++)f=b[d],f=k.getFullYear()!==f.getFullYear()&&"year"||k.getMonth()!==f.getMonth()&&"month"||k.getDate()!==f.getDate()&&"day"||k.getHours()!==f.getHours()&&"hour"||k.getMinutes()!==f.getMinutes()&&"minute"||k.getSeconds()!==f.getSeconds()&&"second"||"millisecond",q=s[f],q<l&&(l=q,v=f),g.push(f);l<u&&(u=l,w=v)}return w},createUniqueValueLabel:function(c){var d=
c.value,e=c.fieldInfo,k=c.domain;c=c.dateFormatInterval;var g=String(d);(k=k&&k.codedValues?k.getName(d):null)?g=k:"number"===typeof d&&(g=e&&"esriFieldTypeDate"===e.type?u.formatDate(d,c&&b[c]):f.format(d));return g},cloneColorInfo:function(b){var c;b&&(c=l.mixin({},b),c.colors=I(c.colors),c.stops=c.stops&&n.map(c.stops,function(b){b=l.mixin({},b);b.color&&(b.color=new q(b.color));return b}),c.legendOptions&&(c.legendOptions=l.mixin({},c.legendOptions)));return c},cloneOpacityInfo:function(b){var c;
if(b){c=l.mixin({},b);if(b=c.opacityValues)c.opacityValues=b.slice(0);if(b=c.stops)c.stops=n.map(b,function(b){return l.mixin({},b)});if(b=c.legendOptions)c.legendOptions=l.mixin({},b)}return c},cloneSizeInfo:function(b){var c;if(b){c=l.mixin({},b);c.stops&&(c.stops=n.map(c.stops,function(b){return l.mixin({},b)}));if((b=c.minSize)&&"object"===typeof b)c.minSize=u.cloneSizeInfo(b);if((b=c.maxSize)&&"object"===typeof b)c.maxSize=u.cloneSizeInfo(b);if(b=c.legendOptions)if(c.legendOptions=l.mixin({},
b),b=b.customValues)c.legendOptions.customValues=b.slice(0)}return c}});k("extend-esri")&&l.setObject("renderer.utils",u,g);return u})},"esri/dijit/_EventedWidget":function(){define("dojo/_base/declare dojo/_base/lang dojo/aspect dojo/on ../Evented dijit/_WidgetBase".split(" "),function(l,n,k,c,g,f){return l([f,g],{_onMap:function(c){var e=this.constructor._onMap,d;if(!e||!e.FINAL)delete this.constructor._onMap,e=this.registerConnectEvents(),e.FINAL=!0;c=c.toLowerCase();e[c]?d=this[e[c].method]:(c=
this._onCamelCase(c),this[c]&&(d=c));return d},on:function(k,e){var d=this._onMap(k),f=k.replace(/\-/g,""),g="on"+f in this.domNode;return d||!g?this.inherited(arguments):this.own(c(this.domNode,f,e))[0]},emit:function(c,e,d){var k,f,g,l=c.toLowerCase(),s=this.constructor._onMap||this.registerConnectEvents();f=this[this._onMap(l)];e=e||{};e.target||(e.target=this);f&&(s&&s[l])&&(this._onObj2Arr(function(){k=Array.prototype.slice.call(arguments)},s[l].argKeys)(e),g=n.mixin({},arguments),g[2]=k,g[0]=
s[l].name.replace(/^on/,""));return this.inherited(g||arguments)}})})},"*noref":1}});
define("esri/dijit/Legend","dojo/_base/kernel dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/connect dojo/_base/json dojo/_base/Color dojo/debounce dojo/has dojo/sniff dojo/Deferred dojo/DeferredList dojo/json dojo/dom dojo/dom-construct dojo/dom-style dojo/dom-class dijit/_Widget dojox/gfx dojox/gfx/matrix dojox/html/entities ../kernel ../config ../request ../lang ../numberUtils ../renderers/utils ../renderers/SimpleRenderer ../renderers/UniqueValueRenderer ../renderers/ClassBreaksRenderer ../renderers/ScaleDependentRenderer ../renderers/DotDensityRenderer ../renderers/TemporalRenderer ../renderers/VectorFieldRenderer ../renderers/HeatmapRenderer ../symbols/PictureFillSymbol ../symbols/SimpleLineSymbol ../symbols/jsonUtils ../renderers/jsonUtils ./_EventedWidget dojo/i18n!../nls/jsapi".split(" "),function(l,
n,k,c,g,f,q,e,d,I,C,u,w,s,b,v,F,r,x,A,y,U,E,K,H,G,R,N,S,O,X,Y,Z,V,$,aa,ba,T,ca,da,W){var J=n([da,r],{declaredClass:"esri.dijit.Legend",widgetsInTemplate:!1,layers:null,alignRight:!1,hoverLabelShowing:!1,dotDensitySwatchSize:26,dotCoverage:75,gradientHeight:30,transparencyRampColor:new q([64,64,64]),defaultText:"Aa",sizeRampLightColor:new q([255,255,255]),sizeRampDarkColor:new q([128,128,128]),layerConnects:[],gradientWidth:34,colorRampBorder:"1px solid",_specialChars:{lt:"\x3c",gt:"\x3e"},_ieTimer:100,
_isRightToLeft:!1,_align:null,_legendAlign:null,constructor:function(a,m){k.mixin(this,W.widgets.legend);this._i18n=W.widgets.legend;a=a||{};a.map?m?(this.map=a.map,this.layerInfos=a.layerInfos,this._respectCurrentMapScale=!1===a.respectCurrentMapScale?!1:!0,this._respectVisibility=!1===a.respectVisibility?!1:!0,this.arrangement=a.arrangement===J.ALIGN_RIGHT?J.ALIGN_RIGHT:J.ALIGN_LEFT,this.arrangement===J.ALIGN_RIGHT&&(this.alignRight=!0),this.autoUpdate=!1===a.autoUpdate?!1:!0,this._surfaceItems=
[],this.hideLayersInLegend={},this.refresh=e(this.refresh,0)):console.error("esri.dijit.Legend: must specify a container for the legend"):console.error("esri.dijit.Legend: unable to find the 'map' property in parameters")},postMixInProperties:function(){this.inherited(arguments);var a=["ar","he"],m,b;for(m=0;m<a.length;m+=1)b=a[m],l.locale&&-1!==l.locale.indexOf(b)&&(-1!==l.locale.indexOf("-")?-1!==l.locale.indexOf(b+"-")&&(this._isRightToLeft=!0):this._isRightToLeft=!0);this._isRightToLeft?(this._align=
this.alignRight?"left":"right",this._legendAlign=this.alignRight?"esriLegendLeft":"esriLegendRight"):(this._align=this.alignRight?"right":"left",this._legendAlign=this.alignRight?"esriLegendRight":"esriLegendLeft")},startup:function(){this.inherited(arguments);this._initialize();9>d("ie")&&(this._repaintItems=k.hitch(this,this._repaintItems),setTimeout(this._repaintItems,this._ieTimer))},destroy:function(){this._deactivate();this._removeHoverHandlers();this.inherited(arguments)},refresh:function(a){if(this.domNode){a?
(this.layerInfos=a,this.layers=[],c.forEach(this.layerInfos,function(a){this._isSupportedLayerType(a.layer)&&(a.title&&(a.layer._titleForLegend=a.title),a.layer._hideDefaultSymbol=!1===a.defaultSymbol?!0:!1,a.hideLayers?(this.hideLayersInLegend[a.layer.id]=a.hideLayers,this._addSubLayersToHide(a)):this.hideLayersInLegend[a.layer.id]=[],a.hoverLabel&&(a.layer._hoverLabel=a.hoverLabel),a.hoverLabels&&(a.layer._hoverLabels=a.hoverLabels),this.layers.push(a.layer))},this)):this.useAllMapLayers&&(this.layers=
this.layerInfos=null);for(a=this.domNode.children.length-1;0<=a;a--)b.destroy(this.domNode.children[a]);this._removeHoverHandlers();this.startup()}},_legendUrl:"http://utility.arcgis.com/sharing/tools/legend",_initialize:function(){this.layerInfos&&(this.layers=[],c.forEach(this.layerInfos,function(a){this._isSupportedLayerType(a.layer)&&(a.title&&(a.layer._titleForLegend=a.title),a.layer._hideDefaultSymbol=!1===a.defaultSymbol?!0:!1,a.hideLayers?(this.hideLayersInLegend[a.layer.id]=a.hideLayers,
this._addSubLayersToHide(a)):this.hideLayersInLegend[a.layer.id]=[],a.hoverLabel&&(a.layer._hoverLabel=a.hoverLabel),a.hoverLabels&&(a.layer._hoverLabels=a.hoverLabels),this.layers.push(a.layer))},this));this.useAllMapLayers=!1;if(!this.layers){this.useAllMapLayers=!0;this.layers=[];var a=[],m=[];c.forEach(this.map.layerIds,function(b){b=this.map.getLayer(b);var d;this._isSupportedLayerType(b)&&(b.arcgisProps&&b.arcgisProps.title&&(b._titleForLegend=b.arcgisProps.title),this.layers.push(b));"esri.layers.KMLLayer"==
b.declaredClass&&(d=b.getLayers(),c.forEach(d,function(m){a.push(m.id)},this));"esri.layers.GeoRSSLayer"==b.declaredClass&&(d=b.getFeatureLayers(),c.forEach(d,function(a){m.push(a.id)},this))},this);c.forEach(this.map.graphicsLayerIds,function(b){var d=this.map.getLayer(b);-1==c.indexOf(a,b)&&-1==c.indexOf(m,b)&&(this._isSupportedLayerType(d)&&d._params&&d._params.drawMode)&&(d.arcgisProps&&d.arcgisProps.title&&(d._titleForLegend=d.arcgisProps.title),this.layers.push(d))},this)}this._createLegend()},
_activate:function(){this._deactivate();this.autoUpdate&&(this._respectCurrentMapScale&&(this._ozeConnect=g.connect(this.map,"onZoomEnd",this,"_refreshLayers")),this.useAllMapLayers&&(this._olaConnect=g.connect(this.map,"onLayerAdd",this,"_updateAllMapLayers"),this._olrConnect=g.connect(this.map,"onLayerRemove",this,"_updateAllMapLayers"),this._olroConnect=g.connect(this.map,"onLayersReordered",this,"_updateAllMapLayers")),c.forEach(this.layers,function(a){var m={};m.ovcConnect=g.connect(a,"onVisibilityChange",
this,"_refreshLayers");m.oocConnect=g.connect(a,"onOpacityChange",this,"_refreshLayers");m.oscConnect=g.connect(a,"onScaleRangeChange",this,"_refreshLayers");"esri.layers.ArcGISDynamicMapServiceLayer"===a.declaredClass&&a.supportsDynamicLayers&&(m.odcConnect=g.connect(a,"_onDynamicLayersChange",k.hitch(this,"_updateDynamicLayers",a)));"esri.layers.ArcGISImageServiceLayer"===a.declaredClass&&(m.oirConnect=g.connect(a,"onRenderingChange",k.partial(this._updateImageServiceLayers,this,a)));"esri.layers.ArcGISImageServiceVectorLayer"===
a.declaredClass&&(m.oivrConnect=g.connect(a,"onRendererChange",k.hitch(this,"_refreshLayers")));this.layerConnects[a.id]=m},this))},_deactivate:function(){this._ozeConnect&&g.disconnect(this._ozeConnect);this._olaConnect&&g.disconnect(this._olaConnect);this._olroConnect&&g.disconnect(this._olroConnect);this._olrConnect&&g.disconnect(this._olrConnect);c.forEach(this.layers,function(a){a=this.layerConnects[a.id]||{};a.ovcConnect&&g.disconnect(a.ovcConnect);a.oocConnect&&g.disconnect(a.oocConnect);a.oscConnect&&
g.disconnect(a.oscConnect);a.odcConnect&&g.disconnect(a.odcConnect);a.oirConnect&&g.disconnect(a.oirConnect);a.oivrConnect&&g.disconnect(a.oivrConnect)},this);this.layerConnects=[]},_updateDynamicLayers:function(a){delete a.legendResponse;this._refreshLayers()},_updateImageServiceLayers:function(a,m){delete m.legendResponse;a._refreshLayers()},_refreshLayers:function(){this.refresh()},_updateAllMapLayers:function(){this.layers=[];c.forEach(this.map.layerIds,function(a){a=this.map.getLayer(a);this._isSupportedLayerType(a)&&
this.layers.push(a)},this);c.forEach(this.map.graphicsLayerIds,function(a){a=this.map.getLayer(a);this._isSupportedLayerType(a)&&(a._params&&a._params.drawMode)&&this.layers.push(a)},this);this.refresh()},_createLegend:function(){var a=!1,m=!1;v.set(this.domNode,"position","relative");b.create("div",{id:this.id+"_msg",className:"esriLegendMsg",innerHTML:this.NLS_creatingLegend+"..."},this.domNode);var d=[];c.forEach(this.layers,function(h){if("esri.layers.KMLLayer"==h.declaredClass||"esri.layers.GeoRSSLayer"==
h.declaredClass){var t;h.loaded?("esri.layers.KMLLayer"==h.declaredClass?t=h.getLayers():"esri.layers.GeoRSSLayer"==h.declaredClass&&(t=h.getFeatureLayers(),this.hideLayersInLegend[h.id]&&(t=c.filter(t,function(a){return-1==c.indexOf(this.hideLayersInLegend[h.id],a.id)},this))),c.forEach(t,function(a){"esri.layers.FeatureLayer"==a.declaredClass&&h._titleForLegend&&(a._titleForLegend=h._titleForLegend+" - ","esriGeometryPoint"==a.geometryType?a._titleForLegend+=this.NLS_points:"esriGeometryPolyline"==
a.geometryType?a._titleForLegend+=this.NLS_lines:"esriGeometryPolygon"==a.geometryType&&(a._titleForLegend+=this.NLS_polygons),d.push(a))},this)):g.connect(h,"onLoad",k.hitch(this,function(){this.refresh(this.layerInfos)}))}else if("esri.layers.WMSLayer"===h.declaredClass)if(h.loaded){if((!this._respectVisibility||this._respectVisibility&&h.visible)&&0<h.layerInfos.length&&c.some(h.layerInfos,function(a){return a.legendURL})){var e=!1;c.forEach(h.layerInfos,function(m){if(m.legendURL&&-1<c.indexOf(h.visibleLayers,
m.name)){e||(b.create("div",{innerHTML:"\x3cspan class\x3d'esriLegendServiceLabel'\x3e"+(h._titleForLegend||h.name||h.id)+"\x3c/span\x3e"},this.domNode),e=!0);var d;m=m.legendURL;if(h.customParameters||h.customLayerParameters){var P=k.clone(h.customParameters||{});k.mixin(P,h.customLayerParameters||{});for(d in P)m+=(-1===m.indexOf("?")?"?":"\x26")+d+"\x3d"+P[d]}b.create("div",{innerHTML:"\x3cimg src\x3d'"+m+"'/\x3e"},this.domNode);a=!0}},this)}}else g.connect(h,"onLoad",k.hitch(this,function(){this.refresh(this.layerInfos)}));
else"esri.layers.WFSLayer"===h.declaredClass&&!h.renderer?(t=b.create("div",{id:this.id+"_"+h.id,"class":"esriLegendService"}),b.create("span",{innerHTML:this._getServiceTitle(h),"class":"esriLegendServiceLabel"},b.create("td",{align:this._align},b.create("tr",{},b.create("tbody",{},b.create("table",{width:"95%"},t))))),b.place(t,this.id,"first"),tableNode=b.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},t),tableBody=b.create("tbody",{},tableNode),"esriGeometryComplex"===
h.geometryType?(this._buildRow_Renderer(h,h._pointSymbol,null,this.NLS_points,null,tableBody),this._buildRow_Renderer(h,h._lineSymbol,null,this.NLS_lines,null,tableBody),this._buildRow_Renderer(h,h._polygonSymbol,null,this.NLS_areas,null,tableBody)):"esriGeometryPoint"===h.geometryType?this._buildRow_Renderer(h,h._pointSymbol,null,"",null,tableBody):"esriGeometryPolyline"===h.geometryType?this._buildRow_Renderer(h,h._lineSymbol,null,"",null,tableBody):"esriGeometryPolygon"===h.geometryType&&this._buildRow_Renderer(h,
h._polygonSymbol,null,"",null,tableBody),m=!0):d.push(h)},this);var t=[];c.forEach(d,function(a){if(a.loaded){if((!this._respectVisibility||this._respectVisibility&&a.visible)&&(a.layerInfos||a.renderer||"esri.layers.ArcGISImageServiceLayer"==a.declaredClass)){var m=b.create("div",{id:this.id+"_"+a.id,style:{display:"none"},"class":"esriLegendService"});b.create("span",{innerHTML:this._getServiceTitle(a),"class":"esriLegendServiceLabel"},b.create("td",{align:this._align},b.create("tr",{},b.create("tbody",
{},b.create("table",{width:"95%"},m)))));b.place(m,this.id,"first");a.legendResponse||a.renderer?this._createLegendForLayer(a):this.isHostedTileService(a)?this._getLayerInfos(a).then(k.hitch(this,function(a){this._createLegendForLayer(a)}),k.hitch(this,function(a){t.push(this._legendRequest(a))})):t.push(this._legendRequest(a))}}else var c=g.connect(a,"onLoad",this,function(a){g.disconnect(c);c=null;this.refresh()})},this);0===t.length&&!a&&!m?(s.byId(this.id+"_msg").innerHTML=this.NLS_noLegend,this._activate()):
(new u(t)).addCallback(k.hitch(this,function(b){!a&&!m?s.byId(this.id+"_msg").innerHTML=this.NLS_noLegend:s.byId(this.id+"_msg").innerHTML="";this._activate()}))},_createLegendForLayer:function(a){if(a.legendResponse||a.renderer||this.isHostedTileService(a)){var m=!1;if(a.legendResponse||this.isHostedTileService(a)){var b=a.dynamicLayerInfos||a.layerInfos;b&&b.length?c.forEach(b,function(b,d){if(!this.hideLayersInLegend[a.id]||-1===c.indexOf(this.hideLayersInLegend[a.id],b.id)){var P=this._buildLegendItems(a,
b,d);m=m||P}},this):"esri.layers.ArcGISImageServiceLayer"==a.declaredClass&&(m=this._buildLegendItems(a,{id:0,name:null,title:a.name,subLayerIds:null,parentLayerId:-1},0))}else a.renderer&&(b=a.url?a.url.substring(a.url.lastIndexOf("/")+1,a.url.length):"fc_"+a.id,m=this._buildLegendItems(a,{id:b,name:null,subLayerIds:null,parentLayerId:-1},0));m&&(v.set(s.byId(this.id+"_"+a.id),"display","block"),v.set(s.byId(this.id+"_msg"),"display","none"))}},_legendRequest:function(a){if(a.loaded)return 10.01<=
a.version?this._legendRequestServer(a):this._legendRequestTools(a);g.connect(a,"onLoad",k.hitch(this,"_legendRequest"))},_legendRequestServer:function(a){var m=a.url,b=m.indexOf("?"),m=-1<b?m.substring(0,b)+"/legend"+m.substring(b):m+"/legend";(b=a._getToken())&&(m+="?token\x3d"+b);var d=k.hitch(this,"_processLegendResponse"),h={f:"json"};a._params.dynamicLayers&&(h.dynamicLayers=w.stringify(this._createDynamicLayers(a)),"[{}]"===h.dynamicLayers&&(h.dynamicLayers="[]"));a._params.bandIds&&(h.bandIds=
a._params.bandIds);a._params.renderingRule?h.renderingRule=a._params.renderingRule:a.rasterFunctionInfos&&0<a.rasterFunctionInfos.length&&c.forEach(a.rasterFunctionInfos,function(a){a&&(a.name&&"none"===a.name.toLowerCase())&&(h.renderingRule=w.stringify({rasterFunction:a.name}))});return K({url:m,content:h,callbackParamName:"callback",load:function(m,b){d(a,m,b)},error:E.defaults.io.errorHandler})},_legendRequestTools:function(a){var m=a.url.toLowerCase().indexOf("/rest/"),m=a.url.substring(0,m)+
a.url.substring(m+5,a.url.length),m=this._legendUrl+"?soapUrl\x3d"+window.escape(m);if(!d("ie")||8<d("ie"))m+="\x26returnbytes\x3dtrue";var b=k.hitch(this,"_processLegendResponse");return K({url:m,content:{f:"json"},callbackParamName:"callback",load:function(m,c){b(a,m,c)},error:E.defaults.io.errorHandler})},_processLegendResponse:function(a,m){m&&m.layers?(a.legendResponse=m,s.byId(this.id+"_"+a.id)&&b.empty(s.byId(this.id+"_"+a.id)),b.create("span",{innerHTML:this._getServiceTitle(a),"class":"esriLegendServiceLabel"},
b.create("td",{align:this._align},b.create("tr",{},b.create("tbody",{},b.create("table",{width:"95%"},s.byId(this.id+"_"+a.id)))))),this._createLegendForLayer(a)):console.log("Legend could not get generated for "+a.url+": "+f.toJson(m))},_buildLegendItems:function(a,m,d){var t=!1,h=s.byId(this.id+"_"+a.id),e=m.parentLayerId;if(m.subLayerIds)a=b.create("div",{id:this.id+"_"+a.id+"_"+m.id+"_group",style:{display:"none"},"class":-1==e?0<d?"esriLegendGroupLayer":"":this._legendAlign},-1==e?h:s.byId(this.id+
"_"+a.id+"_"+e+"_group")),b.create("td",{innerHTML:y.encode(m.name),align:this._align},b.create("tr",{},b.create("tbody",{},b.create("table",{width:"95%","class":"esriLegendLayerLabel"},a))));else{if(this._respectVisibility&&a.visibleLayers)if(d=a.dynamicLayerInfos||a.layerInfos)if(a._params&&a._params.layers){if(-1===c.indexOf(a.visibleLayers,m.id))return t}else{if(d=this._getReallyVisibleLayers(d,a.visibleLayers),-1===c.indexOf(d,m.id))return t}else if(-1===c.indexOf(a.visibleLayers,m.id))return t;
h=b.create("div",{id:this.id+"_"+a.id+"_"+m.id,style:{display:"none"},"class":-1<e?this._legendAlign:""},-1==e?h:s.byId(this.id+"_"+a.id+"_"+e+"_group"));b.create("td",{innerHTML:y.encode(m.name)||"",align:this._align},b.create("tr",{},b.create("tbody",{},b.create("table",{width:"95%","class":"esriLegendLayerLabel"},h))));d=a.dynamicLayerInfos||a.layerInfos;e=!1;d&&d.length&&(e=c.some(d,function(a){return!!a.drawingInfo}));if(a.legendResponse)t=t||this._buildLegendItems_Tools(a,m,h);else if(a.renderer||
e)t=t||this._buildLegendItems_Renderer(a,m,h)}return t},_getReallyVisibleLayers:function(a,m){if(!a||!m||!m.length)return[];var b=[],d=[],h;for(h=0;h<a.length;h++)if(a[h].subLayerIds){if(-1===c.indexOf(m,a[h].id)||-1<c.indexOf(d,a[h].id))d=d.concat(a[h].subLayerIds)}else-1<c.indexOf(m,a[h].id)&&-1===c.indexOf(d,a[h].id)&&b.push(a[h].id);return b},_buildLegendItems_Tools:function(a,m,d){var t=m.parentLayerId,h=this.map.getScale(),e=!1,k=function(a,b){var m,c;for(m=0;m<a.length;m++)if(b.dynamicLayerInfos)for(c=
0;c<b.dynamicLayerInfos[c].length;c++){if(b.dynamicLayerInfos[c].mapLayerId==a[m].layerId)return a[m]}else if(b.id==a[m].layerId)return a[m];return{}};if(!this._respectCurrentMapScale||this._respectCurrentMapScale&&this._isLayerInScale(a,m,h)){var f=!0;if(this._respectCurrentMapScale&&("esri.layers.ArcGISDynamicMapServiceLayer"===a.declaredClass||"esri.layers.ArcGISMapServiceLayer"===a.declaredClass)){var g=this._getEffectiveScale(a,m);if(g.minScale&&g.minScale<h||g.maxScale&&g.maxScale>h)f=!1}if(f){var h=
k(a.legendResponse.layers,m),z=h.legendType,p=h.layerType,l=h.legend;if(l){"esri.layers.ArcGISImageServiceLayer"!==a.declaredClass&&this._sanitizeLegendResponse(a,h,m);d=b.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},d);var q=b.create("tbody",{},d);(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(d,a,m);c.forEach(l,function(b){if(!(10.1<=a.version&&!b.values&&1<l.length&&(a._hideDefaultSymbol||"\x3call other values\x3e"===b.label||!b.label&&!("esri.layers.ArcGISImageServiceLayer"===
a.declaredClass&&10.3<=a.version||"Raster Layer"===p))))if(b.url&&0===b.url.indexOf("http")||b.imageData&&0<b.imageData.length)e=!0,this._buildRow_Tools(b,q,a,m.id,z)},this)}}}e&&(v.set(s.byId(this.id+"_"+a.id+"_"+m.id),"display","block"),-1<t&&(v.set(s.byId(this.id+"_"+a.id+"_"+t+"_group"),"display","block"),this._findParentGroup(a.id,a,t)));return e},_getLayerInfos:function(a){var b=new C,d=a.dynamicLayerInfos||a.layerInfos;if(d&&d.length)if(c.some(d,function(a){return!!a.drawingInfo}))b.resolve(a);
else{var t=a.url,h=t.indexOf("?"),t=-1==h?t+"/layers":t.substring(0,h)+"/layers"+t.substring(h,t.length);K({url:t,content:{f:"json"},callbackParamName:"callback",load:function(h,t){h.layers?(c.forEach(d,function(a){var b=c.filter(h.layers,function(b){return a.source?b.id===a.source.mapLayerId:b.id===a.id});b&&(b[0]&&b[0].drawingInfo)&&(a.drawingInfo=b[0].drawingInfo,a.fields=b[0].fields)}),b.resolve(a)):b.reject(a)},error:function(c){b.reject(a)}})}return b},_sanitizeLegendResponse:function(a,b,d){var t=
b.legend;if(10.1<=a.version&&1<t.length&&!b._sanitized){a=k.getObject("layerDefinition.drawingInfo.renderer",!1,d);var h,e;a||(a=k.getObject("drawingInfo.renderer",!1,d));c.some(t,function(a){if(a.values)return!0})&&c.some(t,function(a,b){a.values||(e=b,h=a);return!!h});a?"uniqueValue"===a.type?h&&(t.splice(e,1),t.push(h)):"classBreaks"===a.type&&(h&&t.splice(e,1),t.reverse(),h&&t.push(h)):h&&(t.splice(e,1),t.push(h));b._sanitized=!0}},_buildRow_Tools:function(a,m,c,t,h){var e=b.create("tr",{},m),
k;this.alignRight?(m=b.create("td",{align:this._isRightToLeft?"left":"right"},e),k=b.create("td",{align:this._isRightToLeft?"left":"right",width:35},e)):(k=b.create("td",{width:35,align:"center"},e),m=b.create("td",{},e));e=a.url;(!d("ie")||9<=d("ie")||9>d("ie")&&"esri.layers.ArcGISImageServiceLayer"===c.declaredClass)&&a.imageData&&0<a.imageData.length?e="data:image/png;base64,"+a.imageData:0!==a.url.indexOf("http")&&(e=c.url+"/"+t+"/images/"+a.url,(t=c._getToken())&&(e+="?token\x3d"+t));t=b.create("img",
{src:e,border:0,style:"opacity:"+c.opacity},k);a=b.create("td",{innerHTML:y.encode(a.label),align:this._align},b.create("tr",{},b.create("tbody",{},b.create("table",{width:"95%",dir:"ltr"},m))));h&&("Stretched"===h&&10.3<=c.version&&"esri.layers.ArcGISImageServiceLayer"===c.declaredClass)&&(a.style.verticalAlign="top",a.style.lineHeight="1",t.style.marginBottom="-1px",t.style.display="block",m.style.verticalAlign="top");9>d("ie")&&(t.style.filter="alpha(opacity\x3d"+100*c.opacity+")")},_getVariable:function(a,
b,c){var d;a&&(d=(a=a.getVisualVariablesForType(b,c))&&a[0]);return d},_getVariables:function(a,b,d){a=[this._getVariable(a,"colorInfo",!1),this._getVariable(a,"opacityInfo",!1),this._getVariable(a,"sizeInfo",!1)];return b?c.filter(a,function(a){return!(!a||!(a.field===b&&a.normalizationField==d))}):a},_getFieldAlias:function(a,b,c){var d=b.infoTemplate,d=d&&d.getFieldInfo&&d.getFieldInfo(a);a=k.isFunction(a)?null:this.getField(b,a,c);b=d||a;c="";b&&(c=d&&d.label||a&&a.alias||b.name||b.fieldName);
return c},_getRampTitle:function(a,b,c){var d,h=a.field,e=a.normalizationField,f=!1,g=!1,B=!1,h=k.isFunction(h)?null:h,e=k.isFunction(e)?null:e;if(a.legendOptions&&a.legendOptions.title)d=a.legendOptions.title;else if(a.valueExpressionTitle)d=a.valueExpressionTitle;else{if(b.renderer&&b.renderer.authoringInfo&&b.renderer.authoringInfo.visualVariables){var l=b.renderer.authoringInfo.visualVariables;for(a=0;a<l.length;a++){var p=l[a];if("colorInfo"===p.type&&"ratio"===p.style){f=!0;break}else if("colorInfo"===
p.type&&"percent"===p.style){g=!0;break}else if("colorInfo"===p.type&&"percentTotal"===p.style){B=!0;break}}}(f=B&&"showRatioPercentTotal"||g&&"showRatioPercent"||f&&"showRatio"||e&&"showNormField"||h&&"showField"||null)&&(d=H.substitute({field:h&&this._getFieldAlias(h,b,c),normField:e&&this._getFieldAlias(e,b,c)},this._i18n[f]))}return d},_getRendererTitle:function(a,b,c){var d;if(a){var h,e,f;a instanceof O&&(h=a.attributeField,e=a.normalizationField,f="percent-of-total"===a.normalizationType);
h=k.isFunction(h)?null:h;e=k.isFunction(e)?null:e;a.legendOptions&&a.legendOptions.title?d=a.legendOptions.title:a.valueExpressionTitle?d=a.valueExpressionTitle:(a=e&&"showNormField"||(f?"showNormPct":null)||h&&"showField"||null)&&(d=H.substitute({field:h&&this._getFieldAlias(h,b,c),normField:e&&this._getFieldAlias(e,b,c)},this._i18n[a]))}return d},_buildLegendItems_Renderer:function(a,m,d){var e=m.parentLayerId,h=this.map,f=h.getScale(),g,l=!1;if(!this._respectCurrentMapScale||this._isLayerInScale(a,
m,f)){var B,z,p,q,n,r,L,x;p="esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass?a.renderer.renderer:m&&m.drawingInfo?ca.fromJson(k.clone(m.drawingInfo.renderer)):a.renderer;if(p instanceof X&&(p=(p="zoom"===p.rangeType?p.getRendererInfoByZoom(h.getZoom()):p.getRendererInfoByScale(f))&&p.renderer,!p))return!1;var D=this._getVariables(p),u=c.filter(D,function(a){return!!a}).length,f=D[0],h=D[1],D=D[2],w,C,M,A,E;f&&(q=this._getMedianColor(p,f),f.field&&(r=k.isFunction(f.field)?null:this.getField(a,
f.field,m)),w=!(f.legendOptions&&!1===f.legendOptions.showLegend));h&&(h.field&&(x=k.isFunction(h.field)?null:this.getField(a,h.field,m)),C=!(h.legendOptions&&!1===h.legendOptions.showLegend));D&&(D.field&&(L=k.isFunction(D.field)?null:this.getField(a,D.field,m)),M=!(D.legendOptions&&!1===D.legendOptions.showLegend));if(p instanceof $)g=l=!0,this._showHeatRamp(a,m,p,d);else if(p instanceof Y)g=l=!0,this._showDotDensityLegend(a,m,p,d);else if(p instanceof Z)g=l=!0,z=b.create("table",{cellpadding:0,
cellspacing:0,width:"95%","class":"esriLegendLayer"},d),B=b.create("tbody",{},z),(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(z,a,m),p.latestObservationRenderer&&p.latestObservationRenderer instanceof N&&this._buildRow_Renderer(a,p.latestObservationRenderer.symbol,q,y.encode(p.latestObservationRenderer.label)||this.NLS_currentObservations,null,B),p.observationRenderer&&p.observationRenderer instanceof N&&this._buildRow_Renderer(a,p.observationRenderer.symbol,q,y.encode(p.observationRenderer.label)||
this.NLS_previousObservations,null,B);else if(p instanceof S){if(p.infos&&0<p.infos.length){g=l=!0;if(p.legendOptions&&p.legendOptions.title||p.valueExpressionTitle)z=b.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},d),B=b.create("tbody",{},z),u=p.legendOptions&&p.legendOptions.title?p.legendOptions.title:p.valueExpressionTitle,this._buildRow_Renderer(a,null,q,y.encode(u),null,B);z=b.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},
d);B=b.create("tbody",{},z);(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(z,a,m);p.attributeField&&D&&this._addSubHeader(B,this._getFieldAlias(p.attributeField,a,m));var F=[];c.forEach(p.infos,function(b){var m=null;a._editable&&a.types&&(m=this._getTemplateFromTypes(a.types,b.value));var d=b.label;null==d&&(d=b.value);-1===c.indexOf(F,d)&&(F.push(d),this._buildRow_Renderer(a,b.symbol,q,y.encode(d),m,B))},this)}E=this._displayDefaultSymbol(a,p,d)}else if(p instanceof O){if(p.infos&&0<p.infos.length||
"esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass){g=l=!0;A=this._isUnclassedRenderer(p);!f&&1===p.infos.length&&(n=(n=p.infos[0])&&n.symbol);A||(z=b.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},d),B=b.create("tbody",{},z),u=this._getRendererTitle(p,a,m),this._buildRow_Renderer(a,null,q,y.encode(u),null,B));z=b.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},d);B=b.create("tbody",{},z);(a._hoverLabel||a._hoverLabels)&&
this._createHoverAction(z,a,m);if(!A||!D||!M)u=p.infos.slice(0).reverse(),c.forEach(u,function(b){var m=b.label;null==m&&!A&&(m=b.minValue+" - "+b.maxValue);this._buildRow_Renderer(a,b.symbol,q,y.encode(m),null,B)},this);if("esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass&&(a.renderer.style===V.STYLE_SCALAR||a.renderer.style===V.STYLE_SINGLE_ARROW))this._buildRow_Renderer(a,p.defaultSymbol,null,"",null,B),a._hideDefaultSymbol=!0}A||(E=this._displayDefaultSymbol(a,p,d))}else p instanceof
N&&(g=l=!0,z=b.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},d),B=b.create("tbody",{},z),(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(z,a,m),n=null,a._editable&&(a.templates&&0<a.templates.length)&&(n=a.templates[0]),z=1<u?null:r&&w||x&&C||L&&M,this._buildRow_Renderer(a,p.symbol,q,y.encode(z?this._getRampTitle(1<u?null:f||h||D,a,m):p.label),n,B),n=f?null:p.symbol,z&&(r=x=L=null));if(g){if(f&&w&&(f.field||f.valueExpression))this._showGradientRamp(a,
m,p,null,d,f,r,null,D&&M?!0:!1);if(D&&M&&(D.field||D.valueExpression))g=f&&w||p instanceof S?!1:!0,this._showSizeLegend(a,m,p,D,q,d,L,null,g);if(h&&C&&(h.field||h.valueExpression))L=n&&!n.url&&n.color?n.color:this.transparencyRampColor,this._showGradientRamp(a,m,p,L,d,h,x,null,!1)}if(!E&&(!A||w||M||C))E=this._displayDefaultSymbol(a,p,d);l=l||E}l&&(v.set(s.byId(this.id+"_"+a.id+"_"+m.id),"display","block"),-1<e&&(v.set(s.byId(this.id+"_"+a.id+"_"+e+"_group"),"display","block"),this._findParentGroup(a.id,
e)));return l},_isUnclassedRenderer:function(a,b){var c;if(a instanceof O&&a.infos&&1===a.infos.length){c=a.attributeField;var d=a.normalizationField;c=b?c===b:!!this._getVariables(a,c,d).length}return c},_displayDefaultSymbol:function(a,m,c){var d;!a._hideDefaultSymbol&&m.defaultSymbol&&(d=!0,c=b.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c),c=b.create("tbody",{},c),this._buildRow_Renderer(a,m.defaultSymbol,null,y.encode(m.defaultLabel)||"others",null,c));
return d},_showGradientRamp:function(a,c,d,e,h,f,g,l,B){B=b.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"+(!B?" esriLegendSubFragment":"")},h);h=b.create("tbody",{},B);(a._hoverLabel||a._hoverLabels||l)&&this._createHoverAction(B,a,c,l);(g||f.valueExpression)&&this._addSubHeader(h,this._getRampTitle(f,a,c));g=f.field;var q;g&&(q=k.isFunction(g)?null:this.getField(a,g,c));(c=this._getRampStops(d,f,e,q&&"esriFieldTypeDate"===q.type))&&c.length&&this._drawGradientRamp(h,
c,!0,a,this._getRampBorderColor(d),!!e)},_getMedianColor:function(a,b){var c,d;b.colors?(c=b.minDataValue,d=b.maxDataValue):b.stops&&(c=b.stops[0].value,d=b.stops[b.stops.length-1].value);return a.getColor(c+(d-c)/2,{colorInfo:b})},_getRampStops:function(a,b,d,e){var h,k,f,g,l=!1;b.colors||b.opacityValues?(k=b.maxDataValue-b.minDataValue,h=c.map([0,0.25,0.5,0.75,1],function(a){f=b.minDataValue+a*k;return Number(f.toFixed(6))}),this._checkPrecision(0,4,h)):b.stops&&(h=c.map(b.stops,function(a){return a.value}),
(l=c.some(b.stops,function(a){return!!a.label}))&&(g=c.map(b.stops,function(a){return a.label})));var z=h[0],p,n;k=h[h.length-1]-z;return c.map(h,function(c,f){d?(p=new q(d.toRgba()),n=a.getOpacity(c,{opacityInfo:b}),null!=n&&(p.a=n)):p=a.getColor(c,{colorInfo:b});var Q="";if(l)Q=g[f];else{var Q=e?R.formatDate(c,R.timelineDateFormatOptions):G.format(c),r="";0===f?r=this._specialChars.lt+" ":f===h.length-1&&(r=this._specialChars.gt+" ");Q=r+Q}return{value:c,color:p,offset:1-(c-z)/k,label:Q}},this).reverse()},
_checkPrecision:function(a,b,c){var d=a+(b-a)/2,h=c[a],e=c[d],k=c[b],f=Math.floor(h),g=Math.floor(e),l=Math.floor(k);f===h&&(l===k&&g!==e&&f!==g&&l!==g)&&(c[d]=g);a+1!==d&&this._checkPrecision(a,d,c);d+1!==b&&this._checkPrecision(d,b,c)},_getRampBorderColor:function(a){var b;if(a instanceof N)b=a.symbol;else if(a instanceof S||a instanceof O)b=a.infos[0].symbol;return(a=b&&-1===b.type.indexOf("linesymbol")?b.getStroke():null)&&a.color},_drawGradientRamp:function(a,m,e,t,h,k){var f=b.create("tr",{},
a),g,l,n,p,r,s=m.length-1,u;p=0;this.alignRight?(a=b.create("td",{align:this._isRightToLeft?"left":"right"},f),g=b.create("td",{align:this._isRightToLeft?"left":"right",width:this.gradientWidth},f)):(g=b.create("td",{width:this.gradientWidth,align:"center"},f),a=b.create("td",{},f));f=h&&0<h.a&&!(240<=h.r&&240<=h.g&&240<=h.b);l=b.create("div",{"class":f?"":"esriLegendBorderLessColorRamp",style:"position: relative; width:"+this.gradientWidth+"px;"},g);g=b.create("div",{"class":"esriLegendColorRamp"+
(k?" esriLegendTransparencyRamp":"")},l);k=v.get(g,"width");f&&(h=9>d("ie")?h.toHex():"rgba("+h.toRgba().join(",")+")",v.set(g,"border",this.colorRampBorder+" "+h));e?(h=this.gradientHeight*s,v.set(g,"height",h+"px")):h=v.get(g,"height");v.set(l,"height",h+"px");f=x.createSurface(g,k,h);9>d("ie")&&(p=f.getEventSource(),v.set(p,"position","relative"),v.set(p.parentNode,"position","relative"),p=1);try{e&&c.forEach(m,function(a,b){a.offset=b/s}),r=f.createRect({x:-p,y:-p,width:k+p,height:h+p}),r.setFill({type:"linear",
x1:0,y1:0,x2:0,y2:h,colors:m}).setStroke(null),f.createRect({width:k,height:h}).setFill(new q([255,255,255,1-t.opacity])).setStroke(null),this._surfaceItems.push(f)}catch(w){f.clear(),f.destroy()}c.forEach(m,function(a,c){if(a.label){u="top:"+100*a.offset+"%;";var d="";0===c&&(d+=" esriLegendColorRampTickFirst");c===m.length-1&&(d+=" esriLegendColorRampTickLast");b.create("div",{"class":"esriLegendColorRampTick"+d,innerHTML:"\x26nbsp;",style:u},l)}});n=b.create("div",{"class":"esriLegendColorRampLabels",
style:{height:h+this.gradientHeight+"px"}},a);e?c.forEach(m,function(a){b.create("div",{"class":"esriLegendColorRampLabel",innerHTML:y.encode(a.label)||"\x26nbsp;"},n)}):(b.create("div",{"class":"esriLegendColorRampLabel",innerHTML:this._i18n.high},n),b.create("div",{"class":"esriLegendColorRampLabel",innerHTML:this._i18n.low,style:"top: "+(h+this.gradientHeight-2*this.gradientHeight)+"px;"},n))},_showHeatRamp:function(a,c,d,e,h){var f,k=d.field;f=b.create("table",{cellpadding:0,cellspacing:0,width:"95%",
"class":"esriLegendLayer"},e);e=b.create("tbody",{},f);(a._hoverLabel||a._hoverLabels||h)&&this._createHoverAction(f,a,c,h);(k=k&&this.getField(a,k,c))&&this._addSubHeader(e,this._getFieldAlias(k.name,a,c));c=this._getHeatmapStops(d);c.length&&this._drawGradientRamp(e,c,!1,a)},_getHeatmapStops:function(a){var b=a.colorStops;a=a.colors;var d,e,h,f;if(b&&b[0])if(d=b.length-1,a=b[0]&&null!=b[0].ratio){if((a=b[d])&&1!==a.ratio)b=b.slice(0),b.push({ratio:1,color:a.color}),d++}else e=b[0].value,h=b[d].value-
e,b=c.map(b,function(a){return{color:a.color,ratio:(a.value-e)/h}});else a&&a[0]&&(d=a.length-1,f=1/(a.length-1),b=c.map(a,function(a,b){return{color:a,ratio:b*f}}));b=c.map(b,function(a,b){var c="";0===b?c="Low":b===d&&(c="High");return{color:a.color,label:c,offset:1-a.ratio}});return b.reverse()},_showDotDensityLegend:function(a,d,e,f){var h=e.legendOptions,g,l,q,n,r,p,s,v=this.dotDensitySwatchSize,u=Math.round(v/2);h&&(l=h.backgroundColor,q=h.outline,n=h.valueUnit,r=h.dotCoverage);r=(r||this.dotCoverage)/
100;s=Math.round(v*v/Math.pow(e.dotSize,2)*r);f=b.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},f);p=b.create("tbody",{},f);(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(f,a,d);this._addSubHeader(p,H.substitute({value:e.dotValue,unit:n||""},this.NLS_dotValue));c.forEach(e.fields,function(b){b=k.mixin({},b);b.numPoints=s;g=new aa(e._generateImageSrc(v,v,[b],{x:0,y:0},{x:v,y:v},l),q||e.outline,v,v);b=this.getField(a,b.name,d)||b;this._buildRow_Renderer(a,
g,null,y.encode(this._getFieldAlias(b.name,a,d)),null,p,{type:"path",path:"M "+-u+","+-u+" L "+u+","+-u+" L "+u+","+u+" L "+-u+","+u+" L "+-u+","+-u+" E"})},this)},_showSizeLegend:function(a,c,d,e,h,f,g,l,q){var n=e.legendOptions,n=n&&n.customValues;h=this._getSizeSymbol(d,h);if(!(e.valueUnit&&"unknown"!==e.valueUnit||!h||!n&&(null==e.minSize||null==e.maxSize||null==e.minDataValue||null==e.maxDataValue)&&(!e.stops||1>=e.stops.length))){q=b.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"+
(!q?" esriLegendSubFragment":"")},f);f=b.create("tbody",{},q);(a._hoverLabel||a._hoverLabels||l)&&this._createHoverAction(q,a,c,l);(g||e.valueExpression)&&this._addSubHeader(f,this._getRampTitle(e,a,c));g=e.field;var p;g&&(p=k.isFunction(g)?null:this.getField(a,g,c));c=p&&"esriFieldTypeDate"===p.type;n=n||this._getDataValues(d,h,e,c);for(p=q=n.length-1;0<=p;p--)g=n[p],h=T.fromJson(h.toJson()),this._applySize(h,d,e,g),g=c?R.formatDate(g,R.timelineDateFormatOptions):G.format(g),l="",p===q?l=this._specialChars.gt+
" ":0===p&&(l=this._specialChars.lt+" "),l="\x3cspan class\x3d'esriLegendSizeRampLabel'\x3e"+y.encode(l+g)+"\x3c/span\x3e",this._buildRow_Renderer(a,h,null,l,null,f)}},_getSizeSymbol:function(a,b){var c,d;if(a instanceof N)c=a.symbol;else if(a instanceof V)c=a.defaultSymbol;else if(a instanceof S||a instanceof O)c=a.infos[0].symbol,d=1<a.infos.length;if(c=c&&-1!==c.type.indexOf("fillsymbol")?null:c)if(c=T.fromJson(c.toJson()),b||d)-1!==c.type.indexOf("linesymbol")?c.setColor(new q(this.sizeRampDarkColor)):
(c.setColor(new q(this.sizeRampLightColor)),c.setOutline&&(d=new ba,d.setColor(new q(this.sizeRampDarkColor)),d.setWidth(1.5),c.setOutline(d)));return c},_getDataValues:function(a,b,d,e,h,f){h=null==h?5:h;f=null==f?20:f;var k=a.getSizeRangeAtScale(d,this.map.getScale());h=this._interpolateSizeRange(k,h);var g=this._getDataRange(d),l=c.map(h,function(a){return this._getDataValueFromSize(a,g,k)},this);if(!e){var n,l=G.round(l);for(e=1;e<l.length-1;e++)if(n=this._roundDataValue(a,b,d,l[e],l[e-1],f))l[e]=
n[0],h[e]=n[1]}return l},_getDataRange:function(a){var b=a.stops;return b?{min:b[0].value,max:b[b.length-1].value}:{min:a.minDataValue,max:a.maxDataValue}},_interpolateSizeRange:function(a,b){var c=a.minSize,d=(a.maxSize-c)/(b-1),e,f=[];for(e=0;e<b;e++)f.push(c+d*e);return f},_getDataValueFromSize:function(a,b,c){var d=c.minSize;c=c.maxSize;var e=b.min;b=b.max;return a=a<=d?e:a>=c?b:(a-d)/(c-d)*(b-e)+e},_roundDataValue:function(a,b,c,d,e,f){var k=this._getSize(b,a,c,d);e=this._getSize(b,a,c,e);var g,
l=G.getDigits(d),n=l.integer,l=l.fractional,p,q,r,s,v,u,w,x,y,A,C;0<d&&1>d&&(g=Math.pow(10,l),d*=g,n=G.getDigits(d).integer);for(n-=1;0<=n&&!(p=Math.pow(10,n),l=Math.floor(d/p)*p,p*=Math.ceil(d/p),null!=g&&(l/=g,p/=g),q=(l+p)/2,q=G.round([l,q,p],{indexes:[1]})[1],r=this._getSize(b,a,c,l),s=this._getSize(b,a,c,p),v=this._getSize(b,a,c,q),u=G.getPctChange(k,r,e,null),w=G.getPctChange(k,s,e,null),x=G.getPctChange(k,v,e,null),y=u.prev<=f,A=w.prev<=f,y&&A&&(u.prev<=w.prev?(y=!0,A=!1):(A=!0,y=!1)),y?C=
[l,r]:A?C=[p,s]:x.prev<=f&&(C=[q,v]),C);n--);return C},_applySize:function(a,b,c,d){var e=a.type;b=this._getSize(a,b,c,d);switch(e){case "simplemarkersymbol":a.setSize(b);break;case "picturemarkersymbol":e=a.width;c=a.height;a.setHeight(b);a.setWidth(b*(e/c));break;case "simplelinesymbol":case "cartographiclinesymbol":a.setWidth(b);break;case "textsymbol":a.font&&a.font.setSize(b)}},_getSize:function(a,b,c,d){return b.getSize(d,{sizeInfo:c,scale:this.map.getScale(),shape:-1!==a.type.indexOf("markersymbol")?
a.style:null})},_buildRow_Renderer:function(a,c,d,e,h,f,k){var g=b.create("tr",{},f),l;this.alignRight?(f=b.create("td",{align:this._isRightToLeft?"left":"right"},g),c&&(l=b.create("td",{align:this._isRightToLeft?"left":"right",width:35},g))):(c&&(l=b.create("td",{width:35,align:"center"},g)),f=b.create("td",{},g));var n=g=30,p;if(c){if("simplemarkersymbol"==c.type)g=Math.min(Math.max(g,c.size+12),125),n=Math.min(Math.max(n,c.size+12),125);else if("picturemarkersymbol"==c.type)g=Math.min(Math.max(g,
c.width),125),n=Math.min(c.height||n,125);else if("textsymbol"==c.type){var q,r;c.text||(q=c.text,r=!0,c.setText(this.defaultText));g=Math.min(Math.max(g,c.getWidth()+12),125);n=Math.min(Math.max(n,c.getHeight()+12),125);r&&c.setText(q)}p=b.create("div",{style:"width:"+g+"px;height:"+n+"px;"},l)}H.isDefined(e)&&"number"===typeof e&&(e=""+e);b.create("td",{innerHTML:e||"",align:this._align},b.create("tr",{},b.create("tbody",{},b.create("table",{width:"95%"},f))));c&&(a=this._drawSymbol(p,c,d,g,n,h,
a,k),this._surfaceItems.push(a))},_addSubHeader:function(a,c){var d=b.create("tr",{},a),d=b.create("td",{align:this._align,colspan:2},d);b.create("td",{innerHTML:y.encode(c)||"",align:this._align},b.create("tr",{},b.create("tbody",{},b.create("table",{width:"95%"},d))))},_drawSymbol:function(a,b,c,e,h,f,g,l){b=T.fromJson(b.toJson());var n=g.opacity;c&&b.setColor(new q(c.toRgba()));if("simplelinesymbol"===b.type||"cartographiclinesymbol"===b.type||"textsymbol"===b.type){if(!b.color)return;c=b.color.toRgba();
c[3]*=n;b.color.setColor(c)}else"simplemarkersymbol"===b.type||"simplefillsymbol"===b.type?(b.color&&(c=b.color.toRgba(),c[3]*=n,b.color.setColor(c)),b.outline&&b.outline.color&&(c=b.outline.color.toRgba(),c[3]*=n,b.outline.color.setColor(c))):"picturemarkersymbol"===b.type&&(a.style.opacity=n,a.style.filter="alpha(opacity\x3d("+100*n+"))");a=x.createSurface(a,e,h);9>d("ie")&&(c=a.getEventSource(),v.set(c,"position","relative"),v.set(c.parentNode,"position","relative"));f=this._getDrawingToolShape(b,
f)||T.getShapeDescriptors(b);var r,n=(c=f.defaultShape)&&"text"===c.type;try{n&&!c.text&&(c.text=this.defaultText),r=a.createShape(l||c).setFill(f.fill).setStroke(f.stroke),n&&r.setFont(f.font)}catch(p){a.clear();a.destroy();return}var s=r.getBoundingBox();l=s.width;f=s.height;var n=-(s.x+l/2),u=-(s.y+f/2);c=a.getDimensions();n={dx:n+c.width/2,dy:u+c.height/2};if("simplemarkersymbol"===b.type&&"path"===b.style)e=g._getScaleMatrix(s,b.size),r.applyTransform(A.scaleAt(e.xx,e.yy,{x:c.width/2,y:c.height/
2}));else if(l>e||f>h)g=l/e>f/h,e=((g?e:h)-5)/(g?l:f),k.mixin(n,{xx:e,yy:e});r.applyTransform(n);return a},_getDrawingToolShape:function(a,b){var c;switch(b?b.drawingTool||null:null){case "esriFeatureEditToolArrow":c={type:"path",path:"M 10,1 L 3,8 L 3,5 L -15,5 L -15,-2 L 3,-2 L 3,-5 L 10,1 Z"};break;case "esriFeatureEditToolTriangle":c={type:"path",path:"M -10,14 L 2,-10 L 14,14 L -10,14 Z"};break;case "esriFeatureEditToolRectangle":c={type:"path",path:"M -10,-10 L 10,-10 L 10,10 L -10,10 L -10,-10 Z"};
break;case "esriFeatureEditToolCircle":c={type:"circle",cx:0,cy:0,r:10};break;case "esriFeatureEditToolEllipse":c={type:"ellipse",cx:0,cy:0,rx:10,ry:5};break;default:return null}return{defaultShape:c,fill:a.getFill(),stroke:a.getStroke()}},_repaintItems:function(){c.forEach(this._surfaceItems,function(a){this._repaint(a)},this)},_repaint:function(a){if(a){a.getStroke&&a.setStroke&&a.setStroke(a.getStroke());try{a.getFill&&a.setFill&&a.setFill(a.getFill())}catch(b){}a.children&&k.isArray(a.children)&&
c.forEach(a.children,this._repaint,this)}},_createHoverAction:function(a,c,d,e){if(e=c._hoverLabel||c._hoverLabels&&c._hoverLabels[d.id]||e)e=y.encode(e),c.mouseMoveHandler=c.mouseMoveHandler||{},c.mouseMoveHandler[d.id]=g.connect(a,"onmousemove",k.hitch(this,function(a,c){this.mouseX=c.clientX;this.mouseY=c.clientY;this.hoverLabelShowing&&(this.hoverLabelShowing=!1,v.set(s.byId(this.id+"_hoverLabel"),"display","none"));setTimeout(k.hitch(this,function(a,c,d){if(a==this.mouseX&&c==this.mouseY&&!this.hoverLabelShowing)if(this.hoverLabelShowing=
!0,s.byId(this.id+"_hoverLabel")){var e=s.byId(this.id+"_hoverLabel");e.innerHTML="\x3cspan\x3e"+d+"\x3c/span\x3e";v.set(e,"top",c+"px");v.set(e,"left",a+15+"px");v.set(e,"display","")}else b.create("div",{innerHTML:"\x3cspan\x3e"+d+"\x3c/span\x3e",id:this.id+"_hoverLabel","class":"esriLegendHoverLabel",style:{top:c+"px",left:a+15+"px"}},document.body)},c.clientX,c.clientY,a),500)},e)),c.mouseOutHandler=c.mouseOutHandler||{},c.mouseOutHandler[d.id]=g.connect(a,"onmouseout",k.hitch(this,function(a){this.mouseY=
this.mouseX=-1;this.hoverLabelShowing&&(this.hoverLabelShowing=!1,v.set(s.byId(this.id+"_hoverLabel"),"display","none"))}))},_removeHoverHandlers:function(){var a;c.forEach(this.layers,function(b){if(b.mouseMoveHandler)for(a in b.mouseMoveHandler)g.disconnect(b.mouseMoveHandler[a]);if(b.mouseOutHandler)for(a in b.mouseOutHandler)g.disconnect(b.mouseOutHandler[a])})},_createDynamicLayers:function(a){var b=[],d;c.forEach(a.dynamicLayerInfos||a.layerInfos,function(c){d={id:c.id};d.source=c.source&&c.source.toJson();
var e;a.layerDefinitions&&a.layerDefinitions[c.id]&&(e=a.layerDefinitions[c.id]);e&&(d.definitionExpression=e);var f;a.layerDrawingOptions&&a.layerDrawingOptions[c.id]&&(f=a.layerDrawingOptions[c.id]);f&&(d.drawingInfo=f.toJson());d.minScale=c.minScale||0;d.maxScale=c.maxScale||0;b.push(d)});return b},_getTemplateFromTypes:function(a,b){var c;for(c=0;c<a.length;c++)if(a[c].id==b&&a[c].templates&&0<a[c].templates.length)return a[c].templates[0];return null},_findParentGroup:function(a,b,c){var d,e=
b.dynamicLayerInfos||b.layerInfos;for(d=0;d<e.length;d++)if(c==e[d].id){-1<e[d].parentLayerId&&(v.set(s.byId(this.id+"_"+a+"_"+e[d].parentLayerId+"_group"),"display","block"),this._findParentGroup(a,b,e[d].parentLayerId));break}},_addSubLayersToHide:function(a){function b(d,e){var f=a.layer.dynamicLayerInfos||a.layer.layerInfos,g,k;for(g=0;g<f.length;g++)if(f[g].id===d&&f[g].subLayerIds)for(k=0;k<f[g].subLayerIds.length;k++){var l=f[g].subLayerIds[k];-1===c.indexOf(e,l)&&(e.push(l),b(l,e))}}a.layer.layerInfos&&
c.forEach(this.hideLayersInLegend[a.layer.id],function(c){b(c,this.hideLayersInLegend[a.layer.id])},this)},_isLayerInScale:function(a,b,c){var d,e=!0;if(a.legendResponse&&a.legendResponse.layers)for(d=0;d<a.legendResponse.layers.length;d++){var f=a.legendResponse.layers[d];if(b.id==f.layerId){var g,k;!a.minScale&&0!==a.minScale||!a.maxScale&&0!==a.maxScale?(0==f.minScale&&a.tileInfo&&(g=a.tileInfo.lods[0].scale),0==f.maxScale&&a.tileInfo&&(k=a.tileInfo.lods[a.tileInfo.lods.length-1].scale)):(g=Math.min(a.minScale,
f.minScale)||a.minScale||f.minScale,k=Math.max(a.maxScale,f.maxScale));if(0<g&&g<c||k>c)e=!1;break}}else if(a.minScale||a.maxScale)if(a.minScale&&a.minScale<c||a.maxScale&&a.maxScale>c)e=!1;return e},_getServiceTitle:function(a){var b=a._titleForLegend;b||((b=a.url)?-1<a.url.indexOf("/MapServer")?(b=a.url.substring(0,a.url.indexOf("/MapServer")),b=b.substring(b.lastIndexOf("/")+1,b.length)):-1<a.url.indexOf("/ImageServer")?(b=a.url.substring(0,a.url.indexOf("/ImageServer")),b=b.substring(b.lastIndexOf("/")+
1,b.length)):-1<a.url.indexOf("/FeatureServer")&&(b=a.url.substring(0,a.url.indexOf("/FeatureServer")),b=b.substring(b.lastIndexOf("/")+1,b.length)):b="",a.name&&(b=0<b.length?b+(" - "+a.name):a.name));"esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass&&a.vectorFieldPixelFilter&&(a=a.vectorFieldPixelFilter.outputUnit?this["NLS_"+a.vectorFieldPixelFilter.outputUnit]:this["NLS_"+a.vectorFieldPixelFilter.inputUnit],H.isDefined(a)&&(b+=" ("+a+")"));return y.encode(b)},_getEffectiveScale:function(a,
b){var c=b.minScale,d=b.maxScale;if(H.isDefined(b.parentLayerId)){var e=a.layerInfos,f=b.parentLayerId,g;for(g=e.length-1;0<=g;g--)if(e[g].id==f)if(0==c&&0<e[g].minScale?c=e[g].minScale:0<c&&0==e[g].minScale||0<c&&0<e[g].minScale&&(c=Math.min(c,e[g].minScale)),d=Math.max(d||0,e[g].maxScale||0),-1<e[g].parentLayerId)f=e[g].parentLayerId;else break}return{minScale:c,maxScale:d}},_isSupportedLayerType:function(a){return a&&("esri.layers.ArcGISDynamicMapServiceLayer"===a.declaredClass||"esri.layers.ArcGISImageServiceLayer"===
a.declaredClass&&10.2<=a.version||"esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass||"esri.layers.ArcGISTiledMapServiceLayer"===a.declaredClass||"esri.layers.FeatureLayer"===a.declaredClass||"esri.layers.StreamLayer"===a.declaredClass||"esri.layers.KMLLayer"===a.declaredClass||"esri.layers.GeoRSSLayer"===a.declaredClass||"esri.layers.WMSLayer"===a.declaredClass||"esri.layers.WFSLayer"===a.declaredClass||"esri.layers.CSVLayer"===a.declaredClass)?!0:!1},isHostedTileService:function(a){var b=
/(https?:)?\/\/services.*\.arcgis\.com/i;return"esri.layers.ArcGISTiledMapServiceLayer"===a.declaredClass&&b.test(a.url)?!0:!1},getField:function(a,b,d){if(a.getField)return a.getField(b);if(d&&d.fields){var e;c.forEach(d.fields,function(a){a.name===b&&(e=a)});return e}return null}});k.mixin(J,{ALIGN_LEFT:0,ALIGN_RIGHT:1});d("extend-esri")&&k.setObject("dijit.Legend",J,U);return J});