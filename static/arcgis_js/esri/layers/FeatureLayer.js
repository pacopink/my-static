// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.19/esri/copyright.txt for details.
//>>built
require({cache:{"esri/tasks/QueryTask":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/Deferred dojo/_base/json dojo/has ../kernel ../request ../deferredUtils ../geometry/Extent ../geometry/normalizeUtils ./Task ./FeatureSet".split(" "),function(f,l,m,n,p,d,u,s,b,e,a,c,g){f=f(c,{declaredClass:"esri.tasks.QueryTask",_eventMap:{complete:["featureSet"],"execute-for-count-complete":["count"],"execute-for-ids-complete":["objectIds"],"execute-relationship-query-complete":["featureSets"]},
constructor:function(c,a){this._handler=l.hitch(this,this._handler);this._relationshipQueryHandler=l.hitch(this,this._relationshipQueryHandler);this._executeForIdsHandler=l.hitch(this,this._executeForIdsHandler);this._countHandler=l.hitch(this,this._countHandler);this._extentHandler=l.hitch(this,this._extentHandler);this.source=a&&a.source;this.gdbVersion=a&&a.gdbVersion;this.registerConnectEvents()},__msigns:[{n:"execute",c:4,a:[{i:0,p:["geometry"]}],e:2},{n:"executeForIds",c:3,a:[{i:0,p:["geometry"]}],
e:2},{n:"executeForCount",c:3,a:[{i:0,p:["geometry"]}],e:2},{n:"executeForExtent",c:3,a:[{i:0,p:["geometry"]}],e:2}],onComplete:function(){},onExecuteRelationshipQueryComplete:function(){},onExecuteForIdsComplete:function(){},onExecuteForCountComplete:function(){},onExecuteForExtentComplete:function(){},execute:function(a,c,h,k,g){var b=g.assembly;a=this._encode(l.mixin({},this._url.query,{f:"json"},a.toJson(b&&b[0])));var e=this._handler,d=this._errorHandler;this.source&&(b={source:this.source.toJson()},
a.layer=p.toJson(b));this.gdbVersion&&(a.gdbVersion=this.gdbVersion);return s({url:this._url.path+"/query",content:a,callbackParamName:"callback",load:function(a,k){e(a,k,c,h,g.dfd)},error:function(a){d(a,h,g.dfd)},callbackSuffix:k},this.requestOptions)},executeRelationshipQuery:function(a,c,h){a=this._encode(l.mixin({},this._url.query,{f:"json"},a.toJson()));var g=this._relationshipQueryHandler,w=this._errorHandler;this.gdbVersion&&(a.gdbVersion=this.gdbVersion);var e=new n(b._dfdCanceller);e._pendingDfd=
s({url:this._url.path+"/queryRelatedRecords",content:a,callbackParamName:"callback",load:function(a,q){g(a,q,c,h,e)},error:function(a){w(a,h,e)}},this.requestOptions);return e},executeForIds:function(a,c,h,g){var b=g.assembly;a=this._encode(l.mixin({},this._url.query,{f:"json",returnIdsOnly:!0},a.toJson(b&&b[0])));var e=this._executeForIdsHandler,d=this._errorHandler;this.source&&(b={source:this.source.toJson()},a.layer=p.toJson(b));this.gdbVersion&&(a.gdbVersion=this.gdbVersion);return s({url:this._url.path+
"/query",content:a,callbackParamName:"callback",load:function(a,q){e(a,q,c,h,g.dfd)},error:function(a){d(a,h,g.dfd)}},this.requestOptions)},executeForCount:function(a,c,g,k){var b=k.assembly;a=this._encode(l.mixin({},this._url.query,{f:"json",returnIdsOnly:!0,returnCountOnly:!0},a.toJson(b&&b[0])));var e=this._countHandler,d=this._errorHandler;this.source&&(b={source:this.source.toJson()},a.layer=p.toJson(b));this.gdbVersion&&(a.gdbVersion=this.gdbVersion);return s({url:this._url.path+"/query",content:a,
callbackParamName:"callback",load:function(a,b){e(a,b,c,g,k.dfd)},error:function(a){d(a,g,k.dfd)}},this.requestOptions)},executeForExtent:function(a,c,g,k){var b=k.assembly;a=this._encode(l.mixin({},this._url.query,{f:"json",returnExtentOnly:!0,returnCountOnly:!0},a.toJson(b&&b[0])));var e=this._extentHandler,d=this._errorHandler;this.source&&(b={source:this.source.toJson()},a.layer=p.toJson(b));this.gdbVersion&&(a.gdbVersion=this.gdbVersion);return s({url:this._url.path+"/query",content:a,callbackParamName:"callback",
load:function(a,b){e(a,b,c,g,k.dfd)},error:function(a){d(a,g,k.dfd)}},this.requestOptions)},_handler:function(a,c,h,k,b){try{var e=new g(a);this._successHandler([e],"onComplete",h,b)}catch(d){this._errorHandler(d,k,b)}},_relationshipQueryHandler:function(a,c,h,k,b){try{var e=a.geometryType,d=a.spatialReference,s={};m.forEach(a.relatedRecordGroups,function(a){var c={};c.geometryType=e;c.spatialReference=d;c.features=a.relatedRecords;c=new g(c);if(null!=a.objectId)s[a.objectId]=c;else for(var h in a)a.hasOwnProperty(h)&&
"relatedRecords"!==h&&(s[a[h]]=c)});this._successHandler([s],"onExecuteRelationshipQueryComplete",h,b)}catch(f){this._errorHandler(f,k,b)}},_executeForIdsHandler:function(a,c,g,k,b){try{this._successHandler([a.objectIds],"onExecuteForIdsComplete",g,b)}catch(e){this._errorHandler(e,k,b)}},_countHandler:function(a,c,g,k,b){try{var e,d=a.features,s=a.objectIds;if(s)e=s.length;else{if(d)throw Error("Unable to perform query. Please check your parameters.");e=a.count}this._successHandler([e],"onExecuteForCountComplete",
g,b)}catch(f){this._errorHandler(f,k,b)}},_extentHandler:function(a,c,g,k,b){try{a.extent&&(a.extent=new e(a.extent)),this._successHandler([a],"onExecuteForExtentComplete",g,b)}catch(d){this._errorHandler(d,k,b)}}});a._createWrappers(f);d("extend-esri")&&l.setObject("tasks.QueryTask",f,u);return f})},"esri/tasks/Task":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/json dojo/has ../kernel ../deferredUtils ../urlUtils ../Evented".split(" "),function(f,l,m,n,p,d,u,s){f=f(s,{declaredClass:"esri.tasks._Task",
_eventMap:{error:["error"],complete:["result"]},constructor:function(b,e){b&&l.isString(b)&&(this._url=u.urlToObject(this.url=b));e&&e.requestOptions&&(this.requestOptions=e.requestOptions);this.normalization=!0;this._errorHandler=l.hitch(this,this._errorHandler);this.registerConnectEvents()},_useSSL:function(){var b=this._url,e=/^http:/i;this.url&&(this.url=this.url.replace(e,"https:"));b&&b.path&&(b.path=b.path.replace(e,"https:"))},_encode:function(b,e,a){var c,g,q={},r,h;for(r in b)if("declaredClass"!==
r&&(c=b[r],g=typeof c,null!==c&&void 0!==c&&"function"!==g))if(l.isArray(c)){q[r]=[];h=c.length;for(g=0;g<h;g++)q[r][g]=this._encode(c[g])}else"object"===g?c.toJson&&(g=c.toJson(a&&a[r]),"esri.tasks.FeatureSet"===c.declaredClass&&g.spatialReference&&(g.sr=g.spatialReference,delete g.spatialReference),q[r]=e?g:m.toJson(g)):q[r]=c;return q},_successHandler:function(b,e,a,c){e&&this[e].apply(this,b);a&&a.apply(null,b);c&&d._resDfd(c,b)},_errorHandler:function(b,e,a){this.onError(b);e&&e(b);a&&a.errback(b)},
setNormalization:function(b){this.normalization=b},onError:function(){}});n("extend-esri")&&(p.Task=f);return f})},"esri/tasks/FeatureSet":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has ../kernel ../lang ../graphic ../SpatialReference ../graphicsUtils ../geometry/jsonUtils ../symbols/jsonUtils".split(" "),function(f,l,m,n,p,d,u,s,b,e,a){f=f(null,{declaredClass:"esri.tasks.FeatureSet",constructor:function(c){if(c){l.mixin(this,c);var g=this.features,b=c.spatialReference,
r=e.getGeometryType(c.geometryType),b=this.spatialReference=new s(b);this.geometryType=c.geometryType;c.fields&&(this.fields=c.fields);m.forEach(g,function(c,k){var e=c.geometry&&c.geometry.spatialReference;g[k]=new u(r&&c.geometry?new r(c.geometry):null,c.symbol&&a.fromJson(c.symbol),c.attributes);g[k].geometry&&!e&&g[k].geometry.setSpatialReference(b)});this._hydrate()}else this.features=[]},displayFieldName:null,geometryType:null,spatialReference:null,fieldAliases:null,toJson:function(a){var g=
{};this.displayFieldName&&(g.displayFieldName=this.displayFieldName);this.fields&&(g.fields=this.fields);this.spatialReference?g.spatialReference=this.spatialReference.toJson():this.features[0]&&this.features[0].geometry&&(g.spatialReference=this.features[0].geometry.spatialReference.toJson());this.features[0]&&(this.features[0].geometry&&(g.geometryType=e.getJsonType(this.features[0].geometry)),g.features=b._encodeGraphics(this.features,a));g.exceededTransferLimit=this.exceededTransferLimit;g.transform=
this.transform;return d.fixJson(g)},_hydrate:function(){var a=this.transform,g=this.geometryType;if(a&&g)for(var b=this.features,e=a.translate[0],h=a.translate[1],k=a.scale[0],d=a.scale[1],s=function(a,c,g){if("esriGeometryPoint"===a)return function(a){a.x=c(a.x);a.y=g(a.y)};if("esriGeometryPolyline"===a||"esriGeometryPolygon"===a)return function(a){a=a.rings||a.paths;var k,h,b,e,q,r,d,s;k=0;for(h=a.length;k<h;k++){q=a[k];b=0;for(e=q.length;b<e;b++)r=q[b],0<b?(d+=r[0],s+=r[1]):(d=r[0],s=r[1]),r[0]=
c(d),r[1]=g(s)}};if("esriGeometryEnvelope"===a)return function(a){a.xmin=c(a.xmin);a.ymin=g(a.ymin);a.xmax=c(a.xmax);a.ymax=g(a.ymax)};if("esriGeometryMultipoint"===a)return function(a){a=a.points;var k,h,b,e,q;k=0;for(h=a.length;k<h;k++)b=a[k],0<k?(e+=b[0],q+=b[1]):(e=b[0],q=b[1]),b[0]=c(e),b[1]=g(q)}}(g,function(a){return a*k+e},function(a){return h-a*d}),a=0,g=b.length;a<g;a++)b[a].geometry&&s(b[a].geometry);this.transform=null},quantize:function(a){if(!this.geometryType)return this.transform=
null,this;var g=a.translate[0],b=a.translate[1],e=a.scale[0],h=a.scale[1],k=this.features,d=function(a,c,g){var k,b,h,e,q,d,r=[];k=0;for(b=a.length;k<b;k++)if(h=a[k],0<k){if(d=c(h[0]),h=g(h[1]),d!==e||h!==q)r.push([d-e,h-q]),e=d,q=h}else e=c(h[0]),q=g(h[1]),r.push([e,q]);return 0<r.length?r:null},s=function(a,c,g){if("esriGeometryPoint"===a)return function(a){a.x=c(a.x);a.y=g(a.y);return a};if("esriGeometryPolyline"===a||"esriGeometryPolygon"===a)return function(a){var k,h,b,e,q;b=a.rings||a.paths;
q=[];k=0;for(h=b.length;k<h;k++)e=b[k],(e=d(e,c,g))&&q.push(e);return 0<q.length?(a.rings?a.rings=q:a.paths=q,a):null};if("esriGeometryMultipoint"===a)return function(a){var k;k=d(a.points,c,g);return 0<k.length?(a.points=k,a):null};if("esriGeometryEnvelope"===a)return function(a){return a}}(this.geometryType,function(a){return Math.round((a-g)/e)},function(a){return Math.round((b-a)/h)}),t,f;t=0;for(f=k.length;t<f;t++)k[t].geometry&&(s(k[t].geometry)||k[t].setGeometry(null));this.transform=a;return this}});
n("extend-esri")&&l.setObject("tasks.FeatureSet",f,p);return f})},"esri/tasks/StatisticDefinition":function(){define(["dojo/_base/declare","dojo/_base/lang","dojo/has","../kernel"],function(f,l,m,n){f=f(null,{declaredClass:"esri.tasks.StatisticDefinition",toJson:function(){return{statisticType:this.statisticType,onStatisticField:this.onStatisticField,outStatisticFieldName:this.outStatisticFieldName,maxPointCount:this.maxPointCount,maxRecordCount:this.maxRecordCount,maxVertexCount:this.maxVertexCount}}});
m("extend-esri")&&l.setObject("tasks.StatisticDefinition",f,n);return f})},"esri/layers/FeatureType":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has ../kernel ../lang ../symbols/jsonUtils ./RangeDomain ./CodedValueDomain ./InheritedDomain ./FeatureTemplate".split(" "),function(f,l,m,n,p,d,u,s,b,e,a){f=f(null,{declaredClass:"esri.layers.FeatureType",constructor:function(c){if(c&&l.isObject(c)){this.id=c.id;this.name=c.name;var g=c.symbol;g&&(this.symbol=u.fromJson(g));
var g=c.domains,q,d=this.domains={};for(q in g)if(g.hasOwnProperty(q)){var h=g[q];switch(h.type){case "range":d[q]=new s(h);break;case "codedValue":d[q]=new b(h);break;case "inherited":d[q]=new e(h)}}if(q=c.templates){g=this.templates=[];for(c=0;c<q.length;c++)g.push(new a(q[c]))}}},toJson:function(){var a={id:this.id,name:this.name,symbol:this.symbol&&this.symbol.toJson()},g,b=this.domains,e=this.templates,h=d.fixJson;if(b){var k=a.domains={};for(g in b)b.hasOwnProperty(g)&&(k[g]=b[g]&&b[g].toJson());
h(k)}e&&(a.templates=m.map(e,function(a){return a.toJson()}));return h(a)}});n("extend-esri")&&l.setObject("layers.FeatureType",f,p);return f})},"esri/layers/FeatureTemplate":function(){define("dojo/_base/declare dojo/_base/lang dojo/has ../kernel ../lang ../graphic".split(" "),function(f,l,m,n,p,d){f=f(null,{declaredClass:"esri.layers.FeatureTemplate",constructor:function(f){f&&l.isObject(f)&&(this.name=f.name,this.description=f.description,this.drawingTool=f.drawingTool,this.thumbnail=f.thumbnail,
f=f.prototype,this.prototype=new d(f.geometry,null,f.attributes))},toJson:function(){return p.fixJson({name:this.name,description:this.description,drawingTool:this.drawingTool,thumbnail:p.fixJson(l.clone(this.thumbnail)),prototype:this.prototype&&this.prototype.toJson()})}});l.mixin(f,{TOOL_AUTO_COMPLETE_POLYGON:"esriFeatureEditToolAutoCompletePolygon",TOOL_CIRCLE:"esriFeatureEditToolCircle",TOOL_ELLIPSE:"esriFeatureEditToolEllipse",TOOL_FREEHAND:"esriFeatureEditToolFreehand",TOOL_LINE:"esriFeatureEditToolLine",
TOOL_NONE:"esriFeatureEditToolNone",TOOL_POINT:"esriFeatureEditToolPoint",TOOL_POLYGON:"esriFeatureEditToolPolygon",TOOL_RECTANGLE:"esriFeatureEditToolRectangle",TOOL_ARROW:"esriFeatureEditToolArrow",TOOL_TRIANGLE:"esriFeatureEditToolTriangle",TOOL_LEFT_ARROW:"esriFeatureEditToolLeftArrow",TOOL_RIGHT_ARROW:"esriFeatureEditToolRightArrow",TOOL_UP_ARROW:"esriFeatureEditToolUpArrow",TOOL_DOWN_ARROW:"esriFeatureEditToolDownArrow"});m("extend-esri")&&l.setObject("layers.FeatureTemplate",f,n);return f})},
"esri/layers/FeatureEditResult":function(){define(["dojo/_base/declare","dojo/_base/lang","dojo/has","../kernel"],function(f,l,m,n){f=f(null,{declaredClass:"esri.layers.FeatureEditResult",constructor:function(f){f&&l.isObject(f)&&(this.objectId=f.objectId,this.success=f.success,f.success||(f=f.error,this.error=Error(),this.error.code=f.code,this.error.message=f.description))}});m("extend-esri")&&l.setObject("layers.FeatureEditResult",f,n);return f})},"esri/layers/SnapshotMode":function(){define("dojo/_base/declare dojo/_base/lang dojo/has ../kernel ../SpatialReference ../tasks/query ./RenderMode".split(" "),
function(f,l,m,n,p,d,u){f=f([u],{declaredClass:"esri.layers._SnapshotMode",constructor:function(d){this.featureLayer=d;this.pagination=d.queryPagination;this._featureMap={};this._hasPartialFeatures=!1;this._drawFeatures=l.hitch(this,this._drawFeatures);this._queryErrorHandler=l.hitch(this,this._queryErrorHandler)},startup:function(){this.pagination=this.pagination&&null!=this.featureLayer.maxRecordCount;this.featureLayer._collection?this._applyTimeFilter():this._fetchAll()},propertyChangeHandler:function(d){this._init&&
(d?this.featureLayer._collection?console.log("FeatureLayer: layer created by value (from a feature collection) does not support definition expressions and time definitions. Layer id \x3d "+this.featureLayer.id):this._fetchAll():this._applyTimeFilter())},drawFeature:function(d){var b=d.attributes[this.featureLayer.objectIdField];this._addFeatureIIf(b,d);this._incRefCount(b)},resume:function(){this.propertyChangeHandler(0)},refresh:function(){var d=this.featureLayer;d._collection?(d._fireUpdateStart(),
d._refresh(!0),d._fireUpdateEnd()):this._fetchAll()},hasAllFeatures:function(){return!this._hasPartialFeatures},_getRequestId:function(d){return("_"+d.name+d.layerId+d._ulid).replace(/[^a-zA-Z0-9\_]+/g,"_")},_fetchAll:function(){var d=this.featureLayer;!d._collection&&!d.suspended&&(d._fireUpdateStart(),this._clearIIf(),this._hasPartialFeatures=!1,this._sendRequest())},_sendRequest:function(f){var b=this.map,e=this.featureLayer,a=e.getDefinitionExpression(),c=new d;c.outFields=e.getOutFields();c.where=
a||"1\x3d1";c.returnGeometry=!0;c.outSpatialReference=new p(b.spatialReference.toJson());c.timeExtent=e.getTimeDefinition();c.maxAllowableOffset=e._maxOffset;c.quantizationParameters=e._quantizationParameters;e._ts&&(c._ts=(new Date).getTime());c.orderByFields=e.supportsAdvancedQueries?e.getOrderByFields():null;c.multipatchOption=e.multipatchOption;this.pagination&&(this._start=c.start=null==f?0:f,c.num=e.maxRecordCount);var g;e._usePatch&&(g=this._getRequestId(e),this._cancelPendingRequest(null,
g));e._task.execute(c,this._drawFeatures,this._queryErrorHandler,g)},_drawFeatures:function(d){this._purgeRequests();var b=d.features,e=this.featureLayer,a=e.objectIdField,c,g=b.length,q=d.exceededTransferLimit&&!e._collection,r=e._selectedFeatures,h=e.mode===e.constructor.MODE_AUTO,k,w,f;e._fireUpdateStart();e._sortFeatures(b);for(c=0;c<g;c++)w=b[c],f=w.attributes[a],k=this._addFeatureIIf(f,w),this._incRefCount(f),h&&(k!==w&&r[f])&&(k.setGeometry(w.geometry),k.setAttributes(w.attributes));this._applyTimeFilter(!0);
if(!this.pagination||!q)this._hasPartialFeatures=!!d.exceededTransferLimit,e._fireUpdateEnd(null,d.exceededTransferLimit?{queryLimitExceeded:!0}:null);q&&(this.pagination&&this._sendRequest(this._start+e.maxRecordCount),e.onQueryLimitExceeded())},_queryErrorHandler:function(d){this._purgeRequests();this._hasPartialFeatures=!0;var b=this.featureLayer;b._errorHandler(d);b._fireUpdateEnd(d)}});m("extend-esri")&&l.setObject("layers._SnapshotMode",f,n);return f})},"esri/layers/RenderMode":function(){define("dojo/_base/kernel dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has dojo/io/script ../kernel".split(" "),
function(f,l,m,n,p,d,u){l=l(null,{declaredClass:"esri.layers._RenderMode",constructor:function(){this._prefix="jsonp_"+(f._scopeName||"dojo")+"IoScript"},initialize:function(d){this.map=d;this._init=!0},startup:function(){},propertyChangeHandler:function(d){},destroy:function(){this._init=!1},drawFeature:function(d){},suspend:function(){},resume:function(){},refresh:function(){},hasAllFeatures:function(){return!0},_incRefCount:function(d){(d=this._featureMap[d])&&d._count++},_decRefCount:function(d){(d=
this._featureMap[d])&&d._count--},_getFeature:function(d){return this._featureMap[d]},_addFeatureIIf:function(d,b){var e=this._featureMap,a=e[d],c=this.featureLayer;a||(e[d]=b,c._add(b),b._count=0);return a||b},_removeFeatureIIf:function(d){var b=this._featureMap[d],e=this.featureLayer;if(b){if(b._count)return;delete this._featureMap[d];e._remove(b)}return b},_clearIIf:function(){var d;d=this.featureLayer;var b=d.graphics,e=d._selectedFeatures,a=d.getSelectedFeatures().length,c=d.objectIdField;if(a)for(d=
b.length-1;0<=d;d--){var a=b[d],g=a.attributes[c];g in e?a._count=1:(a._count=0,this._removeFeatureIIf(g))}else d.clear(),this._featureMap={}},_isPending:function(f){return d[this._prefix+f]?!0:!1},_cancelPendingRequest:function(f,b){if(f=f||d[this._prefix+b])try{f.cancel(),d._validCheck(f)}catch(e){}},_purgeRequests:function(){d._validCheck(null)},_toggleVisibility:function(d){var b=this.featureLayer,e=b.graphics,a=d?"show":"hide",c,g=e.length;d=d&&b._ager;for(c=0;c<g;c++){var q=e[c];q[a]();d&&b._repaint(q)}},
_applyTimeFilter:function(d){var b=this.featureLayer;if(b.timeInfo&&!b.suspended){d||b._fireUpdateStart();var e=b._trackManager;e&&e.clearTracks();var a=b.getTimeDefinition(),c=b._getOffsettedTE(b._mapTimeExtent);c?(c=b._getTimeOverlap(a,c))?(a=b._filterByTime(b.graphics,c.startTime,c.endTime),e&&e.addFeatures(a.match),n.forEach(a.match,function(a){var c=a._shape;a.visible||(a.show(),(c=a._shape)&&c._moveToFront());b._ager&&c&&b._repaint(a)}),n.forEach(a.noMatch,function(a){a.visible&&a.hide()})):
this._toggleVisibility(!1):(e&&e.addFeatures(b.graphics),this._toggleVisibility(!0));e&&(e.moveLatestToFront(),e.drawTracks());d||b._fireUpdateEnd()}}});p("extend-esri")&&m.setObject("layers._RenderMode",l,u);return l})},"esri/layers/OnDemandMode":function(){define("dojo/_base/declare dojo/_base/connect dojo/_base/lang dojo/_base/array dojo/has ../kernel ../geometry/Point ../tasks/query ./RenderMode ./GridLayout".split(" "),function(f,l,m,n,p,d,u,s,b,e){f=f([b],{declaredClass:"esri.layers._OnDemandMode",
constructor:function(a){this.featureLayer=a;this._featureMap={};this._hasPartialFeatures=!1;this._queryErrorHandler=m.hitch(this,this._queryErrorHandler)},initialize:function(a){this.inherited(arguments);var c=this.featureLayer,g=c._srInfo;this._gridLayer=new e(new u(g?g.valid[0]:a.extent.xmin,g?g.valid[1]:a.extent.ymax,a.spatialReference),{width:c._tileWidth,height:c._tileHeight},{width:a.width,height:a.height},g);this._cellMap={};this._gridLayer.setResolution(a.extent)},startup:function(){this._ioQueue=
[];this.featureLayer.suspended||(this._zoomHandler(),this._enableConnectors())},propertyChangeHandler:function(a){this._init&&(2>a?this._zoomHandler():console.log("FeatureLayer: layer in on-demand mode does not support time definitions. Layer id \x3d "+this.featureLayer.id+", Layer URL \x3d "+this.featureLayer.url))},destroy:function(){this._disableConnectors();this.inherited(arguments)},drawFeature:function(a){var c=this._gridLayer,g=a.geometry,b=[];if(g)for(var b=c.getCellsInExtent("point"===g.type?
{xmin:g.x,ymin:g.y,xmax:g.x,ymax:g.y}:g.getExtent(),!1).cells,c=this._cellMap,d,h=a.attributes[this.featureLayer.objectIdField],k,e,f,g=0;g<b.length;g++)d=b[g],k=d.latticeID,e=d.row,f=d.col,k?d=c[k]=c[k]||d:(c[e]=c[e]||{},d=c[e][f]=c[e][f]||d),d.features=d.features||[],d.features.push(a),this._addFeatureIIf(h,a),this._incRefCount(h)},suspend:function(){this._init&&this._disableConnectors()},resume:function(){this._init&&(this._enableConnectors(),this._zoomHandler())},refresh:function(){this._zoomHandler()},
hasAllFeatures:function(){if(this._hasPartialFeatures)return!0;var a=!1,c=this._getCurrentCells(),g;for(g=0;g<c.length;g++)if(c[g].hasPartialFeatures){a=!0;break}return!a},_enableConnectors:function(){var a=this.map;this._zoomConnect=l.connect(a,"onZoomEnd",this,this._zoomHandler);this._panConnect=l.connect(a,"onPanEnd",this,this._panHandler);this._resizeConnect=l.connect(a,"onResize",this,this._panHandler)},_disableConnectors:function(){l.disconnect(this._zoomConnect);l.disconnect(this._panConnect);
l.disconnect(this._resizeConnect)},_zoomHandler:function(){this._processIOQueue(!0);var a=this.featureLayer,c=this.map;a.suspended||(a._fireUpdateStart(),this._clearIIf(),this._hasPartialFeatures=!1,(a=a._trackManager)&&a.clearTracks(),this._cellMap={},this._gridLayer.setResolution(c.extent),this._sendRequest())},_panHandler:function(a){this.featureLayer._fireUpdateStart();var c=this.featureLayer._resized;a=c?a:null;c&&this._gridLayer.setMapState(a,this.map.width,this.map.height);this._sendRequest(a)},
_getRequestId:function(a,c){return("_"+a.name+a.layerId+a._ulid+"_"+c.resolution+"_"+(c.latticeID||c.row+"_"+c.col)).replace(/[^a-zA-Z0-9\_]+/g,"_")},_sendRequest:function(a){this._exceeds=!1;var c=this.featureLayer,g=this.map;a=a||g.extent;g=this._gridLayer.getCellsInExtent(a,c.latticeTiling).cells;if(!c.isEditable())var b=this._cellMap,g=n.filter(g,function(a){if(a.lattice){if(b[a.latticeID])return!1}else if(b[a.row]&&b[a.row][a.col])return!1;return!0});var d=c.getOutFields(),h=c.getDefinitionExpression(),
k=c._getOffsettedTE(c._mapTimeExtent),e=c.supportsAdvancedQueries?c.getOrderByFields():null,f=c._usePatch,t=this._ioQueue,l,p=this,m=this._drawFeatures,u,x,y;this._pending=this._pending||0;for(l=0;l<g.length;l++){u=g[l];x=new s;x.geometry=u.extent||u.lattice;x.outFields=d;x.where=h;c.latticeTiling&&u.extent&&(x.spatialRelationship=s.SPATIAL_REL_CONTAINS);x.returnGeometry=!0;x.timeExtent=k;c._ts&&(x._ts=(new Date).getTime());x.orderByFields=e;x.multipatchOption=c.multipatchOption;x.maxAllowableOffset=
c._maxOffset;x.quantizationParameters=c._quantizationParameters;if((y=c.advancedQueryCapabilities)&&y.supportsQueryWithResultType)x.resultType="tile";y=null;if(f&&(y=this._getRequestId(c,u),this._isPending(y)))continue;this._pending++;t.push(c._task.execute(x,function(){var a=u;return function(c){m.apply(p,[c,a])}}.call(this),this._queryErrorHandler,y))}this._removeOldCells(a);this._endCheck()},_drawFeatures:function(a,c){c.hasPartialFeatures=!!a.exceededTransferLimit;this._exceeds=this._exceeds||
a.exceededTransferLimit;this._finalizeIO();var g=this.featureLayer,b=this.map.extent,d=c.extent,h=c.row,k=c.col,e=g.objectIdField,f=a.features,t=this._gridLayer,l=this._cellMap,p=c.latticeID,m=p?l[p]:l[h]&&l[h][k];if(c.resolution!=t._resolution||(p?p!==t.getLatticeID(b):!t.intersects(d,b)))m&&this._removeCell(h,k,p);else if(m)g._sortFeatures(f),this._updateCell(m,f);else{g._sortFeatures(f);c.features=f;p?l[p]=c:(l[h]=l[h]||{},l[h][k]=c);b=f.length;for(g=0;g<b;g++)d=f[g],h=d.attributes[e],this._addFeatureIIf(h,
d),this._incRefCount(h)}this._endCheck()},_queryErrorHandler:function(a){this._finalizeIO();this._hasPartialFeatures=!0;this.featureLayer._errorHandler(a);this._endCheck(!0)},_finalizeIO:function(){this._purgeRequests();this._pending--},_endCheck:function(a){if(0===this._pending){this._processIOQueue();var c=this.featureLayer,b=c._trackManager;b&&(b.clearTracks(),b.addFeatures(c.graphics),c._ager&&n.forEach(c.graphics,function(a){a._shape&&c._repaint(a)}),b.moveLatestToFront(),b.drawTracks());this.featureLayer._fireUpdateEnd(a&&
Error("FeatureLayer: an error occurred while updating the layer"),this._exceeds?{queryLimitExceeded:!0}:null);if(this._exceeds)c.onQueryLimitExceeded()}},_processIOQueue:function(a){this._ioQueue=n.filter(this._ioQueue,function(a){return-1<a.fired?!1:!0});a&&n.forEach(this._ioQueue,this._cancelPendingRequest)},_getCurrentCells:function(a){var c=[];a=a||this._cellMap;for(var b in a)if(a.hasOwnProperty(b)){var d=a[b];d&&(d.hasOwnProperty("row")||d.hasOwnProperty("latticeID")?c.push(d):"object"===typeof d&&
c.push.apply(c,this._getCurrentCells(d)))}return c},_removeOldCells:function(a){var c=this._cellMap,b=this._gridLayer,d,e;for(d in c)if(c[d]){var h=c[d],k=h.latticeID,f=0,l=0;if(k)f++,k!==b.getLatticeID(a)&&(this._removeCell(null,null,k),l++);else for(e in h)h[e]&&(f++,b.intersects(h[e].extent,a)||(this._removeCell(d,e),l++));l===f&&delete c[d]}},_updateCell:function(a,c){var b=this.featureLayer,d=b.objectIdField,b=b._selectedFeatures,e,h=c.length;a.features=a.features||[];for(e=0;e<h;e++){var k=
c[e],f=k.attributes[d],l=this._addFeatureIIf(f,k);l===k?(this._incRefCount(f),a.features.push(l)):f in b||(l.setGeometry(k.geometry),l.setAttributes(k.attributes))}},_removeCell:function(a,c,b){var d=this._cellMap,e=this.featureLayer,h=e.objectIdField,k=b?d[b]:d[a]&&d[a][c];if(k){b?delete d[b]:delete d[a][c];a=k.features;for(c=0;c<a.length;c++)b=a[c].attributes[h],this._decRefCount(b),b in e._selectedFeatures||this._removeFeatureIIf(b)}}});p("extend-esri")&&m.setObject("layers._OnDemandMode",f,d);
return f})},"esri/layers/GridLayout":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has ../kernel ../SpatialReference ../geometry/Extent ../geometry/Polyline".split(" "),function(f,l,m,n,p,d,u,s){f=f(null,{declaredClass:"esri.layers._GridLayout",constructor:function(b,d,a,c){this.origin=b;this.cellWidth=d.width;this.cellHeight=d.height;this.mapWidth=a.width;this.mapHeight=a.height;this.srInfo=c},setResolution:function(b){this._resolution=(b.xmax-b.xmin)/this.mapWidth;
this.srInfo&&(b=Math.round(2*this.srInfo.valid[1]/this._resolution),b=Math.round(b/this.cellWidth),this._frameStats=[b,0,b-1])},setMapState:function(b,d,a){this.mapWidth=d;this.mapHeight=a;this.setResolution(b)},getCellCoordinates:function(b){var d=this._resolution,a=this.origin;return{row:Math.floor((a.y-b.y)/(this.cellHeight*d)),col:Math.floor((b.x-a.x)/(this.cellWidth*d))}},normalize:function(b){var d=this._frameStats;if(d){var a=d[0],c=d[1],d=d[2];b<c?(b%=a,b=b<c?b+a:b):b>d&&(b%=a)}return b},
intersects:function(b,d){var a=this.srInfo;return a?m.some(d._getParts(a),function(a){return b.intersects(a.extent)}):b.intersects(d)},getCellExtent:function(b,e){var a=this._resolution,c=this.origin,g=this.cellWidth,f=this.cellHeight;return new u(e*g*a+c.x,c.y-(b+1)*f*a,(e+1)*g*a+c.x,c.y-b*f*a,new d(c.spatialReference.toJson()))},getLatticeID:function(b){var d=this.getCellCoordinates({x:b.xmin,y:b.ymax}),a=this.getCellCoordinates({x:b.xmax,y:b.ymin});b=d.row;var c=a.row,d=this.normalize(d.col),a=
this.normalize(a.col);return b+"_"+c+"_"+d+"_"+a},sorter:function(b,d){return b<d?-1:1},getCellsInExtent:function(b,d){var a=this.getCellCoordinates({x:b.xmin,y:b.ymax}),c=this.getCellCoordinates({x:b.xmax,y:b.ymin}),g=a.row,f=c.row,a=a.col,c=c.col,r=[],h,k,w,l=[],t=[],p,n,u,D,x=[];for(h=g;h<=f;h++)for(k=a;k<=c;k++)w=this.normalize(k),b=this.getCellExtent(h,w),m.some(r,function(a){return a.row===h&&a.col===w})||r.push({row:h,col:w,extent:b,resolution:this._resolution}),d&&(l.push(b.xmin,b.xmax),t.push(b.ymin,
b.ymax));a=this.normalize(a);c=this.normalize(c);l.sort(this.sorter);t.sort(this.sorter);k=l.length;for(h=k-1;0<=h;h--)h<k-1&&l[h]===l[h+1]&&l.splice(h,1);k=t.length;for(h=k-1;0<=h;h--)h<k-1&&t[h]===t[h+1]&&t.splice(h,1);if(l.length&&t.length){p=l[0];n=l[l.length-1];u=t[0];D=t[t.length-1];k=l.length;for(h=0;h<k;h++)x.push([[l[h],D],[l[h],u]]);k=t.length;for(h=0;h<k;h++)x.push([[p,t[h]],[n,t[h]]]);l=new s({paths:x,spatialReference:this.origin.spatialReference.toJson()});r.push({latticeID:g+"_"+f+"_"+
a+"_"+c,lattice:l,resolution:this._resolution})}return{minRow:g,maxRow:f,minCol:a,maxCol:c,cells:r}}});n("extend-esri")&&l.setObject("layers._GridLayout",f,p);return f})},"esri/layers/SelectionMode":function(){define(["dojo/_base/declare","dojo/_base/lang","dojo/has","../kernel","./RenderMode"],function(f,l,m,n,p){f=f([p],{declaredClass:"esri.layers._SelectionMode",constructor:function(d){this.featureLayer=d;this._featureMap={}},propertyChangeHandler:function(d){this._init&&0===d&&this._applyTimeFilter()},
resume:function(){this.propertyChangeHandler(0)},hasAllFeatures:function(){return!this.featureLayer._hasPartialSelectedFeatures}});m("extend-esri")&&l.setObject("layers._SelectionMode",f,n);return f})},"esri/layers/StreamMode":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has ../kernel ../SpatialReference ../tasks/query ../tasks/QueryTask ../geometry/jsonUtils ./RenderMode".split(" "),function(f,l,m,n,p,d,u,s,b,e){f=f([e],{declaredClass:"esri.layers._StreamMode",constructor:function(a,
c){this.featureLayer=a;this._featureMap={};this._setRefreshRate();this._drawBuffer={adds:[],updates:[]};this._timeoutId=null;this._flushDrawBuffer=l.hitch(this,this._flushDrawBuffer);this._featuresByTime={};this._lastEndTimeCheck=null;this._maxFeatureAge=0;a.purgeOptions&&(a.purgeOptions.age&&"number"===typeof a.purgeOptions.age)&&(this._maxFeatureAge=1E3*Math.ceil(60*a.purgeOptions.age));this._drawFeatures=l.hitch(this,this._drawFeatures);this._queryErrorHandler=l.hitch(this,this._queryErrorHandler)},
startup:function(){},propertyChangeHandler:function(a){this._init&&(0===a?this._applyTimeFilter():3===a?this._redrawAllTracks():console.debug("StreamLayer: Stream Layer only supports changing map time or maximumTrackPoints. Layer id \x3d "+this.featureLayer.id))},destroy:function(){this.inherited(arguments);clearTimeout(this._timeoutId);this._featuresByTime=this._drawBuffer=this._featureMap=null},drawFeature:function(a){var c=this.featureLayer,b=c.objectIdField;this._timeoutId||(this._timeoutId=setTimeout(this._flushDrawBuffer,
this._refreshRate));c._joinField&&this._getFeature(a.attributes[b])?this._drawBuffer.updates.push({oid:a.attributes[b],updates:a}):this._drawBuffer.adds.push(a)},resume:function(){this.propertyChangeHandler(0)},refresh:function(){var a=this.featureLayer;a&&(!a._relatedUrl&&!a._keepLatestUrl?(a._fireUpdateStart(),a.clear(),a._fireUpdateEnd()):(a._fireUpdateStart(),a._refreshing=!0,a.disconnect(),a.clear(),a._relatedQueried=!1,a._keepLatestQueried=!1,a.connect()))},_drawFeatures:function(a,c){this._purgeRequests();
var b=this.featureLayer;b._create(a.features||[]);b._fireUpdateEnd(null,c)},_applyTimeFilter:function(a){this.inherited(arguments);this._redrawAllTracks()},_removeFeatures:function(a){var c=this.featureLayer,b=c.objectIdField;a&&m.forEach(a,function(a){a=a.attributes[b];c._unSelectFeatureIIf(a,this);this._decRefCount(a);this._removeFeatureIIf(a)},this)},_addFeatures:function(a){var c=this.featureLayer,b=c._endTimeField,d=c._startTimeField,e,h,k,f=[],l=[],t=[];e=c._trackManager;h=c.objectIdField;if(e)for(k in a=
e.addFeatures(a),a)a.hasOwnProperty(k)&&(f.push(k),a[k].adds&&(l=l.concat(a[k].adds)),a[k].deletes&&(t=t.concat(a[k].deletes)));else l=a;m.forEach(l,function(a){var c=a.attributes[h],k;k=b&&a.attributes[b];!k&&this._maxFeatureAge&&(k=d&&a.attributes[d]?a.attributes[d]+this._maxFeatureAge:Date.now()+this._maxFeatureAge);k&&(k=1E3*Math.ceil(k/1E3),this._featuresByTime[k]?this._featuresByTime[k].push(c):this._featuresByTime[k]=[c]);this._addFeatureIIf(c,a);this._incRefCount(c)},this);t.length&&this._removeFeatures(t);
e&&e.refreshTracks(f)},_updateFeatures:function(a){var c=this.featureLayer,b,d,e=[];b=c._trackManager;d=c._trackIdField;m.forEach(a,function(a){var k=a.updates;a=this._getFeature(a.oid);var f;if(a){k.geometry&&a.setGeometry(k.geometry);k=k.attributes||{};for(f in k)k.hasOwnProperty(f)&&(a.attributes[f]=k[f]);a.visible=this._checkFeatureTimeIntersects(a);b&&a.attributes[d]?e.push(a.attributes[d]):c._repaint(a,null,!0)}},this);e.length&&b.refreshTracks(e)},_redrawAllTracks:function(){var a=this.featureLayer._trackManager,
c;if(a&&(c=a.trimTracks())&&0<c.length)this._removeFeatures(c),a.refreshTracks()},_flushDrawBuffer:function(){clearTimeout(this._timeoutId);var a=this._drawBuffer,c=a.adds.splice(0,a.adds.length),b=a.updates.splice(0,a.updates.length),a=this.featureLayer;if(!a)return!1;a.updating||a._fireUpdateStart();this._addFeatures(c);this._updateFeatures(b);if((c=this._getExpiredFeatures())&&c.length)this._removeFeatures(c),a._trackManager&&a._trackManager.removeFeatures(c);a._purge();a._fireUpdateEnd();this._timeoutId=
null},_clearDrawBuffer:function(){var a=this._timeoutId,c=this._drawBuffer,b=c.adds,c=c.updates;a&&clearTimeout(a);b.splice(0,b.length);c.splice(0,c.length);this._timeoutId=null},_clearTimeBin:function(){this._featuresByTime={};this._lastEndTimeCheck=1E3*Math.ceil(Date.now()/1E3)},_clearFeatureMap:function(){this._featureMap={}},_setRefreshRate:function(a){a=a||0===a?a:200;0>a&&(a=200);this._refreshRate=a},_checkFeatureTimeIntersects:function(a){var c=this.featureLayer,b=c.getMap(),b=b?b.timeExtent:
null;return!b||!c.timeInfo||!c.timeInfo.startTimeField&&!c.timeInfo.endTimeField?!0:0<c._filterByTime([a],b.startTime,b.endTime).match.length},_getRequestId:function(a){return("_"+a.name+a.layerId+a._ulid).replace(/[^a-zA-Z0-9\_]+/g,"_")},_fetchArchive:function(a){function c(a){t++;l.execute(h).then(function(c){a(null,c)},function(c){a(c)})}function e(a,b){if(a)t>=m||!f._relatedUrl?n._queryErrorHandler(Error("Could not get features from related feature service")):(F={relatedFeatureWarning:"Querying related feature service using the current filter failed. All related features are displayed, and the filter is applied to the stream service only"},
h.where="1\x3d1",c(e));else{var d=n._fixFieldNameCasing(f,b);b.features=d;n._drawFeatures(b,F)}}var f=this.featureLayer,l,h,k,w,p;f._fireUpdateStart();if(a&&this.map){l=new s(a);h=new u;a=this.map;k=f.getFilter()||{};w=k.where||"1\x3d1";p=k.geometry?b.fromJson(k.geometry):null;k=k.outFields?k.outFields.split(","):["*"];h.geometry=p;h.where=w;h.outFields=k;h.returnGeometry=!0;h.outSpatialReference=new d(a.spatialReference.toJson());f._usePatch&&(a=this._getRequestId(f),this._cancelPendingRequest(null,
a));var t=0,m=2,n=this,F=null;c(e)}else return this._fireUpdateEnd({error:"Archive data cannot be fetched if no feature service url is provided or if the layer is not added to a map"}),!1},_queryErrorHandler:function(a){this._purgeRequests();var c=this.featureLayer;c._errorHandler(a);c._fireUpdateEnd(a)},_fixFieldNameCasing:function(a,c){var b=c.features||[],d=c.fields;if(!d||!b.length)return b;for(var d=this._mapFieldNameDifferences(a.fields,d),e=[],h,k,f=0,l=c.features.length;f<l;f++)h=b[f],k=this._swizzleResponseAttributes(h.attributes,
d),e.push({geometry:h.geometry,attributes:k});return e},_mapFieldNameDifferences:function(a,c){var b=[],d={},e,h;e=0;for(h=c.length;e<h;e++)b.push(c[e].name);e=0;for(h=a.length;e<h;e++){var k=a[e].name,f=this._checkForStreamFieldName(k,b);f&&(d[f]=k)}return d},_checkForStreamFieldName:function(a,c){for(var b=a.toLowerCase(),d,e=0,h=c.length;e<h;e++)if(c[e].toLowerCase()===b){d=c[e];break}return d},_swizzleResponseAttributes:function(a,c){var b={},d;for(d in a)if(a.hasOwnProperty(d)){var e=a[d];c.hasOwnProperty(d)?
b[c[d]]=e:b[d]=e}return b},_getExpiredFeatures:function(){var a,b,d,e=[],f=[];if(!this.featureLayer._endTimeField&&!this._maxFeatureAge)return f;a=1E3*Math.floor(this._lastEndTimeCheck/1E3);this._lastEndTimeCheck=b=1E3*Math.ceil(Date.now()/1E3);if(a&&a!==b)for(d=this._featuresByTime;a<=b;a+=1E3)d[a]&&(e=e.concat(d[a]),delete d[a]);m.forEach(e,function(a){(a=this._getFeature(a))&&f.push(a)},this);return f}});n("extend-esri")&&l.setObject("layers._StreamMode",f,p);return f})},"esri/layers/TrackManager":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has ../kernel ../graphic ../geometry/Polyline ./GraphicsLayer".split(" "),
function(f,l,m,n,p,d,u,s){f=f(null,{declaredClass:"esri.layers._TrackManager",constructor:function(b){this.layer=b;this.trackMap={};this.trackLineMap={}},initialize:function(b){this.map=b;var d=this.layer,a=d._getRenderer(),a=a&&a.trackRenderer;if("esriGeometryPoint"===d.geometryType){var c=this.container=new s._GraphicsLayer({id:d.id+"_tracks",_child:!0,visible:d.visible,minScale:d.minScale,maxScale:d.maxScale});c.loaded=!0;c.onLoad(c);c._setMap(b,d._div);c.setRenderer(a);d.on("visibility-change",
l.hitch(this,function(a){this.container.setVisibility(a.visible);this.container.evaluateSuspension()}));d.on("scale-range-change",l.hitch(this,function(){this.container.setScaleRange(this.layer.minScale,this.layer.maxScale)}))}},addFeatures:function(b){var d=this.trackMap,a=this.layer,c=a._trackIdField,g=[];m.forEach(b,function(a){var b=a.attributes[c];(d[b]=d[b]||[]).push(a);-1===m.indexOf(g,b)&&g.push(b)});var f=a._startTimeField,l=a.objectIdField,h=function(a,b){var d=a.attributes[f],c=b.attributes[f];
return d===c?a.attributes[l]<b.attributes[l]?-1:1:d<c?-1:1};m.forEach(g,function(a){d[a].sort(h)})},trimTracks:function(b){function d(b){for(b=a[b]||[];b.length>c;)f.push(b.shift())}var a=this.trackMap,c=this.layer.maximumTrackPoints||0,f=[],l;if(!c)return f;if(b)m.forEach(b,function(a){d(a)});else for(l in a)a.hasOwnProperty(l)&&d(l);return f},drawTracks:function(b){function e(b){var h=f[b],e,t,m;t=a.trackLineMap[b];c.remove(t);delete a.trackLineMap[b];if(!h||2>h.length)return!1;t=[];for(e=h.length-
1;0<=e;e--)(m=h[e].geometry)&&t.push([m.x,m.y]);h={};h[p]=b;1<t.length&&(t=new d(new u({paths:[t],spatialReference:l}),null,h),c.add(t),a.trackLineMap[b]=t)}var a=this,c=this.container,f,l,p,h;if(c)if(f=this.trackMap,l=this.map.spatialReference,p=this.layer._trackIdField,b)m.forEach(b,function(a){e(a)});else for(h in f)f.hasOwnProperty(h)&&e(h)},refreshTracks:function(b){function d(b){var k,e;a.drawTracks([b]);if(l&&l.latestObservationRenderer){b=c[b]||[];k=b.length;for(e=0;e<k;e++)f._repaint(b[e],
null,!0)}}var a=this,c=this.trackMap,f=this.layer,l=f._getRenderer(),p;if(b)m.forEach(b,function(a){d(a)});else for(p in c)c.hasOwnProperty(p)&&d(p);this.moveLatestToFront()},moveLatestToFront:function(b){m.forEach(this.getLatestObservations(b),function(b){var a=b._shape;a&&a._moveToFront();this._repaint(b,null,!0)},this.layer)},getLatestObservations:function(b){function d(a){a=f[a];return a[a.length-1]}var a=[],c=this.layer._getRenderer(),f=this.trackMap,l;if(!c.latestObservationRenderer)return a;
if(b)m.forEach(b,function(b){a.push(d(b))});else for(l in f)f.hasOwnProperty(l)&&a.push(d(l));return a},clearTracks:function(b){var d=this.getLatestObservations(b),a=this.container,c;b?m.forEach(b,function(b){delete this.trackMap[b];a&&(c=this.trackLineMap[b],a.remove(c),delete this.trackLineMap[b])},this):(this.trackMap={},this.trackLineMap={},a&&a.clear());m.forEach(d,function(a){this._repaint(a,null,!0)},this.layer)},isLatestObservation:function(b){var d=this.trackMap[b.attributes[this.layer._trackIdField]];
return d?d[d.length-1]===b:!1},destroy:function(){var b=this.container;b&&(b.clear(),b._unsetMap(this.map,this.layer._div));this.map=this.layer=this.trackMap=this.container=null}});n("extend-esri")&&l.setObject("layers._TrackManager",f,p);return f})},"esri/layers/HeatmapManager":function(){define("dojo/_base/declare dojo/_base/lang dojo/aspect dojo/_base/array require ../kernel ../sniff ../geometry/Point ../geometry/webMercatorUtils ./MapImage ../renderers/HeatmapRenderer ../tasks/query dojo/_base/fx".split(" "),
function(f,l,m,n,p,d,u,s,b,e,a,c,g){function q(){}function r(a){var b=a.layer;return{geometry:a.geometry,attributes:a.attributes,getLayer:function(){return b}}}f=f(null,{declaredClass:"esri.layers.HeatmapManager",heatmapRenderer:null,sourceLayer:null,imageLayer:null,useTiles:!0,useWorker:!1,map:null,constructor:function(a){this.sourceLayer=a;this._hndls=[]},initialize:function(b){this.map=b;var d=this.sourceLayer,c=d.renderer;d.setDrawMode(!1);this.imageLayer=b._getMapImageLyr();var e=this;this.heatmapRenderer=
c instanceof a?c:(c.getRendererInfoByZoom(b.getZoom())||c.getRendererInfoByScale(b.getScale())).renderer;this._setupDraw=this._setupDraw.bind(this);this.recalculateHeatmap=this.recalculateHeatmap.bind(this);this._removeRenderer=this._removeRenderer.bind(this);this._handleRendererChange=this._handleRendererChange.bind(this);this._rendererChangeHandle=this.sourceLayer.on("renderer-change",this._handleRendererChange);this._handleOpacityChange=this._handleOpacityChange.bind(this);this._reprojectFeature=
this._reprojectFeature.bind(this);p(["../workers/heatmapCalculator"],function(a){e._calculator=new a(l.mixin({width:e.map.width,height:e.map.height},e._getOptions()));e._setupRenderer();e.heatmapRenderer.getStats=a.calculateStats;e.heatmapRenderer.getHistogramData=a.getHistogramData})},destroy:function(){this._removeHandlers();this._rendererChangeHandle&&this._rendererChangeHandle.remove();this._rendererChangeHandle=this.sourceLayer=this.imageLayer=this.map=this.heatmapRenderer=this._hndls=null},
_handleRendererChange:function(b){var d=b.renderer,c=d instanceof a;this.heatmapRenderer?c?this.heatmapRenderer=d:this._removeRenderer(b):c&&(this.heatmapRenderer=d,this.sourceLayer&&this.map&&this._setupRenderer())},_handleOpacityChange:function(a){a=a.opacity;var b=this._getImageBySourceId(this.sourceLayer.id);b&&b.setOpacity(a)},_setupRenderer:function(){var a=this._hndls,b=this.sourceLayer,d=this.map,c=this;b._originalDraw=b._draw;b._draw=q;b._div.clear();clearTimeout(this._resetTimer);this._resetTimer=
setTimeout(this._resetGraphics.bind(this),250);a.push(b.on("update-end",this._setupDraw));a.push(b.on("suspend",function(a){(a=c._getImageBySourceId(c.sourceLayer.id))&&a.hide()}));a.push(b.on("resume",function(a){(a=c._getImageBySourceId(c.sourceLayer.id))&&a.show()}));a.push(m.after(b,"redraw",this._setupDraw));a.push(d.on("layer-remove",function(a){a.layer==b&&((a=c._getImageBySourceId(c.sourceLayer.id))&&c.imageLayer.removeImage(a),c._removeRenderer({target:b}))}));b._collection&&a.push(b.on("graphic-add",
function(a){c._reprojectFeature(a.graphic);c._setupDraw()}));1!==b.mode&&(a.push(d.on("resize, pan-end",this._setupDraw)),a.push(d.on("zoom-end",this._setupDraw)));a.push(b.on("opacity-change",this._handleOpacityChange));this.imageLayer.suspended&&this.imageLayer.resume();b.graphics&&b.graphics.length&&(b.graphics[0].geometry&&!d.spatialReference.equals(b.graphics[0].geometry.spatialReference)&&n.forEach(b.graphics,function(a){this._reprojectFeature(a)}.bind(this)),this._setupDraw())},_setupDraw:function(){if(!this._drawTimer){var b=
this;this._drawTimer=setTimeout(function(){clearTimeout(b._drawTimer);b._drawTimer=null;b.sourceLayer._getRenderer().isInstanceOf(a)&&b.recalculateHeatmap()},16)}},_removeRenderer:function(a){var b=a.target;b._draw=b._originalDraw;delete b._originalDraw;b.setDrawMode(!0);this._removeHandlers();this._hndls=[];var d=this._getImageBySourceId(this.sourceLayer.id);d&&this.imageLayer.removeImage(d);clearTimeout(this._drawTimer);clearTimeout(this._resetTimer);this._drawTimer=this._resetTimer=null;b.renderer!=
a.renderer&&b.renderer.getRendererInfo?this.heatmapRenderer=null:(b.redraw(),this.destroy())},recalculateHeatmap:function(){this._calculator?this._doMainCalculation():this._calculatorClient&&this._doWorkerCalculation()},_reprojectFeature:function(a){if(a&&a.geometry){var d=a.geometry,c=this.map.spatialReference;c.equals(d.spatialReference)||(d=b.project(d,c),null==d?console.log("Unable to reproject features to map's spatial reference. Please convert feature geometry before adding to layer"):a.geometry=
d)}},_doWorkerCalculation:function(){},_doMainCalculation:function(){var a=this.sourceLayer,b=this.map,d=this.heatmapRenderer,f=this.map.extent,g=this.map.width,p=this.map.height,m=this._calculator,q=this,n=function(c){c=q._getScreenPoints(c.features,b,a);c=m.calculateImageData(l.mixin({screenPoints:c,mapinfo:{extent:[f.xmin,f.ymin,f.xmax,f.ymax],resolution:b.getResolution()},width:g,height:p},q._getOptions()));c=d.getSymbol(r({geometry:b.extent,attributes:{size:[g,p],imageData:c},layer:a}));c=new e({extent:b.extent,
href:c.url,opacity:0,sourceId:a.id});q._swapMapImages(c,q._getImageBySourceId(a.id));a.suspended&&c.hide()},s={geometry:b.extent,timeExtent:a.useMapTime?b.timeExtent:void 0,spatialRelationship:c.SPATIAL_REL_INTERSECTS};null!=a._canDoClientSideQuery(s)?a.queryFeatures(s,n):n({features:a.graphics})},_getScreenPoints:function(a,b,d){var c=[],e=a.length,f=0,g=0,l,p=new s(b.extent.xmin,b.extent.ymax,b.spatialReference),m=b.toScreen(p),q=m.x,m=m.y,u=b.getResolution(),r;for((g=b.extent.getCacheValue("_parts"))&&
(r=n.map(g,function(a){return d._intersects(b,a.extent)[0]}));e--;)g=a[e],g.geometry&&(l={x:Math.ceil((g.geometry.x-p.x)/u+q),y:Math.floor((p.y-g.geometry.y)/u-m),attributes:g.attributes},r&&(g=1<r.length&&l.x<-r[0]?r[1]:r[0],l.x+=g),c[f++]=l);return c},_getImageBySourceId:function(a){var b=this.imageLayer.getImages(),b=n.filter(b,function(b){return b.sourceId==a});if(b.length)return b[b.length-1]},_swapMapImages:function(a,b){function d(){c.removeImage(b)}var c=this.imageLayer,e=this.sourceLayer.opacity||
1;c.addImage(a);g.anim(a._node,{opacity:e},null,null,function(){a.opacity=e});null!=b&&g.anim(b._node,{opacity:0},null,null,d)},_removeHandlers:function(){if(null!=this._hndls)for(var a=this._hndls.length;a--;)this._hndls[a].remove()},_getOptions:function(){var a=this.heatmapRenderer;return{blurRadius:a.blurRadius,gradient:a.gradient,maxPixelIntensity:a.maxPixelIntensity,minPixelIntensity:a.minPixelIntensity,field:a.field,fieldOffset:a.fieldOffset}},_resetGraphics:function(){clearTimeout(this._resetTimer);
this._resetTimer=null;for(var a=this.sourceLayer.graphics,b=a.length,d;b--;)d=a[b],d._shape=d._offsets=void 0}});u("extend-esri")&&l.setObject("layers.HeatmapManager",f,d);return f})},"*noref":1}});
define("esri/layers/FeatureLayer","require module dojo/_base/declare dojo/_base/connect dojo/_base/lang dojo/_base/array dojo/_base/json dojo/_base/Deferred dojo/date/locale dojo/sniff dojo/io-query dojo/dom-construct dojo/i18n dojo/when dojo/promise/all ../kernel ../lang ../request ../config ../deferredUtils ../SpatialReference ../symbols/SimpleMarkerSymbol ../symbols/SimpleLineSymbol ../symbols/SimpleFillSymbol ../symbols/jsonUtils ../renderers/SimpleRenderer ../renderers/UniqueValueRenderer ../renderers/jsonUtils ../tasks/QueryTask ../tasks/query ../tasks/FeatureSet ../tasks/StatisticDefinition ../geometry/Extent ../geometry/jsonUtils ../geometry/normalizeUtils ../geometry/scaleUtils ./GraphicsLayer ./Field ./TimeInfo ./FeatureType ./FeatureTemplate ./FeatureEditResult ./LabelClass ./SnapshotMode ./OnDemandMode ./SelectionMode ./StreamMode ./TrackManager ./HeatmapManager dojo/i18n!../nls/jsapi dojo/has!extend-esri?./agscommon".split(" "),function(f,
l,m,n,p,d,u,s,b,e,a,c,g,q,r,h,k,w,O,t,I,P,F,D,x,y,Q,R,S,J,G,T,L,U,V,W,X,Y,Z,$,aa,E,ba,K,ca,da,ea,fa,M,ga){var ha=O.defaults,z=m(X,{declaredClass:"esri.layers.FeatureLayer",invalidParams:"query contains one or more unsupported parameters",reHostedFS:/(https?:)?\/\/services.*\.arcgis\.com/i,maxPointCountForAuto:4E3,maxRecordCountForAuto:2E3,maxVertexCountForAuto:25E4,generalizeForScale:4E3,_eventMap:{"add-attachment-complete":["result"],"before-apply-edits":["adds","updates","deletes"],"delete-attachments-complete":["results"],
"edits-complete":["adds","updates","deletes"],"query-attachment-infos-complete":["results"],"query-count-complete":["count"],"query-features-complete":["featureSet"],"query-ids-complete":["objectIds"],"query-related-features-complete":["featureSets"],"selection-complete":["features","method"],"update-end":["error","info"]},constructor:function(a,b){this._preventInit||this._initFeatureLayer(a,b)},_initFeatureLayer:function(a,b){this.i18n=ga;b=b||{};this.showLabels=null!=b.showLabels?b.showLabels:!0;
this._outFields=b.outFields;this._defnExpr=b.definitionExpression;this._loadCallback=b.loadCallback;var d=b._usePatch;this._usePatch=null===d||void 0===d?!0:d;this._trackIdField=b.trackIdField;this.objectIdField=b.objectIdField;this._maxOffset=null!=b.maxAllowableOffset?b.maxAllowableOffset:this.maxAllowableOffset;this.quantize=null!=b.quantize?b.quantize:!0;this._optEditable=b.editable;this._optAutoGen=b.autoGeneralize;this.editSummaryCallback=b.editSummaryCallback;this.userId=b.userId;this.userIsAdmin=
b.userIsAdmin;this.useMapTime=b.hasOwnProperty("useMapTime")?!!b.useMapTime:!0;this.source=b.source;this.gdbVersion=b.gdbVersion;this.orderByFields=b.orderByFields;this.maxPointCountForAuto=null!=b.maxPointCountForAuto?b.maxPointCountForAuto:this.maxPointCountForAuto;this.maxRecordCountForAuto=null!=b.maxRecordCountForAuto?b.maxRecordCountForAuto:this.maxRecordCountForAuto;this.maxVertexCountForAuto=null!=b.maxVertexCountForAuto?b.maxVertexCountForAuto:this.maxVertexCountForAuto;this.generalizeForScale=
null!=b.generalizeForScale?b.generalizeForScale:this.generalizeForScale;this.queryPagination=null!=b.queryPagination?b.queryPagination:this.url?this.reHostedFS.test(this.url):!1;this.multipatchOption=b.multipatchOption;this._selectedFeatures={};this._selectedFeaturesArr=[];this._newFeatures=[];this._deletedFeatures={};this._ulid=this._getUniqueId();var c=z,d=this.mode=k.isDefined(b.mode)?b.mode:c.MODE_ONDEMAND;this._isStream&&(this.mode=d=c.MODE_STREAM);switch(d){case c.MODE_SNAPSHOT:this.currentMode=
c.MODE_SNAPSHOT;this._mode=new K(this);this._isSnapshot=!0;break;case c.MODE_ONDEMAND:case c.MODE_AUTO:this.currentMode=c.MODE_ONDEMAND;this._tileWidth=b.tileWidth||512;this._tileHeight=b.tileHeight||512;this._mode=new ca(this);this.latticeTiling=b.latticeTiling;break;case c.MODE_SELECTION:this.currentMode=c.MODE_SELECTION;this._mode=new da(this);this._isSelOnly=!0;break;case c.MODE_STREAM:this.currentMode=c.MODE_STREAM,this._mode=new ea(this),this._isStream=!0}this._initLayer=p.hitch(this,this._initLayer);
this._selectHandler=p.hitch(this,this._selectHandler);this._editable=!1;if(p.isObject(a)&&a.layerDefinition)return this._collection=!0,this.mode=this._isStream?c.MODE_STREAM:c.MODE_SNAPSHOT,this._initLayer(a),this;this._task=new S(this.url,{source:this.source,gdbVersion:this.gdbVersion});d=this._url.path;this._fserver=!1;-1!==d.search(/\/FeatureServer\//i)&&(this._fserver=!0);this.mode===c.MODE_AUTO&&this.reHostedFS.test(this.url)&&this._queryLimit();(c=b.resourceInfo)?this._initLayer(c):(this.source&&
(c={source:this.source.toJson()},this._url.query=p.mixin(this._url.query,{layer:u.toJson(c)})),this.gdbVersion&&(this._url.query=p.mixin(this._url.query,{gdbVersion:this.gdbVersion})),w({url:d,content:p.mixin({f:"json"},this._url.query),callbackParamName:"callback",load:this._initLayer,error:this._errorHandler}));this.registerConnectEvents()},_initLayer:function(a,b){if(a||b){this._json=a;this._findCredential();if(this.credential&&this.credential.ssl||a&&a._ssl)this._useSSL(),this._task._useSSL();
this.version=a.currentVersion;this.version||(this.version="capabilities"in a||"drawingInfo"in a||"hasAttachments"in a||"htmlPopupType"in a||"relationships"in a||"timeInfo"in a||"typeIdField"in a||"types"in a?10:9.3);this._collection&&(this._isStream||(this.currentMode=z.MODE_SNAPSHOT,this._mode=new K(this)),this._isSnapshot=!0,this._featureSet=a.featureSet,this._nextId=a.nextObjectId,a=a.layerDefinition);this.geometryType=a.geometryType;"string"!==typeof this.multipatchOption&&"esriGeometryMultiPatch"===
this.geometryType&&(this.multipatchOption="xyFootprint");if(a.hasOwnProperty("capabilities")){var c=this.capabilities=a.capabilities;c&&-1!==c.toLowerCase().indexOf("editing")?this._editable=!0:this._editable=!1}else this._collection||(this._editable=this._fserver);k.isDefined(this._optEditable)?(this._editable=this._optEditable,delete this._optEditable):"esriGeometryMultiPatch"===this.geometryType&&(this._editable=!1);this._json=u.toJson(this._json);if(this.isEditable())this._setMaxOffset(null);
else if(this.mode!==z.MODE_SNAPSHOT&&("esriGeometryPolyline"===this.geometryType||"esriGeometryPolygon"===this.geometryType||this.hasXYFootprint()))this._autoGeneralize=k.isDefined(this._optAutoGen)?this._optAutoGen:this.mode===z.MODE_ONDEMAND||this.mode===z.MODE_AUTO,delete this._optAutoGen;var c=a.effectiveMinScale||a.minScale,v=a.effectiveMaxScale||a.maxScale;!this._hasMin&&c&&this.setMinScale(c);!this._hasMax&&v&&this.setMaxScale(v);this.layerId=a.id;this.name=a.name;this.description=a.description;
this.copyright=a.copyrightText;this.type=a.type;this.displayField=a.displayField;this.defaultDefinitionExpression=a.definitionExpression;this.fullExtent=new L(a.extent);this.initialExtent=new L(this.fullExtent.toJson());this.fullExtent.spatialReference&&(this.spatialReference=new I(this.fullExtent.spatialReference.toJson()));this.defaultVisibility=a.defaultVisibility;if("esriGeometryPoint"===this.geometryType||"esriGeometryMultipoint"===this.geometryType)this.latticeTiling=!1;this.hasM=a.hasM||!1;
this.hasZ=a.hasZ||!1;this.indexedFields=a.indexedFields;this.maxRecordCount=a.maxRecordCount;this.canModifyLayer=a.canModifyLayer;this.supportsStatistics=a.supportsStatistics;this.supportsAdvancedQueries=this._collection?!1:a.supportsAdvancedQueries;this.supportsCalculate=a.supportsCalculate;this.supportsAttachmentsByUploadId=a.supportsAttachmentsByUploadId;this.supportsCoordinatesQuantization=a.supportsCoordinatesQuantization;this.quantize=this.quantize&&this.supportsCoordinatesQuantization;this.hasLabels=
a.hasLabels;this.canScaleSymbols=a.canScaleSymbols;this.supportsRollbackOnFailureParameter=this.supportsRollbackOnFailure=a.supportsRollbackOnFailure;this.syncCanReturnChanges=a.syncCanReturnChanges;this.isDataVersioned=a.isDataVersioned;this.editFieldsInfo=a.editFieldsInfo;this.ownershipBasedAccessControlForFeatures=a.ownershipBasedAccessControlForFeatures;this.editFieldsInfo&&this.ownershipBasedAccessControlForFeatures&&(this.creatorField=this.editFieldsInfo.creatorField);this.relationships=a.relationships;
this.allowGeometryUpdates=k.isDefined(a.allowGeometryUpdates)?a.allowGeometryUpdates:!0;this.allowUpdateWithoutMValues=!!a.allowUpdateWithoutMValues;this.advancedQueryCapabilities=a.advancedQueryCapabilities||{supportsStatistics:this.supportsStatistics,supportsOrderBy:this.supportsAdvancedQueries,supportsDistinct:this.supportsAdvancedQueries};this.useStandardizedQueries=a.useStandardizedQueries;this.tileMaxRecordCount=a.tileMaxRecordCount;this.standardMaxRecordCount=a.standardMaxRecordCount;this._setMaxOffset(this._maxOffset,
!0);this._isTable="Table"===this.type;for(var f=this.fields=[],v=a.fields,c=0;c<v.length;c++)f.push(new Y(v[c]));if(!this.objectIdField){this.objectIdField=a.objectIdField;if(!this.objectIdField){v=a.fields;for(c=0;c<v.length;c++)if(f=v[c],"esriFieldTypeOID"===f.type){this.objectIdField=f.name;break}}!this.objectIdField&&!this._isStream&&console.debug("esri.layers.FeatureLayer: "+k.substitute({url:this.url},"objectIdField is not set [url: ${url}]"))}if(!k.isDefined(this._nextId)){v=this.objectIdField;
f=-1;if(this._collection&&v)for(var g=(c=this._featureSet)&&c.features,h=g?g.length:0,l,c=0;c<h;c++)l=(l=g[c].attributes)&&l[v],l>f&&(f=l);this._nextId=f+1}this.globalIdField=a.globalIdField;if(c=this.typeIdField=a.typeIdField)if(c=!this._getField(c)&&this._getField(c,!0))this.typeIdField=c.name;this.visibilityField=a.visibilityField;if(v=a.defaultSymbol)this.defaultSymbol=x.fromJson(v);var H=this.types=[],B=a.types,m,q,f=(c=this.editFieldsInfo)&&c.creatorField,g=c&&c.editorField;l=f||g;h=[];if(B)for(c=
0;c<B.length;c++)m=new $(B[c]),q=m.templates,l&&(q&&q.length)&&(h=h.concat(q)),H.push(m);B=a.templates;m=this.templates=[];if(B)for(c=0;c<B.length;c++)H=new aa(B[c]),l&&h.push(H),m.push(H);for(c=0;c<h.length;c++)if(l=p.getObject("prototype.attributes",!1,h[c]))f&&delete l[f],g&&delete l[g];if(c=a.timeInfo)this.timeInfo=new Z(c),this._startTimeField=c.startTimeField,this._endTimeField=c.endTimeField,this._startTimeField&&this._endTimeField&&(this._twoTimeFields=!0),this._trackIdField?c.trackIdField=
this._trackIdField:this._trackIdField=c.trackIdField;this.hasAttachments=!this._collection&&a.hasAttachments?!0:!1;this.htmlPopupType=a.htmlPopupType;var c=a.drawingInfo,A;if((f=c&&c.labelingInfo)&&!this.labelingInfo)this.labelingInfo=d.map(f,function(a){return new ba(a)}),this._fixLabelExpr();if(!this.renderer)if(c&&c.renderer){if(A=c.renderer,this.setRenderer(R.fromJson(A)),"classBreaks"===A.type&&this.renderer.setMaxInclusive(!0),!this._collection){var n=A.type,v=[];A=this.renderer;switch(n){case "simple":v.push(A.symbol);
break;case "uniqueValue":case "classBreaks":v.push(A.defaultSymbol),v=v.concat(d.map(A.infos,function(a){return a.symbol}))}var v=d.filter(v,k.isDefined),t=this._url.path+"/images/",s=this._getToken();d.forEach(v,function(a){var b=a.url;b&&(-1===b.search(/https?\:/)&&-1===b.indexOf("data:")&&(a.url=t+b),s&&-1!==a.url.search(/https?\:/)&&(a.url+="?token\x3d"+s))})}}else if(v)B=this.types,0<B.length?(A=new Q(this.defaultSymbol,this.typeIdField),d.forEach(B,function(a){A.addValue(a.id,a.symbol)})):A=
new y(this.defaultSymbol),this.setRenderer(A);else if(!this._isTable){switch(this.geometryType){case "esriGeometryPoint":case "esriGeometryMultipoint":n=new P;break;case "esriGeometryPolyline":n=new F;break;case "esriGeometryPolygon":n=new D;break;default:this.hasXYFootprint()&&(n=new D)}this.setRenderer(n?new y(n):null)}n=c&&c.transparency||0;!this.hasOwnProperty("opacity")&&0<n&&(this.opacity=1-n/100);if((e("ie")||7<=e("trident")||e("safari"))&&this.isEditable()&&10.02>this.version)this._ts=!0;
this.statistics=a.statistics;this._fixRendererFields();this._checkFields();this._updateCaps();var r=function(){this.currentMode!==z.MODE_SNAPSHOT&&(this.queryPagination=!1);null!=this._maxOffset&&!this._isFractionalOffsetAllowed()&&this._setMaxOffset(this._maxOffset);this.loaded=!0;this.onLoad(this);var a=this._loadCallback;a&&(delete this._loadCallback,a(this))};this._collection?(n=this._featureSet,this._featureSet=null,this._mode._drawFeatures(new G(n)),this._fcAdded=!0,r.call(this)):this._forceIdentity(this._limitPromise?
function(){var a=this;this._limitPromise.then(function(b){a._checkMode(b)});this._limitPromise.always(function(){a._limitPromise=null;r.call(a)})}:r)}},setShowLabels:function(a){this.showLabels=a;this.onShowLabelsChange()},onShowLabelsChange:function(){},onRendererChange:function(a){this.inherited(arguments);var b=this._map;this._ager=!(!a||!a.observationAger||!a.observationRenderer);a&&"colors"in a&&"blurRadius"in a&&"maxPixelIntensity"in a?"esriGeometryPoint"==this.geometryType&&(!this._heatmapManager&&
b)&&(this._heatmapManager=new M(this),this._heatmapManager.initialize(b)):this.renderer&&this.renderer.getRendererInfo?d.some(this.renderer.rendererInfos,function(a){return a.renderer&&"colors"in a.renderer&&"blurRadius"in a.renderer})||(this._heatmapManager=null):this._heatmapManager=null;if(a){var c=[],b=d.filter([a,a.observationRenderer,a.latestObservationRenderer,a.trackRenderer],k.isDefined),v=function(a){return null!=a&&"function"!=typeof a&&a};d.forEach(b,function(a){var b=v(a.attributeField),
N=v(a.attributeField2);a=v(a.attributeField3);!1!==b&&c.push(b);!1!==N&&c.push(N);!1!==a&&c.push(a)});this._rendererFields=c}else this._rendererFields=[];this.loaded&&(this._fixRendererFields(),this._checkFields(this._rendererFields),this._collection&&(this._typesDirty=!0))},redraw:function(){this.inherited(arguments);this._trackManager&&this._trackManager.container&&this._trackManager.container.redraw()},_evalSDRenderer:function(){this.inherited(arguments);var a=this._getRenderer();this._ager=!(!a||
!a.observationAger||!a.observationRenderer);this._trackManager&&this._trackManager.container&&this._trackManager.container.setRenderer(a&&a.trackRenderer)},_setMap:function(a){var b=this.inherited(arguments),c=this._mode,d=this;c&&c.initialize(a);this.geometryType&&this.attr("data-geometry-type",this.geometryType.replace(/esriGeometry/i,"").toLowerCase());this._addHandle=this.on("graphic-node-add",function(a){a=a.graphic.attributes;(a=d._selectedFeatures[a&&a[d.objectIdField]])&&a.attr("data-selected",
"")});return b},_unsetMap:function(a){var b=this._mode;b&&b.suspend();this._trackManager&&(this._trackManager.destroy(),this._trackManager=null);n.disconnect(this._zoomConnect);n.disconnect(this._addHandle);this._zoomConnect=this._addHandle=null;this._toggleTime(!1);this.inherited("_unsetMap",arguments)},refresh:function(){this._needsRefresh=!1;var a=this._mode;a&&a.refresh()},hasXYFootprint:function(){return"esriGeometryMultiPatch"===this.geometryType&&"xyFootprint"===this.multipatchOption},getOutFields:function(){return d.filter(this._getOutFields(),
function(a){return"*"===a||!!this._getField(a)},this)},getField:function(a){return this._getField(a,!0)},getFieldLabel:function(a){var b=this.infoTemplate,b=b&&b.getFieldInfo&&b.getFieldInfo(a);a=p.isFunction(a)?null:this.getField(a);var c=b||a,d="";c&&(d=b&&b.label||a&&a.alias||c.name||c.fieldName);return d},getDomain:function(a,b){var c,v,e=b&&b.feature,f=e&&this.typeIdField&&e.attributes&&e.attributes[this.typeIdField];null!=f&&d.some(this.types,function(b){if(b.id==f){if((c=b.domains&&b.domains[a])&&
"inherited"===c.type)c=this._getLayerDomain(a),v=!0;return!0}return!1},this);!v&&!c&&(c=this._getLayerDomain(a));return c},_getLayerDomain:function(a){var b;d.some(this.fields,function(c){c.name===a&&(b=c.domain);return!!b});return b},getType:function(a){var b,c=a&&this.typeIdField&&a.attributes&&a.attributes[this.typeIdField];d.some(this.types,function(a){a.id==c&&(b=a);return!!b});return b},setEditable:function(a){if(!this._collection)return console.log("FeatureLayer:setEditable - this functionality is not yet supported for layer in a feature service"),
this;if(!this.loaded)return this._optEditable=a,this;var b=this._editable;this._editable=a;this._updateCaps();if(b!==a)this.onCapabilitiesChange();return this},getEditCapabilities:function(a){var b={canCreate:!1,canUpdate:!1,canDelete:!1};if(!this.loaded||!this.isEditable())return b;var c=a&&a.feature;a=a&&a.userId||this.getUserId();var v=d.map(this.capabilities?this.capabilities.toLowerCase().split(","):[],p.trim),e=(b=-1<d.indexOf(v,"editing"))&&-1<d.indexOf(v,"create"),f=b&&-1<d.indexOf(v,"update"),
v=b&&-1<d.indexOf(v,"delete"),g=this.ownershipBasedAccessControlForFeatures,k=this.editFieldsInfo,h=k&&k.creatorField,k=k&&k.realm,c=(c=c&&c.attributes)&&h?c[h]:void 0,l=!!this.userIsAdmin,h=!g||l||!(!g.allowOthersToUpdate&&!g.allowUpdateToOthers),m=!g||l||!(!g.allowOthersToDelete&&!g.allowDeleteToOthers),n=!g||l||!g.hasOwnProperty("allowAnonymousToUpdate")||g.allowAnonymousToUpdate,g=!g||l||!g.hasOwnProperty("allowAnonymousToDelete")||g.allowAnonymousToDelete;a&&k&&(a=a+"@"+k);if(l||b&&!e&&!f&&!v)e=
f=v=!0;b={canCreate:e,canUpdate:f,canDelete:v};a||(b.canUpdate=b.canUpdate&&n,b.canDelete=b.canDelete&&g);null===c?(b.canUpdate=b.canUpdate&&h,b.canDelete=b.canDelete&&m):""!==c&&(c&&a.toLowerCase()!==c.toLowerCase())&&(b.canUpdate=b.canUpdate&&h,b.canDelete=b.canDelete&&m);return b},getUserId:function(){var a;this.loaded&&(a=this.credential&&this.credential.userId||this.userId||"");return a},setUserIsAdmin:function(a){this.userIsAdmin=a},setEditSummaryCallback:function(a){this.editSummaryCallback=
a},getEditSummary:function(a,b,c){c=k.isDefined(c)?c:(new Date).getTime();var d="";c=this.getEditInfo(a,b,c);(b=b&&b.callback||this.editSummaryCallback)&&(c=b(a,c)||"");if(p.isString(c))d=c;else{if(c){a=c.action;b=c.userId;var e=c.timeValue,f=0;a&&f++;b&&f++;k.isDefined(e)&&f++;1<f&&(d=("edit"===a?"edit":"create")+(b?"User":"")+(k.isDefined(e)?c.displayPattern:""))}d=d&&k.substitute(c,this.i18n.layers.FeatureLayer[d])}return d},getEditInfo:function(a,b,c){if(this.loaded){c=k.isDefined(c)?c:(new Date).getTime();
b=b&&b.action||"last";var d=this.editFieldsInfo,e=d&&d.creatorField,f=d&&d.creationDateField,g=d&&d.editorField,d=d&&d.editDateField,g=(a=a&&a.attributes)&&g?a[g]:void 0,d=a&&d?a[d]:null,e=this._getEditData(a&&e?a[e]:void 0,a&&f?a[f]:null,c);c=this._getEditData(g,d,c);var h;switch(b){case "creation":h=e;break;case "edit":h=c;break;case "last":h=c||e}h&&(h.action=h===c?"edit":"creation");return h}},_getEditData:function(a,c,d){var e,f,g;k.isDefined(c)&&(f=d-c,g=0>f?"Full":6E4>f?"Seconds":12E4>f?"Minute":
36E5>f?"Minutes":72E5>f?"Hour":864E5>f?"Hours":6048E5>f?"WeekDay":"Full");if(void 0!==a||g)e=e||{},e.userId=a,g&&(a=b.format,d=new Date(c),e.minutes=Math.floor(f/6E4),e.hours=Math.floor(f/36E5),e.weekDay=a(d,{datePattern:"EEEE",selector:"date"}),e.formattedDate=a(d,{selector:"date"}),e.formattedTime=a(d,{selector:"time"}),e.displayPattern=g,e.timeValue=c);return e},isEditable:function(){return!(!this._editable&&!this.userIsAdmin)},setMaxAllowableOffset:function(a){this.isEditable()||this._setMaxOffset(a,
!0);return this},getMaxAllowableOffset:function(){var a=this._quantizationParameters?this._quantizationParameters.tolerance:void 0;return null!=this._maxOffset?this._maxOffset:a},_setMaxOffset:function(a,b){if(null==a)return delete this._maxOffset,delete this._quantizationParameters,this;if(this.quantize&&this.supportsCoordinatesQuantization)"esriGeometryPolyline"===this.geometryType?this._maxOffset=a:delete this._maxOffset,this._quantizationParameters={mode:"view",originPosition:"upperLeft",tolerance:a,
extent:this.fullExtent};else{if(!this._isFractionalOffsetAllowed()||!b)a=Math.floor(a);isNaN(a)||0===a?delete this._maxOffset:this._maxOffset=a;delete this._quantizationParameters}return this},_isFractionalOffsetAllowed:function(){return null==this.version||10.1<=this.version||navigator.languages&&this._isLangWithDot(navigator.languages[0])},_isLangWithDot:function(a){a=(a=a&&a.split("-"))&&a[0]&&a[0].toLowerCase();return-1!==d.indexOf(this._langsWithDot,a)},_langsWithDot:"ar en et fr he ja ko th vi zh".split(" "),
setAutoGeneralize:function(a){if(this.loaded){if(!this.isEditable()&&this.mode!==z.MODE_SNAPSHOT&&("esriGeometryPolyline"===this.geometryType||"esriGeometryPolygon"===this.geometryType||this.hasXYFootprint()))(this._autoGeneralize=a)?(this._autoSnapshot&&(this._prevScale=null),this._updateMaxOffset()):this._setMaxOffset(null)}else this._optAutoGen=a;return this},setGDBVersion:function(a){if(!this._collection&&a!==this.gdbVersion&&(a||this.gdbVersion))this.gdbVersion=a,this._task.gdbVersion=a,this._url.query=
p.mixin(this._url.query,{gdbVersion:a}),this.loaded&&(this.clearSelection(),this._map&&this.refresh()),this.onGDBVersionChange();return this},hasAllFeatures:function(){return this._mode?this._mode.hasAllFeatures():!0},setDefinitionExpression:function(a){this._defnExpr=a;(a=this._mode)&&a.propertyChangeHandler(1);return this},getDefinitionExpression:function(){return this._defnExpr},setTimeDefinition:function(a){this._isSnapshot?(this._timeDefn=a,(a=this._mode)&&a.propertyChangeHandler(2)):console.log("FeatureLayer.setTimeDefinition: layer in on-demand or selection mode does not support time definitions. Layer id \x3d "+
this.id+", Layer URL \x3d "+this.url);return this},getTimeDefinition:function(){return this._timeDefn},setTimeOffset:function(a,b){this._timeOffset=a;this._timeOffsetUnits=b;var c=this._mode;c&&c.propertyChangeHandler(0);return this},setUseMapTime:function(a){this.useMapTime=a;this._toggleTime(!this.suspended);(a=this._mode)&&a.propertyChangeHandler(0)},selectFeatures:function(a,b,c,d){b=b||z.SELECTION_NEW;this._hasPartialSelectedFeatures=!1;a=this._getShallowClone(a);var e=this._map,f,g=this,k=t._fixDfd(new s(t._dfdCanceller));
a.outFields=this.getOutFields();a.returnGeometry=!0;a.multipatchOption=this.multipatchOption;e&&(a.outSpatialReference=new I(e.spatialReference.toJson()));if(!this._applyQueryFilters(a,!0))return f={features:[]},this._selectHandler(f,b,c,d,k),k;if(e=this._canDoClientSideQuery(a))k._pendingDfd=q(this._doQuery(a,e)),k._pendingDfd.then(function(a){f={features:a};g._selectHandler(f,b,c,d,k)});else{if(this._collection)return this._resolve([Error("FeatureLayer::selectFeatures - "+this.invalidParams)],null,
d,k,!0),k;var h=this;this._ts&&(a._ts=(new Date).getTime());(k._pendingDfd=this._task.execute(a)).addCallbacks(function(a){h._selectHandler(a,b,c,d,k)},function(a){h._hasPartialSelectedFeatures=!0;h._resolve([a],null,d,k,!0)})}return k},getSelectedFeatures:function(){var a=this._selectedFeatures,b=[],c;for(c in a)a.hasOwnProperty(c)&&b.push(a[c]);return b},clearSelection:function(a){var b=this._selectedFeatures,c=this._mode,d;for(d in b)b.hasOwnProperty(d)&&(this._unSelectFeatureIIf(d,c),c._removeFeatureIIf(d));
this._selectedFeatures={};this._isSelOnly&&c._applyTimeFilter(!0);if(!a)this.onSelectionClear();return this},setSelectionSymbol:function(a){if(this._selectionSymbol=a){var b=this._selectedFeatures,c;for(c in b)b.hasOwnProperty(c)&&b[c].setSymbol(a)}return this},getSelectionSymbol:function(){return this._selectionSymbol},setLabelingInfo:function(a){a?(this.labelingInfo=a,this._fixLabelExpr()):delete this.labelingInfo;this._collection&&(this._typesDirty=!0);this.onLabelingInfoChange()},_fixLabelExpr:function(){var a=
/\[([^\[\]]+)\]/ig,b,c=this,e=function(a,b){var d=c._getField(b,!0);return"["+(d&&d.name||b)+"]"};d.forEach(this.labelingInfo,function(c){if(b=c.labelExpression)c.labelExpression=b.replace(a,e)})},__msigns:[{n:"applyEdits",c:5,a:[{i:0},{i:1}],e:4,f:1}],applyEdits:function(a,b,c,e,f,g){var k=g.assembly,h=g.dfd;this._applyNormalized(a,k&&k[0]);this._applyNormalized(b,k&&k[1]);this.onBeforeApplyEdits(a,b,c);var l={},m=this.objectIdField,k={f:"json"},n=!1;if(this._collection)g={},g.addResults=a?d.map(a,
function(){n=!0;return{objectId:this._nextId++,success:!0}},this):null,g.updateResults=b?d.map(b,function(a){n=!0;var b=a.attributes[m];l[b]=a;return{objectId:b,success:!0}},this):null,g.deleteResults=c?d.map(c,function(a){n=!0;return{objectId:a.attributes[m],success:!0}},this):null,n?this._editHandler(g,a,l,e,f,h):this._resolve([g.addResults,g.updateResults,g.deleteResults],null,e,h);else{a&&0<a.length&&(k.adds=this._convertFeaturesToJson(a,0,1),n=!0);if(b&&0<b.length){for(g=0;g<b.length;g++){var q=
b[g];l[q.attributes[m]]=q}k.updates=this._convertFeaturesToJson(b,0,0,1);n=!0}if(c&&0<c.length){b=[];for(g=0;g<c.length;g++)b.push(c[g].attributes[m]);k.deletes=b.join(",");n=!0}if(n){var A=this;return w({url:this._url.path+"/applyEdits",content:p.mixin(k,this._url.query),callbackParamName:"callback",load:function(b){A._editHandler(b,a,l,e,f,h)},error:function(a){A._resolve([a],null,f,h,!0)}},{usePost:!0})}this._resolve([],null,e,h)}},queryFeatures:function(a,b,c){return this._query("execute","onQueryFeaturesComplete",
a,b,c)},queryRelatedFeatures:function(a,b,c){return this._query("executeRelationshipQuery","onQueryRelatedFeaturesComplete",a,b,c)},queryIds:function(a,b,c){return this._query("executeForIds","onQueryIdsComplete",a,b,c)},queryCount:function(a,b,c){return this._query("executeForCount","onQueryCountComplete",a,b,c)},queryExtent:function(a,b,c){return this._query("executeForExtent","onQueryExtentComplete",a,b,c)},queryAttachmentInfos:function(b,c,e){var f=this._url.path+"/"+b+"/attachments",g=new s(t._dfdCanceller),
k=this;g._pendingDfd=w({url:f,content:p.mixin({f:"json"},this._url.query),callbackParamName:"callback",load:function(e){e=e.attachmentInfos;var h;d.forEach(e,function(c){h=a.objectToQuery({gdbVersion:k._url.query&&k._url.query.gdbVersion,layer:k._url.query&&k._url.query.layer,token:k._getToken()});c.url=f+"/"+c.id+(h?"?"+h:"");c.objectId=b});k._resolve([e],"onQueryAttachmentInfosComplete",c,g)},error:function(a){k._resolve([a],null,e,g,!0)}});return g},addAttachment:function(a,b,c,d){return this._sendAttachment("add",
a,b,c,d)},updateAttachment:function(a,b,d,e,f){d.appendChild(c.create("input",{type:"hidden",name:"attachmentId",value:b}));return this._sendAttachment("update",a,d,e,f)},deleteAttachments:function(a,b,c,e){var f=this._url.path+"/"+a+"/deleteAttachments",g=new s(t._dfdCanceller),k=this;b={f:"json",attachmentIds:b.join(",")};g._pendingDfd=w({url:f,content:p.mixin(b,this._url.query),callbackParamName:"callback",load:p.hitch(this,function(b){b=b.deleteAttachmentResults;b=d.map(b,function(b){b=new E(b);
b.attachmentId=b.objectId;b.objectId=a;return b});k._resolve([b],"onDeleteAttachmentsComplete",c,g)}),error:function(a){k._resolve([a],null,e,g,!0)}},{usePost:!0});return g},addType:function(a){var b=this.types;if(b){if(d.some(b,function(b){return b.id==a.id?!0:!1}))return!1;b.push(a)}else this.types=[a];return this._typesDirty=!0},deleteType:function(a){if(this._collection){var b=this.types;if(b){var c=-1;d.some(b,function(b,d){return b.id==a?(c=d,!0):!1});if(-1<c)return this._typesDirty=!0,b.splice(c,
1)[0]}}},toJson:function(){var a=this._json;if(a=p.isString(a)?u.fromJson(a):p.clone(a)){var a=a.layerDefinition?a:{layerDefinition:a},b=a.layerDefinition,c=this._collection;if(c&&this._typesDirty){b.types=d.map(this.types||[],function(a){return a.toJson()});var e=this.renderer,f=this.labelingInfo,g=b.drawingInfo;if((e||f)&&!g)g=b.drawingInfo={};g&&(e&&-1===e.declaredClass.indexOf("TemporalRenderer"))&&(g.renderer=e.toJson());f&&(g.labelingInfo=d.map(f,function(a){return a.toJson()}))}e=null;if(!c||
this._fcAdded)e={geometryType:b.geometryType,features:this._convertFeaturesToJson(this.graphics,!0)};a.featureSet=p.mixin({},a.featureSet||{},e);a.featureSet.transform&&(f=a.featureSet.transform,delete a.featureSet.transform,e=new G(a.featureSet),e.quantize(f),a.featureSet=e.toJson());c&&(a.nextObjectId=this._nextId,b.capabilities=this.capabilities);return a}},onSelectionComplete:function(){},onSelectionClear:function(){},onBeforeApplyEdits:function(){},onEditsComplete:function(){},onQueryFeaturesComplete:function(){},
onQueryRelatedFeaturesComplete:function(){},onQueryIdsComplete:function(){},onQueryCountComplete:function(){},onQueryExtentComplete:function(){},onQueryAttachmentInfosComplete:function(){},onAddAttachmentComplete:function(){},onUpdateAttachmentComplete:function(){},onDeleteAttachmentsComplete:function(){},onCapabilitiesChange:function(){},onGDBVersionChange:function(){},onQueryLimitExceeded:function(){},onLabelingInfoChange:function(){},_forceIdentity:function(a){var b=this,c,d=this._url&&this._url.path;
c=d&&d.toLowerCase().indexOf("/rest/services");var e=this.editFieldsInfo,e=e&&(e.creatorField||e.editorField);(this.userIsAdmin||e)&&!this._getToken()&&-1<c&&h.id?(c=d.substring(0,c)+"/rest/info",w({url:c,content:{f:"json"},handleAs:"json",callbackParamName:"callback"}).then(function(a){if(a.owningSystemUrl)return h.id.checkSignInStatus(a.owningSystemUrl+"/sharing")}).then(function(a){if(a)return h.id.getCredential(d)}).then(function(a){a&&b._findCredential()}).always(function(){a.call(b)})):a.call(this)},
_checkMode:function(a){var b=this.geometryType,c=this.maxRecordCount;a=(a=a&&a.features&&a.features[0])&&a.attributes&&a.attributes.exceedslimit;if(this.mode===z.MODE_AUTO&&!this.isEditable()&&0===a&&(this.queryPagination||("esriGeometryPolyline"===b||"esriGeometryPolygon"===b||"esriGeometryMultipoint"===b||this.hasXYFootprint())&&c>=this.maxRecordCountForAuto||"esriGeometryPoint"===b&&c>=this.maxPointCountForAuto))this.currentMode=z.MODE_SNAPSHOT,this._mode=new K(this),this._isSnapshot=this._autoSnapshot=
!0},_queryLimit:function(){var a=this,b=new s;this._limitPromise=b.promise;setTimeout(function(){var c=new J,d=new T;d.statisticType="exceedslimit";d.maxPointCount=a.maxPointCountForAuto;d.maxRecordCount=a.maxRecordCountForAuto;d.maxVertexCount=a.maxVertexCountForAuto;d.outStatisticFieldName="exceedslimit";c.outStatistics=[d];a.queryFeatures(c).promise.then(function(a){b.resolve(a)},function(a){b.reject(a)})},0)},_updateCaps:function(){var a=this._editable,b=p.trim(this.capabilities||""),c=d.map(b?
b.split(","):[],p.trim),e=d.map(b?b.toLowerCase().split(","):[],p.trim),b=d.indexOf(e,"editing"),f,e={Create:d.indexOf(e,"create"),Update:d.indexOf(e,"update"),Delete:d.indexOf(e,"delete")};if(a&&-1===b)c.push("Editing");else if(!a&&-1<b){a=[b];for(f in e)-1<e[f]&&a.push(e[f]);a.sort();for(f=a.length-1;0<=f;f--)c.splice(a[f],1)}this.capabilities=c.join(",")},_counter:{value:0},_getUniqueId:function(){return this._counter.value++},onSuspend:function(){this.inherited(arguments);this._toggleTime(!1);
var a=this._mode;a&&a.suspend()},onResume:function(a){this.inherited(arguments);this._toggleTime(!0);var b=this._mode,c=this._map,d=this._getRenderer();if(a.firstOccurrence){this._fixRendererFields();this._checkFields();this.clearSelection();if(this.timeInfo&&!this._trackManager&&(this._trackIdField||d&&(d.latestObservationRenderer||d.trackRenderer)))this._trackManager=new fa(this),this._trackManager.initialize(c),this._childLayer=this._trackManager.container;d&&("colors"in d&&"blurRadius"in d&&"maxPixelIntensity"in
d)&&("esriGeometryPoint"==this.geometryType&&!this._heatmapManager)&&(this._heatmapManager=new M(this),this._heatmapManager.initialize(c));if(this._autoSnapshot&&this._autoGeneralize&&("esriGeometryPolyline"===this.geometryType||"esriGeometryPolygon"===this.geometryType||this.hasXYFootprint())&&!this.isEditable()&&null==this.getMaxAllowableOffset())d=this.generalizeForScale,this._calculatedScale=d=this.maxScale?this.maxScale:this.minScale?Math.min(d,this.minScale):Math.min(d,W.getScale(c,this.initialExtent)),
this._calcMaxOffset=c.extent.getWidth()/c.width/c.getScale()*d;this._zoomConnect=n.connect(c,"onZoomEnd",this,this._zoomEndHandler);this._updateMaxOffset();this._needsRefresh=!1;b&&b.startup()}else this._zoomEndHandler(),b&&b.resume()},_zoomEndHandler:function(){var a=this._map;this._updateMaxOffset();this._prevScale=a.getScale();!this.suspended&&this._needsRefresh&&this.refresh()},_updateMaxOffset:function(){var a=this._map;a&&a.loaded&&this._autoGeneralize&&(this._autoSnapshot?(a=this.getMaxAllowableOffset(),
this._setMaxOffset(this._getMaxOffsetForScale(),!0),this._needsRefresh||(this._needsRefresh=a!=this.getMaxAllowableOffset())):this._setMaxOffset(a.extent.getWidth()/a.width,!a.extent.spatialReference.isWebMercator()))},_getMaxOffsetForScale:function(){if(this._map){var a=this._map.getScale(),b=this._calculatedScale,c=this._calcMaxOffset,d=this._prevScale;return a>=b&&(null==d||d<b)?c:a<b&&(null==d||d>=b)?null:this.getMaxAllowableOffset()}},_toggleTime:function(a){var b=this._map;a&&this.timeInfo&&
this.useMapTime&&b?(this._mapTimeExtent=b.timeExtent,this._timeConnect||(this._timeConnect=n.connect(b,"onTimeExtentChange",this,this._timeChangeHandler))):(this._mapTimeExtent=null,n.disconnect(this._timeConnect),this._timeConnect=null)},_timeChangeHandler:function(a){this._mapTimeExtent=a;(a=this._mode)&&a.propertyChangeHandler(0)},_getOffsettedTE:function(a){var b=this._timeOffset,c=this._timeOffsetUnits;return a&&b&&c?a.offset(-1*b,c):a},_getTimeOverlap:function(a,b){return a&&b?a.intersection(b):
a||b},_getTimeFilter:function(a){var b=this.getTimeDefinition(),c;if(b&&(c=this._getTimeOverlap(b,null),!c))return[!1];if(a){if(a=c?this._getTimeOverlap(a,c):a,!a)return[!1]}else a=c;return[!0,a]},_getAttributeFilter:function(a){var b=this.getDefinitionExpression();return a?b?"("+b+") AND ("+a+")":a:b},_applyQueryFilters:function(a,b){a.where=this._getAttributeFilter(a.where);a.maxAllowableOffset||(a.maxAllowableOffset=this._maxOffset);a.quantizationParameters=this._quantizationParameters;b&&this.supportsAdvancedQueries&&
(a.orderByFields=a.orderByFields||this.getOrderByFields());if(this.timeInfo){var c=this._getTimeFilter(a.timeExtent);if(c[0])a.timeExtent=c[1];else return!1}return!0},_add:function(a){var b=this._selectionSymbol,c=a.attributes,d=this.visibilityField;b&&this._isSelOnly&&a.setSymbol(b);if(d&&c&&c.hasOwnProperty(d))a[c[d]?"show":"hide"]();return this.add.apply(this,arguments)},_remove:function(){return this.remove.apply(this,arguments)},_canDoClientSideQuery:function(a){var b=[],c=this._map,e;if(!(this._isTable||
!c&&!this._collection))if(!a.text&&!(a.where&&a.where!==this.getDefinitionExpression()||a.orderByFields&&a.orderByFields.length&&(e=this.getOrderByFields()||[])&&a.orderByFields.join()!==e.join()||a.outStatistics||a.returnDistinctValues)){e=this._isSnapshot;var f=this._isSelOnly,g=a.geometry;if(g)if(!f&&a.spatialRelationship===J.SPATIAL_REL_INTERSECTS&&"extent"===g.type&&(e||c.extent.contains(g)))b.push(1);else return;if(c=a.objectIds)if(e)b.push(2);else{var g=c.length,k=this._mode,h=0,l;for(l=0;l<
g;l++)k._getFeature(c[l])&&h++;if(h===g)b.push(2);else return}if(this.timeInfo)if(a=a.timeExtent,c=this._mapTimeExtent,e)a&&b.push(3);else if(f){if(a)return}else if(c)if(-1!==d.indexOf(b,2))a&&b.push(3);else if(-1!==d.indexOf(b,1))a==c&&b.push(3);else return;else if(0<b.length)a&&b.push(3);else if(a)return;return 0<b.length?b:null}},_getAbsMid:function(a){return f.toAbsMid?f.toAbsMid(a):l.id.replace(/\/[^\/]*$/ig,"/")+a},_doQuery:function(a,b,c){var e=[],f=this.objectIdField,g=this,k=new s,h=new s,
l=this.graphics;if(-1!==d.indexOf(b,1)){var m=this.spatialIndex||this._map&&this._map.spatialIndex,n,q=a.geometry._normalize(null,!0);null==m&&ha.autoSpatialIndexing?n=(this._map||this).addPlugin(this._getAbsMid("../plugins/spatialIndex")).then(p.hitch(this,p.partial(this._getFromIndex,q,m)),function(a){h.resolve(p.hitch(this,p.partial(this._filterByExtent,l,q)))}):m&&(n=this._getFromIndex(q,m));n?n.then(function(a){for(var b=0;b<a.length;b++)a[b].results&&(e=e.concat(a[b].results));h.resolve(e)}).otherwise(function(a){h.reject(a)}):
h.resolve(this._filterByExtent(l,q))}else h.resolve(l);h.then(function(h){e=h;if(-1!==d.indexOf(b,2)){var l=a.objectIds;e=d.filter(e,function(a){return-1<d.indexOf(l,a.attributes[f])})}-1!==d.indexOf(b,3)&&g.timeInfo&&(h=a.timeExtent,e=g._filterByTime(e,h.startTime,h.endTime).match);c&&(e=d.map(e,function(a){return a.attributes[f]},this));k.resolve(e)});return k},_getFromIndex:function(a,b){b=b||this.spatialIndex||this._map.spatialIndex;a instanceof Array||(a=[a]);var c=this.id;return r(d.map(a,function(a){return b.intersects(a,
c)}))},_filterByExtent:function(a,b){for(var c=[],d=0,e=a.length;d<e;d++){var f=a[d],g=f.geometry;g&&(this.normalization&&b.length?(b[0].intersects(g)||b[1].intersects(g))&&c.push(f):b.intersects(g)&&c.push(f))}return c},_filterByTime:function(a,b,c){var d=this._startTimeField,e=this._endTimeField,f;this._twoTimeFields||(f=d||e);var g=k.isDefined,h=[],l=[],p,m=a.length,n,q;b=b?b.getTime():-Infinity;c=c?c.getTime():Infinity;if(f)for(p=0;p<m;p++)n=a[p],q=n.attributes,d=q[f],d>=b&&d<=c?h.push(n):l.push(n);
else for(p=0;p<m;p++)n=a[p],q=n.attributes,f=q[d],q=q[e],f=g(f)?f:-Infinity,q=g(q)?q:Infinity,f>=b&&f<=c||q>=b&&q<=c||b>=f&&c<=q?h.push(n):l.push(n);return{match:h,noMatch:l}},_getSizeVariables:function(a){return a&&d.filter(a.getVisualVariablesForType("sizeInfo",!1),function(a){return!(!a.field&&!a.valueExpression)})},_needClientSideSorting:function(a){return this._collection?!(!a||!a.length):d.some(a,function(a){return!!a.valueExpression})},_sortFeatures:function(a){var b=this.renderer,c=this._getSizeVariables(b);
if(a&&1<a.length&&this._needClientSideSorting(c)){var d=c[0],e=this;a.sort(function(a,c){var f=b._getDataValue(a,d,"sizeInfo",null,e),g=b._getDataValue(c,d,"sizeInfo",null,e);return null==f?-1:null==g?1:g-f})}return a},_resolve:function(a,b,c,d,e){b&&this[b].apply(this,a);c&&c.apply(null,a);d&&t._resDfd(d,a,e)},_getShallowClone:function(a){var b=new J,c;for(c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b},_query:function(a,b,c,e,f){var g=this,k=this._map,h=new s(t._dfdCanceller),l=c,p,n;if("executeRelationshipQuery"!==
a){var l=this._getShallowClone(c),m=this.getOutFields();l.outFields||(l.outFields=m);l.outFields&&l.outFields.length&&(n=-1<d.indexOf(m,"*")?!1:!d.every(l.outFields,function(a){return-1<d.indexOf(m,a)}));l.returnGeometry=c.hasOwnProperty("returnGeometry")?c.returnGeometry:!c.outStatistics;l.returnGeometry&&(l.multipatchOption=this.multipatchOption);var r;k&&(c=k&&k.spatialReference,(k=l.outSpatialReference)?p=!k.equals(c):l.outSpatialReference=new I(c.toJson()));if(!this._applyQueryFilters(l,"execute"===
a&&!l.outStatistics)){switch(a){case "execute":r=new G({features:[]});break;case "executeForIds":r=[];break;case "executeForCount":r=0;break;case "executeForExtent":r={}}this._resolve([r],b,e,h);return h}if(c="executeForExtent"!==a&&!p&&!n&&this._canDoClientSideQuery(l))return h._pendingDfd=q(this._doQuery(l,c,"executeForIds"===a||"executeForCount"===a)),h._pendingDfd.then(function(c){switch(a){case "execute":r=new G;r.features=c;break;case "executeForIds":r=c;break;case "executeForCount":r=c.length}g._resolve([r],
b,e,h)}),h}if(this._collection)return this._resolve([Error("FeatureLayer::_query - "+this.invalidParams)],null,f,h,!0),h;this._ts&&(l._ts=(new Date).getTime());(h._pendingDfd=this._task[a](l)).addCallbacks(function(c){var d=!!l.outStatistics||p||n;if("execute"===a||"executeRelationshipQuery"===a){var f,k;if("execute"===a){f=c.features;k=f.length;for(k-=1;0<=k;k--)if(f[k]._layer=g,!d&&!g._isTable){var m=g._mode._getFeature(f[k].attributes[g.objectIdField]);m&&f.splice(k,1,m)}}else for(m in c)if(c.hasOwnProperty(m)){f=
c[m].features;k=f.length;for(k-=1;0<=k;k--)f[k]._layer=g}}g._resolve([c],b,e,h)},function(a){g._resolve([a],null,f,h,!0)});return h},_convertFeaturesToJson:function(a,b,c,e){var f=[],g=this._selectionSymbol,k=this.visibilityField,h,l=this.objectIdField;if(this.loaded&&(c||e))h=d.filter(this.fields,function(a){return!1===a.editable&&(!e||a.name!==l)});for(c=0;c<a.length;c++){var m=a[c],n={},q=m.geometry,r=m.attributes,t=m.symbol;if(q&&(!e||!this.loaded||this.allowGeometryUpdates))n.geometry=q.toJson();
k?(n.attributes=r=p.mixin({},r),r[k]=m.visible?1:0):r&&(n.attributes=p.mixin({},r));n.attributes&&(h&&h.length)&&d.forEach(h,function(a){delete n.attributes[a.name]});t&&t!==g&&(n.symbol=t.toJson());f.push(n)}return b?f:u.toJson(f)},_selectHandler:function(a,b,c,d,e){var f;d=z;switch(b){case d.SELECTION_NEW:this.clearSelection(!0);f=!0;break;case d.SELECTION_ADD:f=!0;break;case d.SELECTION_SUBTRACT:f=!1}d=a.features;var g=this._mode,k=[],h=this.objectIdField,l,p;if(f)for(f=0;f<d.length;f++)l=d[f],
p=l.attributes[h],l=g._addFeatureIIf(p,l),k.push(l),this._selectFeatureIIf(p,l,g);else for(f=0;f<d.length;f++)l=d[f],p=l.attributes[h],this._unSelectFeatureIIf(p,g),p=g._removeFeatureIIf(p),k.push(p||l);this._isSelOnly&&g._applyTimeFilter(!0);this._hasPartialSelectedFeatures=!!a.exceededTransferLimit;this._resolve([k,b,a.exceededTransferLimit?{queryLimitExceeded:!0}:null],"onSelectionComplete",c,e);if(a.exceededTransferLimit)this.onQueryLimitExceeded()},_selectFeatureIIf:function(a,b,c){var d=this._selectedFeatures,
e=d[a];e||(c._incRefCount(a),d[a]=b,this._isTable||(this._setSelectSymbol(b),b.attr("data-selected","")));return e||b},_unSelectFeatureIIf:function(a,b){var c=this._selectedFeatures[a];c&&(b._decRefCount(a),delete this._selectedFeatures[a],this._isTable||(this._setUnSelectSymbol(c),c.attr("data-selected")));return c},_isSelected:function(a){},_setSelectSymbol:function(a){var b=this._selectionSymbol;b&&!this._isSelOnly&&a.setSymbol(b)},_setUnSelectSymbol:function(a){var b=this._selectionSymbol;b&&
!this._isSelOnly&&b===a.symbol&&a.setSymbol(null,!0)},_getOutFields:function(){var a=[this.objectIdField,this.typeIdField,this.creatorField,this._startTimeField,this._endTimeField,this._trackIdField].concat(this._rendererFields).concat(this.dataAttributes),a=d.filter(a,function(a,b,c){return!!a&&d.indexOf(c,a)===b}),b=p.clone(this._outFields);if(b){if(-1!==d.indexOf(b,"*"))return b;d.forEach(a,function(a){-1===d.indexOf(b,a)&&b.push(a)});return b}return a},_checkFields:function(a){var b=a||this._getOutFields();
d.forEach(b,function(a){"*"!==a&&(this._getField(a)||console.debug("esri.layers.FeatureLayer: "+k.substitute({url:this.url,field:a},"unable to find '${field}' field in the layer 'fields' information [url: ${url}]")))},this);!a&&(!this._isTable&&!this._fserver&&!this._collection&&!this._isStream)&&(d.some(this.fields,function(a){return a&&"esriFieldTypeGeometry"===a.type?!0:!1})||console.debug("esri.layers.FeatureLayer: "+k.substitute({url:this.url},"unable to find a field of type 'esriFieldTypeGeometry' in the layer 'fields' information. If you are using a map service layer, features will not have geometry [url: ${url}]")))},
_fixFieldCase:function(a,b,c){var d=a&&a[b],e;if(d&&!p.isFunction(d)){if(e=!this._getField(d)&&this._getField(d,!0))d=a[b]=e.name;c&&c.push(d)}return d},_fixRendererFields:function(){var a=this.renderer;this._orderBy=null;if(a&&0<this.fields.length){var b=[],c,a=d.filter([a,a.observationRenderer,a.latestObservationRenderer,a.trackRenderer],k.isDefined),e=[].concat(a);d.forEach(a,function(a){d.forEach(a.rendererInfos,function(a){a.renderer&&e.push(a.renderer)})});d.forEach(e,function(a){this._fixFieldCase(a,
"attributeField",b);this._fixFieldCase(a,"attributeField2",b);this._fixFieldCase(a,"attributeField3",b);this._fixFieldCase(a.rotationInfo,"field",b);if((c=this._fixFieldCase(a.sizeInfo,"field",b))&&!this._orderBy)this._orderBy=[c+" DESC"];this._fixFieldCase(a.sizeInfo,"normalizationField",b);this._fixFieldCase(a.colorInfo,"field",b);this._fixFieldCase(a.colorInfo,"normalizationField",b);this._fixFieldCase(a.field,"field",b);this._fixFieldCase(a.opacityInfo,"field",b);this._fixFieldCase(a.opacityInfo,
"normalizationField",b);d.forEach(a.visualVariables,function(a){c=this._fixFieldCase(a,"field",b);"sizeInfo"===a.type&&(c&&!this._orderBy)&&(this._orderBy=[c+" DESC"]);this._fixFieldCase(a,"normalizationField",b)},this);if(!this._orderBy&&a.addBreak&&!p.isFunction(a.attributeField)&&(a.backgroundFillSymbol||this._hasSizeDiff(a)))this._orderBy=[a.attributeField+" DESC"]},this);this._rendererFields=d.filter(b,k.isDefined)}},_hasSizeDiff:function(a){var b=Number.MAX_VALUE,c=-Number.MAX_VALUE,e,f;d.forEach(a.infos,
function(a){if(f=a.symbol){e=0;switch(f.type){case "simplemarkersymbol":e=f.size;break;case "picturemarkersymbol":e=(f.width+f.height)/2;break;case "simplelinesymbol":case "cartographiclinesymbol":e=f.width;break;case "simplefillsymbol":case "picturefillsymbol":e=f.outline&&f.outline.width}e&&(b=Math.min(b,e),c=Math.max(c,e))}});return b!==Number.MAX_VALUE&&c!==-Number.MAX_VALUE&&1<Math.abs(c-b)},getOrderByFields:function(){var a=this.orderByFields||this._orderBy;return this.supportsAdvancedQueries&&
a?d.filter(a,function(a){a=a.split(" ")[0];return!!this._getField(a,!0)},this):null},_getField:function(a,b){var c=this.fields;if(!c||0===c.length)return null;var e;b&&(a=a.toLowerCase());d.some(c,function(c){var d=!1;(d=b?c&&c.name.toLowerCase()===a?!0:!1:c&&c.name===a?!0:!1)&&(e=c);return d});return e},_getDateOpts:function(){this._dtOpts||(this._dtOpts={properties:d.map(d.filter(this.fields,function(a){return!!(a&&"esriFieldTypeDate"===a.type)}),function(a){return a.name})});return this._dtOpts},
_applyNormalized:function(a,b){a&&b&&d.forEach(a,function(a,c){a&&b[c]&&a.setGeometry(b[c])})},_editHandler:function(a,b,c,e,f,g){f=a.addResults;var k=a.updateResults;a=a.deleteResults;var h,l,m,n,q=this.objectIdField,r=this._mode,t=this._isTable;h=this.editFieldsInfo;var s=this.getOutFields()||[],u=h&&h.creatorField,w=h&&h.creationDateField,x=h&&h.editorField,y=h&&h.editDateField;h=h&&h.realm;-1===d.indexOf(s,"*")&&(u&&-1===d.indexOf(s,u)&&(u=null),w&&-1===d.indexOf(s,w)&&(w=null),x&&-1===d.indexOf(s,
x)&&(x=null),y&&-1===d.indexOf(s,y)&&(y=null));var s=w||y?(new Date).getTime():null,C=u||x?this.getUserId():void 0;C&&h&&(C=C+"@"+h);if(f)for(h=0;h<f.length;h++)f[h]=new E(f[h]),t||(l=f[h],l.success&&(l=l.objectId,m=b[h],(n=m._graphicsLayer)&&n!==this&&n.remove(m),n=m.attributes||{},n[q]=l,u&&(n[u]=C),x&&(n[x]=C),w&&(n[w]=s),y&&(n[y]=s),m.setAttributes(n),r._init&&r.drawFeature(m)));if(k)for(h=0;h<k.length;h++)if(k[h]=new E(k[h]),!t&&(l=k[h],l.success)){l=l.objectId;m=c[l];if(b=r._getFeature(l))b.geometry!==
m.geometry&&m.geometry&&b.setGeometry(U.fromJson(m.geometry.toJson())),b.attributes!==m.attributes&&m.attributes&&b.setAttributes(p.mixin(b.attributes,m.attributes)),this._repaint(b,l);m=b||m;n=m.attributes||{};x&&(n[x]=C);y&&(n[y]=s);m.setAttributes(n)}if(a){c=[];for(h=0;h<a.length;h++)if(a[h]=new E(a[h]),!t&&(l=a[h],l.success&&(l=l.objectId,m=r._getFeature(l))))this._unSelectFeatureIIf(l,r)&&c.push(m),m._count=0,r._removeFeatureIIf(l);if(0<c.length)this.onSelectionComplete(c,z.SELECTION_SUBTRACT)}this._resolve([f,
k,a],"onEditsComplete",e,g)},_sendAttachment:function(a,b,c,d,e){var f=this;return w({url:this._url.path+"/"+b+"/"+("add"===a?"addAttachment":"updateAttachment"),form:c,content:p.mixin(this._url.query,{f:"json",token:this._getToken()||void 0}),callbackParamName:"callback.html",handleAs:"json"}).addCallback(function(c){var e="add"===a?"onAddAttachmentComplete":"onUpdateAttachmentComplete";c=new E(c["add"===a?"addAttachmentResult":"updateAttachmentResult"]);c.attachmentId=c.objectId;c.objectId=b;f._resolve([c],
e,d);return c}).addErrback(function(a){f._resolve([a],null,e,null,!0)})},_repaint:function(a,b,c){b=k.isDefined(b)?b:a.attributes[this.objectIdField];(!(b in this._selectedFeatures)||!this._selectionSymbol)&&a.setSymbol(a.symbol,c)},_getKind:function(a){var b=this._trackManager;return b?b.isLatestObservation(a)?1:0:0}});p.mixin(z,{MODE_SNAPSHOT:0,MODE_ONDEMAND:1,MODE_SELECTION:2,SELECTION_NEW:3,SELECTION_ADD:4,SELECTION_SUBTRACT:5,MODE_AUTO:6,MODE_STREAM:7,POPUP_NONE:"esriServerHTMLPopupTypeNone",
POPUP_HTML_TEXT:"esriServerHTMLPopupTypeAsHTMLText",POPUP_URL:"esriServerHTMLPopupTypeAsURL"});V._createWrappers(z);e("extend-esri")&&p.setObject("layers.FeatureLayer",z,h);return z});